%%{init: {
  'theme': 'base',
  'themeVariables': {
    'primaryColor': '#5448C8',
    'primaryTextColor': '#fff',
    'primaryBorderColor': '#3f33a6',
    'lineColor': '#64748b',
    'secondaryColor': '#00BCD4',
    'tertiaryColor': '#81c784'
  }
}}%%

graph TB
    subgraph "API Gateway Comprehensive Architecture"
        subgraph "Client Layer"
            WEB[Web Apps ğŸŒ]
            MOB[Mobile Apps ğŸ“±]
            IOT[IoT Devices ğŸ“¡]
            PART[Partner APIs ğŸ¤]
        end
        
        subgraph "Edge Layer"
            CDN[CDN/PoPs ğŸŒ<br/>Global Distribution]
            WAF[WAF ğŸ›¡ï¸<br/>DDoS Protection]
        end
        
        subgraph "Gateway Core"
            subgraph "Ingress"
                LB[Load Balancer<br/>ğŸ”„ Round-robin/Least-conn]
                TLS[TLS Termination<br/>ğŸ”’ SSL/TLS 1.3]
            end
            
            subgraph "Security"
                AUTH[Authentication<br/>ğŸ” JWT/OAuth2/API Keys]
                AUTHZ[Authorization<br/>ğŸ‘® RBAC/ABAC/Policies]
                THREAT[Threat Detection<br/>ğŸš¨ Anomaly Detection]
            end
            
            subgraph "Traffic Control"
                RL[Rate Limiting<br/>â±ï¸ Token Bucket<br/>1000 req/min]
                QOS[QoS/Priority<br/>ğŸ“Š Traffic Shaping]
                QUOTA[Quota Management<br/>ğŸ“ˆ Usage Tracking]
            end
            
            subgraph "Routing & Transform"
                ROUTE[Smart Router<br/>ğŸ§­ Path/Header/Content]
                TRANS[Protocol Translation<br/>ğŸ”„ RESTâ†”gRPCâ†”GraphQL]
                AGG[Response Aggregation<br/>ğŸ”— Parallel Fetching]
                ADAPT[Request/Response<br/>ğŸ­ Transformation]
            end
            
            subgraph "Resilience"
                CB[Circuit Breaker<br/>ğŸ”Œ Per-service]
                RETRY[Retry Logic<br/>ğŸ” Exponential Backoff]
                TIMEOUT[Timeout Handler<br/>â° Cascading Timeouts]
                FALLBACK[Fallback Logic<br/>ğŸª‚ Graceful Degradation]
            end
            
            subgraph "Performance"
                CACHE[Response Cache<br/>ğŸ’¾ Redis/Memcached]
                COMP[Compression<br/>ğŸ—œï¸ gzip/brotli]
                BATCH[Request Batching<br/>ğŸ“¦ Reduce Round-trips]
            end
            
            subgraph "Observability"
                TRACE[Distributed Tracing<br/>ğŸ” OpenTelemetry]
                METRIC[Metrics Collection<br/>ğŸ“Š Prometheus]
                LOG[Structured Logging<br/>ğŸ“ ELK Stack]
                ALERT[Alerting<br/>ğŸš¨ PagerDuty/Slack]
            end
        end
        
        subgraph "Backend Integration"
            SD[Service Discovery<br/>ğŸ” Consul/etcd/K8s]
            POOL[Connection Pooling<br/>ğŸŠ Persistent Connections]
            HEALTH[Health Checks<br/>ğŸ’š Active/Passive]
        end
        
        subgraph "Microservices"
            MS1[User Service]
            MS2[Order Service]
            MS3[Payment Service]
            MS4[Inventory Service]
            MSN[... N Services]
        end
        
        %% Connections
        WEB --> CDN
        MOB --> CDN
        IOT --> CDN
        PART --> CDN
        
        CDN --> WAF
        WAF --> LB
        LB --> TLS
        TLS --> AUTH
        AUTH --> AUTHZ
        AUTHZ --> THREAT
        THREAT --> RL
        RL --> QOS
        QOS --> QUOTA
        QUOTA --> ROUTE
        ROUTE --> TRANS
        TRANS --> AGG
        AGG --> ADAPT
        ADAPT --> CB
        CB --> RETRY
        RETRY --> TIMEOUT
        TIMEOUT --> FALLBACK
        FALLBACK --> CACHE
        CACHE --> COMP
        COMP --> BATCH
        BATCH --> SD
        SD --> POOL
        POOL --> HEALTH
        HEALTH --> MS1
        HEALTH --> MS2
        HEALTH --> MS3
        HEALTH --> MS4
        HEALTH --> MSN
        
        %% Observability connections (dotted)
        ROUTE -.-> TRACE
        CB -.-> METRIC
        AUTH -.-> LOG
        RL -.-> ALERT
    end
    
    style AUTH fill:#ff6b6b,stroke:#c92a2a
    style RL fill:#4ecdc4,stroke:#38d9a9
    style CACHE fill:#95e1d3,stroke:#63e6be
    style CB fill:#f3a683,stroke:#ee5a24
    style ROUTE fill:#00BCD4,stroke:#0097a7,stroke-width:3px