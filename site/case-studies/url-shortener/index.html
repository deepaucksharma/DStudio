
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Design a scalable service to shorten URLs with analytics, custom aliases, and abuse prevention">
      
      
      
        <link rel="canonical" href="https://deepaucksharma.github.io/DStudio/case-studies/url-shortener/">
      
      
        <link rel="prev" href="../unique-id-generator/">
      
      
        <link rel="next" href="../distributed-message-queue-enhanced/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.15">
    
    
      
        <title>URL Shortener Service - The Compendium of Distributed Systems</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Inter";--md-code-font:"JetBrains Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
      <link rel="stylesheet" href="../../stylesheets/modular.css">
    
      <link rel="stylesheet" href="../../stylesheets/axioms.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#url-shortener-service" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="The Compendium of Distributed Systems" class="md-header__button md-logo" aria-label="The Compendium of Distributed Systems" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            The Compendium of Distributed Systems
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              URL Shortener Service
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="cyan"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="cyan"  aria-label="Switch to auto"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to auto" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/deepaucksharma/DStudio" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    deepaucksharma/DStudio
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../introduction/" class="md-tabs__link">
          
  
  
    
  
  Introduction

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../part1-axioms/" class="md-tabs__link">
          
  
  
    
  
  Part I: Axioms

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../part2-pillars/" class="md-tabs__link">
          
  
  
    
  
  Part II: Pillars

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../patterns/" class="md-tabs__link">
          
  
  
    
  
  Part III: Patterns

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../quantitative/" class="md-tabs__link">
          
  
  
    
  
  Part IV: Quantitative Toolkit

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../human-factors/" class="md-tabs__link">
          
  
  
    
  
  Part V: Human Factors

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../tools/" class="md-tabs__link">
          
  
  
    
  
  Tools

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../capstone/framework/" class="md-tabs__link">
          
  
  
    
  
  Capstone

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
  
    
  
  Case Studies

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../reference/" class="md-tabs__link">
          
  
  
    
  
  Reference

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../LEARNING_PATHS/" class="md-tabs__link">
          
  
  
    
  
  Documentation

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="The Compendium of Distributed Systems" class="md-nav__button md-logo" aria-label="The Compendium of Distributed Systems" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    The Compendium of Distributed Systems
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/deepaucksharma/DStudio" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    deepaucksharma/DStudio
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../introduction/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Introduction
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../introduction/philosophy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Philosophy
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../part1-axioms/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Part I: Axioms
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Part I: Axioms
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../part1-axioms/axiom1-latency/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Axiom 1: Latency
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            Axiom 1: Latency
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part1-axioms/axiom1-latency/index-enhanced/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Enhanced
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part1-axioms/axiom1-latency/examples/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  
    
  
  
    <span class="md-status md-status--stub"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part1-axioms/axiom1-latency/exercises/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Exercises
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../part1-axioms/axiom2-capacity/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Axiom 2: Capacity
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            Axiom 2: Capacity
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part1-axioms/axiom2-capacity/examples/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part1-axioms/axiom2-capacity/exercises/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Exercises
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../part1-axioms/axiom3-failure/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Axiom 3: Failure
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            Axiom 3: Failure
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part1-axioms/axiom3-failure/examples/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part1-axioms/axiom3-failure/exercises/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Exercises
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_5" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../part1-axioms/axiom4-concurrency/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Axiom 4: Concurrency
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5">
            <span class="md-nav__icon md-icon"></span>
            Axiom 4: Concurrency
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part1-axioms/axiom4-concurrency/examples/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part1-axioms/axiom4-concurrency/exercises/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Exercises
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_6" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../part1-axioms/axiom5-coordination/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Axiom 5: Coordination
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_6" id="__nav_3_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_6">
            <span class="md-nav__icon md-icon"></span>
            Axiom 5: Coordination
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part1-axioms/axiom5-coordination/examples/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part1-axioms/axiom5-coordination/exercises/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Exercises
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_7" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../part1-axioms/axiom6-observability/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Axiom 6: Observability
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_7" id="__nav_3_7_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_7">
            <span class="md-nav__icon md-icon"></span>
            Axiom 6: Observability
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part1-axioms/axiom6-observability/examples/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  
    
  
  
    <span class="md-status md-status--stub"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part1-axioms/axiom6-observability/exercises/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Exercises
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_8" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../part1-axioms/axiom7-human/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Axiom 7: Human Interface
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_8" id="__nav_3_8_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_8">
            <span class="md-nav__icon md-icon"></span>
            Axiom 7: Human Interface
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part1-axioms/axiom7-human/examples/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  
    
  
  
    <span class="md-status md-status--stub"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part1-axioms/axiom7-human/exercises/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Exercises
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_9" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../part1-axioms/axiom8-economics/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Axiom 8: Economics
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_9" id="__nav_3_9_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_9">
            <span class="md-nav__icon md-icon"></span>
            Axiom 8: Economics
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part1-axioms/axiom8-economics/examples/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  
    
  
  
    <span class="md-status md-status--stub"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part1-axioms/axiom8-economics/exercises/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Exercises
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_10" >
        
          
          <label class="md-nav__link" for="__nav_3_10" id="__nav_3_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Synthesis
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_10">
            <span class="md-nav__icon md-icon"></span>
            Synthesis
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part1-axioms/synthesis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Summary
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part1-axioms/quiz/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quiz
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../part2-pillars/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Part II: Pillars
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4" id="__nav_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Part II: Pillars
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../part2-pillars/work/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Pillar 1: Work
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            Pillar 1: Work
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2-pillars/work/examples/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2-pillars/work/exercises/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Exercises
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../part2-pillars/state/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Pillar 2: State
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            Pillar 2: State
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2-pillars/state/examples/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2-pillars/state/exercises/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Exercises
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../part2-pillars/truth/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Pillar 3: Truth
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_4" id="__nav_4_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_4">
            <span class="md-nav__icon md-icon"></span>
            Pillar 3: Truth
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2-pillars/truth/examples/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2-pillars/truth/exercises/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Exercises
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_5" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../part2-pillars/control/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Pillar 4: Control
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_5" id="__nav_4_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_5">
            <span class="md-nav__icon md-icon"></span>
            Pillar 4: Control
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2-pillars/control/examples/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2-pillars/control/exercises/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Exercises
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_6" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../part2-pillars/intelligence/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Pillar 5: Intelligence
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_6" id="__nav_4_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_6">
            <span class="md-nav__icon md-icon"></span>
            Pillar 5: Intelligence
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2-pillars/intelligence/examples/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2-pillars/intelligence/exercises/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Exercises
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_7" >
        
          
          <label class="md-nav__link" for="__nav_4_7" id="__nav_4_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Analysis Tools
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_7">
            <span class="md-nav__icon md-icon"></span>
            Analysis Tools
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2-pillars/models-comparison/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CAST vs SPACE Models
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2-pillars/models-collide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    When Models Collide
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2-pillars/pattern-matrix/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pattern Matrix
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2-pillars/tradeoff-calculus/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Trade-off Calculus
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2-pillars/decision-tree/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Decision Tree
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_8" >
        
          
          <label class="md-nav__link" for="__nav_4_8" id="__nav_4_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Exercises & Reflection
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_8">
            <span class="md-nav__icon md-icon"></span>
            Exercises & Reflection
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2-pillars/pillar-checkpoint/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pillar Checkpoint
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2-pillars/failure-recap/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Failure Recap
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2-pillars/reflection-journal/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Reflection Journal
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_9" >
        
          
          <label class="md-nav__link" for="__nav_4_9" id="__nav_4_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Pattern Preview
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_9">
            <span class="md-nav__icon md-icon"></span>
            Pattern Preview
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2-pillars/pattern-catalog-intro/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pattern Catalog Intro
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2-pillars/pattern-legend/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pattern Legend
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2-pillars/pillars-patterns-map/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pillars ↔ Patterns Map
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2-pillars/transition-part3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Transition to Part III
    
  </span>
  
    
  
  
    <span class="md-status md-status--stub"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../patterns/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Part III: Patterns
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5" id="__nav_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Part III: Patterns
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_2" >
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Core Patterns
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            Core Patterns
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/queues-streaming/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Queues & Streaming
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/cqrs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CQRS
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/event-driven/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Event-Driven Architecture
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/event-sourcing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Event Sourcing
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/saga/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Saga Pattern
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/service-mesh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Service Mesh
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/graphql-federation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    GraphQL Federation
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/serverless-faas/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Serverless/FaaS
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_3" >
        
          
          <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Resilience Patterns
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3">
            <span class="md-nav__icon md-icon"></span>
            Resilience Patterns
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/circuit-breaker/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Circuit Breaker
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/circuit-breaker-enhanced/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Circuit Breaker Enhanced
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/retry-backoff/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Retry & Backoff
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/bulkhead/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Bulkhead
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/backpressure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Backpressure
    
  </span>
  
    
  
  
    <span class="md-status md-status--draft"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/edge-computing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Edge Computing
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/graceful-degradation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Graceful Degradation
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/health-check/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Health Check
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/timeout/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Timeout
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_4" >
        
          
          <label class="md-nav__link" for="__nav_5_4" id="__nav_5_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Data Patterns
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4">
            <span class="md-nav__icon md-icon"></span>
            Data Patterns
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/cdc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CDC (Change Data Capture)
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/tunable-consistency/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tunable Consistency
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/sharding/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Sharding
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/caching-strategies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Caching Strategies
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/geo-replication/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Geo-Replication
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/multi-region/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Multi-Region
    
  </span>
  
    
  
  
    <span class="md-status md-status--draft"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/two-phase-commit/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Two-Phase Commit
    
  </span>
  
    
  
  
    <span class="md-status md-status--draft"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_5" >
        
          
          <label class="md-nav__link" for="__nav_5_5" id="__nav_5_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Coordination Patterns
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_5">
            <span class="md-nav__icon md-icon"></span>
            Coordination Patterns
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/leader-election/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Leader Election
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/consensus/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Consensus
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/distributed-lock/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Distributed Lock
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/idempotent-receiver/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Idempotent Receiver
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/outbox/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Outbox
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_6" >
        
          
          <label class="md-nav__link" for="__nav_5_6" id="__nav_5_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Operational Patterns
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6">
            <span class="md-nav__icon md-icon"></span>
            Operational Patterns
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/api-gateway/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    API Gateway
    
  </span>
  
    
  
  
    <span class="md-status md-status--draft"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/auto-scaling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Auto Scaling
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/load-balancing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Load Balancing
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/load-shedding/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Load Shedding
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/rate-limiting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Rate Limiting
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/service-discovery/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Service Discovery
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/observability/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Observability
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/finops/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FinOps
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_7" >
        
          
          <label class="md-nav__link" for="__nav_5_7" id="__nav_5_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Pattern Analysis Tools
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_7">
            <span class="md-nav__icon md-icon"></span>
            Pattern Analysis Tools
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/pattern-comparison/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pattern Comparison
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/pattern-selector/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pattern Selector
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/pattern-combinations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pattern Combinations
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../patterns/pattern-quiz/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pattern Quiz
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../quantitative/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Part IV: Quantitative Toolkit
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6" id="__nav_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Part IV: Quantitative Toolkit
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6_2" >
        
          
          <label class="md-nav__link" for="__nav_6_2" id="__nav_6_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Latency & Performance
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2">
            <span class="md-nav__icon md-icon"></span>
            Latency & Performance
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quantitative/latency-ladder/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Latency Ladder
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quantitative/littles-law/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Little's Law
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quantitative/queueing-models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Queueing Theory
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6_3" >
        
          
          <label class="md-nav__link" for="__nav_6_3" id="__nav_6_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Scaling Laws
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_3">
            <span class="md-nav__icon md-icon"></span>
            Scaling Laws
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quantitative/amdahl-gustafson/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Amdahl & Gustafson Laws
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quantitative/universal-scalability/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Universal Scalability Law
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6_4" >
        
          
          <label class="md-nav__link" for="__nav_6_4" id="__nav_6_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Economics & Planning
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_4">
            <span class="md-nav__icon md-icon"></span>
            Economics & Planning
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quantitative/coordination-costs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Coordination Costs
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quantitative/cache-economics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Cache Economics
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quantitative/availability-math/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Availability Math
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quantitative/capacity-planning/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Capacity Planning
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quantitative/problem-set/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Problem Set
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../human-factors/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Part V: Human Factors
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7" id="__nav_7_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Part V: Human Factors
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_2" >
        
          
          <label class="md-nav__link" for="__nav_7_2" id="__nav_7_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Production Excellence
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_2">
            <span class="md-nav__icon md-icon"></span>
            Production Excellence
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../human-factors/consistency-tuning/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Consistency Tuning
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../human-factors/chaos-engineering/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Chaos Engineering
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../human-factors/observability-stacks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Observability Stacks
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_3" >
        
          
          <label class="md-nav__link" for="__nav_7_3" id="__nav_7_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Operational Practices
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_3">
            <span class="md-nav__icon md-icon"></span>
            Operational Practices
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../human-factors/sre-practices/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SRE Practices
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../human-factors/org-structure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Org-Structure Physics
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../human-factors/runbooks-playbooks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Runbooks & Playbooks
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_4" >
        
          
          <label class="md-nav__link" for="__nav_7_4" id="__nav_7_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Team Organization
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_4">
            <span class="md-nav__icon md-icon"></span>
            Team Organization
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../human-factors/team-topologies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Team Topologies
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../human-factors/knowledge-management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Knowledge Management
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../human-factors/oncall-culture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    On-Call Culture
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_5" >
        
          
          <label class="md-nav__link" for="__nav_7_5" id="__nav_7_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Incident Management
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_5">
            <span class="md-nav__icon md-icon"></span>
            Incident Management
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../human-factors/incident-response/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Incident Response
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../human-factors/blameless-postmortems/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Blameless Postmortems
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../tools/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Tools
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Tools
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Capstone
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            Capstone
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../capstone/framework/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Project Framework
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../capstone/evaluation-rubric/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Evaluation Rubric
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Case Studies
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

            </a>
            
              
              <label class="md-nav__link " for="__nav_10" id="__nav_10_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            Case Studies
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_10_2" >
        
          
          <label class="md-nav__link" for="__nav_10_2" id="__nav_10_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Core Systems
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_2">
            <span class="md-nav__icon md-icon"></span>
            Core Systems
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../amazon-dynamo/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Amazon DynamoDB
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../paypal-payments/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PayPal Payments
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../spotify-recommendations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Spotify Recommendations
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../uber-location/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Uber Location Services
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../youtube/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    YouTube
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../google-drive/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Google Drive
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../google-maps/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Google Maps
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_10_3" >
        
          
          <label class="md-nav__link" for="__nav_10_3" id="__nav_10_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Communication Systems
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_3">
            <span class="md-nav__icon md-icon"></span>
            Communication Systems
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chat-system/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Chat System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chat-system-enhanced/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Chat System Enhanced
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../distributed-message-queue/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Distributed Message Queue
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../notification-system/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Notification System
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../news-feed/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    News Feed
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_10_4" >
        
          
          <label class="md-nav__link" for="__nav_10_4" id="__nav_10_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Search & Discovery
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_4">
            <span class="md-nav__icon md-icon"></span>
            Search & Discovery
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../search-autocomplete/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Search Autocomplete
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../search-autocomplete-enhanced/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Search Autocomplete Enhanced
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../web-crawler/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Web Crawler
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_10_5" >
        
          
          <label class="md-nav__link" for="__nav_10_5" id="__nav_10_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Location & Proximity
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_5">
            <span class="md-nav__icon md-icon"></span>
            Location & Proximity
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../uber-location-enhanced/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Uber Location Enhanced
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../google-maps-enhanced/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Google Maps Enhanced
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../nearby-friends/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Nearby Friends
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../nearby-friends-enhanced/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Nearby Friends Enhanced
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../proximity-service/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Proximity Service
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../proximity-service-enhanced/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Proximity Service Enhanced
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_10_6" >
        
          
          <label class="md-nav__link" for="__nav_10_6" id="__nav_10_6_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Storage & Data
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_6">
            <span class="md-nav__icon md-icon"></span>
            Storage & Data
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../key-value-store/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Key-Value Store
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../object-storage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Object Storage
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../s3-object-storage-enhanced/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    S3 Object Storage Enhanced
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../google-drive-enhanced/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Google Drive Enhanced
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../consistent-hashing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Consistent Hashing
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_10_7" >
        
          
          <label class="md-nav__link" for="__nav_10_7" id="__nav_10_7_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Financial Systems
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_7">
            <span class="md-nav__icon md-icon"></span>
            Financial Systems
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../payment-system/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Payment System
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../payment-system-enhanced/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Payment System Enhanced
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../digital-wallet-enhanced/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Digital Wallet Enhanced
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hotel-reservation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Hotel Reservation
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hotel-reservation-enhanced/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Hotel Reservation Enhanced
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../stock-exchange/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Stock Exchange
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../stock-exchange-enhanced/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Stock Exchange Enhanced
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_10_8" >
        
          
          <label class="md-nav__link" for="__nav_10_8" id="__nav_10_8_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Observability & Monitoring
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_8">
            <span class="md-nav__icon md-icon"></span>
            Observability & Monitoring
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../metrics-monitoring/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Metrics & Monitoring
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../prometheus-datadog-enhanced/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Prometheus & Datadog Enhanced
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../rate-limiter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Rate Limiter
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_9" checked>
        
          
          <label class="md-nav__link" for="__nav_10_9" id="__nav_10_9_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Infrastructure
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_9_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_10_9">
            <span class="md-nav__icon md-icon"></span>
            Infrastructure
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ad-click-aggregation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Ad Click Aggregation
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../unique-id-generator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Unique ID Generator
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    URL Shortener
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    URL Shortener
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#challenge-statement" class="md-nav__link">
    <span class="md-ellipsis">
      🎯 Challenge Statement
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#part-1-concept-map" class="md-nav__link">
    <span class="md-ellipsis">
      Part 1: Concept Map
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Part 1: Concept Map">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#system-overview" class="md-nav__link">
    <span class="md-ellipsis">
      🗺️ System Overview
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#axiom-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      📐 Axiom Analysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="📐 Axiom Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#axiom-1-latency-redirect-performance" class="md-nav__link">
    <span class="md-ellipsis">
      🚀 Axiom 1 (Latency): Redirect Performance
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#axiom-2-capacity-storage-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      💾 Axiom 2 (Capacity): Storage Optimization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#axiom-3-failure-resilience-and-recovery" class="md-nav__link">
    <span class="md-ellipsis">
      🔥 Axiom 3 (Failure): Resilience and Recovery
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#axiom-4-concurrency-parallel-processing" class="md-nav__link">
    <span class="md-ellipsis">
      🔀 Axiom 4 (Concurrency): Parallel Processing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#axiom-5-coordination-distributed-consensus" class="md-nav__link">
    <span class="md-ellipsis">
      🤝 Axiom 5 (Coordination): Distributed Consensus
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#axiom-6-observability-analytics-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      👁️ Axiom 6 (Observability): Analytics Pipeline
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#axiom-7-human-interface-management-tools" class="md-nav__link">
    <span class="md-ellipsis">
      👤 Axiom 7 (Human Interface): Management Tools
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#axiom-8-economics-cost-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      💰 Axiom 8 (Economics): Cost Optimization
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#comprehensive-axiom-mapping" class="md-nav__link">
    <span class="md-ellipsis">
      🔍 Comprehensive Axiom Mapping
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pillar-mapping" class="md-nav__link">
    <span class="md-ellipsis">
      🏛️ Pillar Mapping
    </span>
  </a>
  
    <nav class="md-nav" aria-label="🏛️ Pillar Mapping">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#work-distribution" class="md-nav__link">
    <span class="md-ellipsis">
      Work Distribution
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#state-management" class="md-nav__link">
    <span class="md-ellipsis">
      State Management
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#truth-consistency" class="md-nav__link">
    <span class="md-ellipsis">
      Truth &amp; Consistency
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#control-mechanisms" class="md-nav__link">
    <span class="md-ellipsis">
      Control Mechanisms
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#intelligence-layer" class="md-nav__link">
    <span class="md-ellipsis">
      Intelligence Layer
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pattern-application" class="md-nav__link">
    <span class="md-ellipsis">
      🔧 Pattern Application
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#architecture-alternatives" class="md-nav__link">
    <span class="md-ellipsis">
      🏗️ Architecture Alternatives
    </span>
  </a>
  
    <nav class="md-nav" aria-label="🏗️ Architecture Alternatives">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#alternative-1-nosql-based-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Alternative 1: NoSQL-Based Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alternative-2-kubernetes-microservices" class="md-nav__link">
    <span class="md-ellipsis">
      Alternative 2: Kubernetes Microservices
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alternative-3-edge-first-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Alternative 3: Edge-First Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alternative-4-blockchain-based" class="md-nav__link">
    <span class="md-ellipsis">
      Alternative 4: Blockchain-Based
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alternative-5-hybrid-multi-cloud" class="md-nav__link">
    <span class="md-ellipsis">
      Alternative 5: Hybrid Multi-Cloud
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trade-off-analysis-matrix" class="md-nav__link">
    <span class="md-ellipsis">
      ⚖️ Trade-off Analysis Matrix
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performance-comparison" class="md-nav__link">
    <span class="md-ellipsis">
      📊 Performance Comparison
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#part-2-architecture-trade-offs" class="md-nav__link">
    <span class="md-ellipsis">
      Part 2: Architecture &amp; Trade-offs
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Part 2: Architecture &amp; Trade-offs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#core-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      🏗️ Core Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-design-trade-offs" class="md-nav__link">
    <span class="md-ellipsis">
      ⚖️ Key Design Trade-offs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alternative-architectures" class="md-nav__link">
    <span class="md-ellipsis">
      🔄 Alternative Architectures
    </span>
  </a>
  
    <nav class="md-nav" aria-label="🔄 Alternative Architectures">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#option-1-simple-monolithic" class="md-nav__link">
    <span class="md-ellipsis">
      Option 1: Simple Monolithic
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#option-2-microservices" class="md-nav__link">
    <span class="md-ellipsis">
      Option 2: Microservices
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#option-3-serverless" class="md-nav__link">
    <span class="md-ellipsis">
      Option 3: Serverless
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#option-4-edge-computing" class="md-nav__link">
    <span class="md-ellipsis">
      Option 4: Edge Computing
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performance-characteristics" class="md-nav__link">
    <span class="md-ellipsis">
      📊 Performance Characteristics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-lessons" class="md-nav__link">
    <span class="md-ellipsis">
      🎓 Key Lessons
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#related-concepts-deep-dives" class="md-nav__link">
    <span class="md-ellipsis">
      🔗 Related Concepts &amp; Deep Dives
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      📚 References
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../distributed-message-queue-enhanced/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Distributed Message Queue Enhanced
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_10_10" >
        
          
          <label class="md-nav__link" for="__nav_10_10" id="__nav_10_10_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Gaming & Entertainment
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_10">
            <span class="md-nav__icon md-icon"></span>
            Gaming & Entertainment
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../gaming-leaderboard-enhanced/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Gaming Leaderboard Enhanced
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../youtube-enhanced/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    YouTube Enhanced
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_10_11" >
        
          
          <label class="md-nav__link" for="__nav_10_11" id="__nav_10_11_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Deep Dives
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_11">
            <span class="md-nav__icon md-icon"></span>
            Deep Dives
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../consistency-deep-dive-chat/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Consistency Deep Dive Chat
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../distributed-email-enhanced/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Distributed Email Enhanced
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_11" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../reference/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  
    
  
  
    <span class="md-status md-status--stub"></span>
  

  

            </a>
            
              
              <label class="md-nav__link " for="__nav_11" id="__nav_11_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/glossary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Glossary
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cheat-sheets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Cheat Sheets
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/recipe-cards/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Recipe Cards
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/security/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Security
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_12" >
        
          
          <label class="md-nav__link" for="__nav_12" id="__nav_12_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Documentation
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_12">
            <span class="md-nav__icon md-icon"></span>
            Documentation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../LEARNING_PATHS/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Learning Paths
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../NAVIGATION_ENHANCEMENTS/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Navigation Enhancements
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../FORMATTING_ISSUES/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Formatting Issues
    
  </span>
  
    
  
  
    <span class="md-status md-status--complete"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="url-shortener-service">URL Shortener Service<a class="headerlink" href="#url-shortener-service" title="Permanent link">&para;</a></h1>
<h2 id="challenge-statement">🎯 Challenge Statement<a class="headerlink" href="#challenge-statement" title="Permanent link">&para;</a></h2>
<p>Design a URL shortening service capable of handling billions of URLs, providing sub-50ms redirects globally, supporting custom aliases, detailed analytics, spam detection, and graceful handling of expired or malicious links.</p>
<h2 id="part-1-concept-map">Part 1: Concept Map<a class="headerlink" href="#part-1-concept-map" title="Permanent link">&para;</a></h2>
<h3 id="system-overview">🗺️ System Overview<a class="headerlink" href="#system-overview" title="Permanent link">&para;</a></h3>
<p>A URL shortener converts long URLs into short, manageable links while providing analytics, custom branding, and protection against abuse. Examples include bit.ly, goo.gl (defunct), and TinyURL. The system must balance between short code length, uniqueness guarantees, and operational complexity.</p>
<p><strong>Key Requirements:</strong>
- Shorten 100M URLs/day (1,200 URLs/second average)
- Handle 10B redirects/day (120K redirects/second)
- Short URLs: 7-8 characters max
- Global &lt;50ms redirect latency
- Custom URL support
- Detailed analytics
- Spam/malware detection
- URL expiration handling</p>
<h3 id="axiom-analysis">📐 Axiom Analysis<a class="headerlink" href="#axiom-analysis" title="Permanent link">&para;</a></h3>
<h4 id="axiom-1-latency-redirect-performance">🚀 Axiom 1 (Latency): Redirect Performance<a class="headerlink" href="#axiom-1-latency-redirect-performance" title="Permanent link">&para;</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>Latency Budget (50ms total):
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>- DNS lookup: 10ms
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>- TLS handshake: 10ms
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>- Server processing: 5ms
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>- Database lookup: 10ms
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>- Response time: 5ms
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>- Buffer: 10ms
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>Optimization Hierarchy:
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>1. CDN edge cache: 5ms (90% hit rate)
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>2. Regional cache: 15ms (8% hit rate)
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>3. Database lookup: 30ms (2% hit rate)
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>Cache Strategy:
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>- Popular URLs in edge locations
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>- LRU eviction with TTL
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>- Predictive warming
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>- Geo-distributed caches
</span></code></pre></div>
<p><strong>Implementation:</strong>
<div class="language-python highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">string</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">redis</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">bloom_filter</span><span class="w"> </span><span class="kn">import</span> <span class="n">BloomFilter</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">HighPerformanceURLShortener</span><span class="p">:</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>        <span class="c1"># Multi-level cache setup</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">edge_cache</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Simulated edge cache</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">redis_cache</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">Redis</span><span class="p">(</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>            <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>            <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>            <span class="n">socket_keepalive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>            <span class="n">socket_connect_timeout</span><span class="o">=</span><span class="mf">0.5</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>        <span class="p">)</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>        <span class="c1"># Bloom filter for existence checks</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bloom</span> <span class="o">=</span> <span class="n">BloomFilter</span><span class="p">(</span>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a>            <span class="n">capacity</span><span class="o">=</span><span class="mi">1_000_000_000</span><span class="p">,</span>  <span class="c1"># 1B URLs</span>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a>            <span class="n">error_rate</span><span class="o">=</span><span class="mf">0.001</span>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a>        <span class="p">)</span>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a>
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a>        <span class="c1"># Base62 encoding characters</span>
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">base62_chars</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span>
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a>
</span><span id="__span-1-29"><a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a>        <span class="c1"># Performance optimization</span>
</span><span id="__span-1-30"><a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_ttl</span> <span class="o">=</span> <span class="mi">3600</span>  <span class="c1"># 1 hour</span>
</span><span id="__span-1-31"><a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">100</span>
</span><span id="__span-1-32"><a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_enabled</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-1-33"><a id="__codelineno-1-33" name="__codelineno-1-33" href="#__codelineno-1-33"></a>
</span><span id="__span-1-34"><a id="__codelineno-1-34" name="__codelineno-1-34" href="#__codelineno-1-34"></a>        <span class="c1"># Pre-computed short codes for performance</span>
</span><span id="__span-1-35"><a id="__codelineno-1-35" name="__codelineno-1-35" href="#__codelineno-1-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">precomputed_codes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-1-36"><a id="__codelineno-1-36" name="__codelineno-1-36" href="#__codelineno-1-36"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_precompute_codes</span><span class="p">()</span>
</span><span id="__span-1-37"><a id="__codelineno-1-37" name="__codelineno-1-37" href="#__codelineno-1-37"></a>
</span><span id="__span-1-38"><a id="__codelineno-1-38" name="__codelineno-1-38" href="#__codelineno-1-38"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">redirect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">short_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="__span-1-39"><a id="__codelineno-1-39" name="__codelineno-1-39" href="#__codelineno-1-39"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Ultra-low latency redirect with &lt;5ms p99&quot;&quot;&quot;</span>
</span><span id="__span-1-40"><a id="__codelineno-1-40" name="__codelineno-1-40" href="#__codelineno-1-40"></a>        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</span><span id="__span-1-41"><a id="__codelineno-1-41" name="__codelineno-1-41" href="#__codelineno-1-41"></a>
</span><span id="__span-1-42"><a id="__codelineno-1-42" name="__codelineno-1-42" href="#__codelineno-1-42"></a>        <span class="c1"># L1: Edge cache (0.01ms)</span>
</span><span id="__span-1-43"><a id="__codelineno-1-43" name="__codelineno-1-43" href="#__codelineno-1-43"></a>        <span class="k">if</span> <span class="n">short_code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_cache</span><span class="p">:</span>
</span><span id="__span-1-44"><a id="__codelineno-1-44" name="__codelineno-1-44" href="#__codelineno-1-44"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_record_latency</span><span class="p">(</span><span class="s1">&#39;edge_hit&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
</span><span id="__span-1-45"><a id="__codelineno-1-45" name="__codelineno-1-45" href="#__codelineno-1-45"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_update_analytics_async</span><span class="p">(</span><span class="n">short_code</span><span class="p">,</span> <span class="s1">&#39;edge&#39;</span><span class="p">)</span>
</span><span id="__span-1-46"><a id="__codelineno-1-46" name="__codelineno-1-46" href="#__codelineno-1-46"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_cache</span><span class="p">[</span><span class="n">short_code</span><span class="p">]</span>
</span><span id="__span-1-47"><a id="__codelineno-1-47" name="__codelineno-1-47" href="#__codelineno-1-47"></a>
</span><span id="__span-1-48"><a id="__codelineno-1-48" name="__codelineno-1-48" href="#__codelineno-1-48"></a>        <span class="c1"># Bloom filter check (0.1ms)</span>
</span><span id="__span-1-49"><a id="__codelineno-1-49" name="__codelineno-1-49" href="#__codelineno-1-49"></a>        <span class="k">if</span> <span class="n">short_code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bloom</span><span class="p">:</span>
</span><span id="__span-1-50"><a id="__codelineno-1-50" name="__codelineno-1-50" href="#__codelineno-1-50"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_record_latency</span><span class="p">(</span><span class="s1">&#39;bloom_miss&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
</span><span id="__span-1-51"><a id="__codelineno-1-51" name="__codelineno-1-51" href="#__codelineno-1-51"></a>            <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Definitely doesn&#39;t exist</span>
</span><span id="__span-1-52"><a id="__codelineno-1-52" name="__codelineno-1-52" href="#__codelineno-1-52"></a>
</span><span id="__span-1-53"><a id="__codelineno-1-53" name="__codelineno-1-53" href="#__codelineno-1-53"></a>        <span class="c1"># L2: Redis cache (1ms)</span>
</span><span id="__span-1-54"><a id="__codelineno-1-54" name="__codelineno-1-54" href="#__codelineno-1-54"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-1-55"><a id="__codelineno-1-55" name="__codelineno-1-55" href="#__codelineno-1-55"></a>            <span class="n">long_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;url:</span><span class="si">{</span><span class="n">short_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-1-56"><a id="__codelineno-1-56" name="__codelineno-1-56" href="#__codelineno-1-56"></a>            <span class="k">if</span> <span class="n">long_url</span><span class="p">:</span>
</span><span id="__span-1-57"><a id="__codelineno-1-57" name="__codelineno-1-57" href="#__codelineno-1-57"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_record_latency</span><span class="p">(</span><span class="s1">&#39;redis_hit&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
</span><span id="__span-1-58"><a id="__codelineno-1-58" name="__codelineno-1-58" href="#__codelineno-1-58"></a>                <span class="c1"># Populate edge cache</span>
</span><span id="__span-1-59"><a id="__codelineno-1-59" name="__codelineno-1-59" href="#__codelineno-1-59"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_update_edge_cache</span><span class="p">(</span><span class="n">short_code</span><span class="p">,</span> <span class="n">long_url</span><span class="p">)</span>
</span><span id="__span-1-60"><a id="__codelineno-1-60" name="__codelineno-1-60" href="#__codelineno-1-60"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_update_analytics_async</span><span class="p">(</span><span class="n">short_code</span><span class="p">,</span> <span class="s1">&#39;redis&#39;</span><span class="p">)</span>
</span><span id="__span-1-61"><a id="__codelineno-1-61" name="__codelineno-1-61" href="#__codelineno-1-61"></a>                <span class="k">return</span> <span class="n">long_url</span>
</span><span id="__span-1-62"><a id="__codelineno-1-62" name="__codelineno-1-62" href="#__codelineno-1-62"></a>        <span class="k">except</span> <span class="n">redis</span><span class="o">.</span><span class="n">RedisError</span><span class="p">:</span>
</span><span id="__span-1-63"><a id="__codelineno-1-63" name="__codelineno-1-63" href="#__codelineno-1-63"></a>            <span class="c1"># Continue to database on Redis failure</span>
</span><span id="__span-1-64"><a id="__codelineno-1-64" name="__codelineno-1-64" href="#__codelineno-1-64"></a>            <span class="k">pass</span>
</span><span id="__span-1-65"><a id="__codelineno-1-65" name="__codelineno-1-65" href="#__codelineno-1-65"></a>
</span><span id="__span-1-66"><a id="__codelineno-1-66" name="__codelineno-1-66" href="#__codelineno-1-66"></a>        <span class="c1"># L3: Database (10ms)</span>
</span><span id="__span-1-67"><a id="__codelineno-1-67" name="__codelineno-1-67" href="#__codelineno-1-67"></a>        <span class="n">long_url</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_lookup</span><span class="p">(</span><span class="n">short_code</span><span class="p">)</span>
</span><span id="__span-1-68"><a id="__codelineno-1-68" name="__codelineno-1-68" href="#__codelineno-1-68"></a>        <span class="k">if</span> <span class="n">long_url</span><span class="p">:</span>
</span><span id="__span-1-69"><a id="__codelineno-1-69" name="__codelineno-1-69" href="#__codelineno-1-69"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_record_latency</span><span class="p">(</span><span class="s1">&#39;db_hit&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
</span><span id="__span-1-70"><a id="__codelineno-1-70" name="__codelineno-1-70" href="#__codelineno-1-70"></a>            <span class="c1"># Populate caches</span>
</span><span id="__span-1-71"><a id="__codelineno-1-71" name="__codelineno-1-71" href="#__codelineno-1-71"></a>            <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_populate_caches</span><span class="p">(</span><span class="n">short_code</span><span class="p">,</span> <span class="n">long_url</span><span class="p">))</span>
</span><span id="__span-1-72"><a id="__codelineno-1-72" name="__codelineno-1-72" href="#__codelineno-1-72"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_update_analytics_async</span><span class="p">(</span><span class="n">short_code</span><span class="p">,</span> <span class="s1">&#39;db&#39;</span><span class="p">)</span>
</span><span id="__span-1-73"><a id="__codelineno-1-73" name="__codelineno-1-73" href="#__codelineno-1-73"></a>            <span class="k">return</span> <span class="n">long_url</span>
</span><span id="__span-1-74"><a id="__codelineno-1-74" name="__codelineno-1-74" href="#__codelineno-1-74"></a>
</span><span id="__span-1-75"><a id="__codelineno-1-75" name="__codelineno-1-75" href="#__codelineno-1-75"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_record_latency</span><span class="p">(</span><span class="s1">&#39;miss&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
</span><span id="__span-1-76"><a id="__codelineno-1-76" name="__codelineno-1-76" href="#__codelineno-1-76"></a>        <span class="k">return</span> <span class="kc">None</span>
</span><span id="__span-1-77"><a id="__codelineno-1-77" name="__codelineno-1-77" href="#__codelineno-1-77"></a>
</span><span id="__span-1-78"><a id="__codelineno-1-78" name="__codelineno-1-78" href="#__codelineno-1-78"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">shorten</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">long_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">custom_alias</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-1-79"><a id="__codelineno-1-79" name="__codelineno-1-79" href="#__codelineno-1-79"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create short URL with optional custom alias&quot;&quot;&quot;</span>
</span><span id="__span-1-80"><a id="__codelineno-1-80" name="__codelineno-1-80" href="#__codelineno-1-80"></a>        <span class="c1"># Validate URL</span>
</span><span id="__span-1-81"><a id="__codelineno-1-81" name="__codelineno-1-81" href="#__codelineno-1-81"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_url</span><span class="p">(</span><span class="n">long_url</span><span class="p">):</span>
</span><span id="__span-1-82"><a id="__codelineno-1-82" name="__codelineno-1-82" href="#__codelineno-1-82"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid URL&quot;</span><span class="p">)</span>
</span><span id="__span-1-83"><a id="__codelineno-1-83" name="__codelineno-1-83" href="#__codelineno-1-83"></a>
</span><span id="__span-1-84"><a id="__codelineno-1-84" name="__codelineno-1-84" href="#__codelineno-1-84"></a>        <span class="c1"># Check for spam/malware</span>
</span><span id="__span-1-85"><a id="__codelineno-1-85" name="__codelineno-1-85" href="#__codelineno-1-85"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_spam</span><span class="p">(</span><span class="n">long_url</span><span class="p">):</span>
</span><span id="__span-1-86"><a id="__codelineno-1-86" name="__codelineno-1-86" href="#__codelineno-1-86"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;URL flagged as spam/malware&quot;</span><span class="p">)</span>
</span><span id="__span-1-87"><a id="__codelineno-1-87" name="__codelineno-1-87" href="#__codelineno-1-87"></a>
</span><span id="__span-1-88"><a id="__codelineno-1-88" name="__codelineno-1-88" href="#__codelineno-1-88"></a>        <span class="c1"># Custom alias path</span>
</span><span id="__span-1-89"><a id="__codelineno-1-89" name="__codelineno-1-89" href="#__codelineno-1-89"></a>        <span class="k">if</span> <span class="n">custom_alias</span><span class="p">:</span>
</span><span id="__span-1-90"><a id="__codelineno-1-90" name="__codelineno-1-90" href="#__codelineno-1-90"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_alias_taken</span><span class="p">(</span><span class="n">custom_alias</span><span class="p">):</span>
</span><span id="__span-1-91"><a id="__codelineno-1-91" name="__codelineno-1-91" href="#__codelineno-1-91"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Alias &#39;</span><span class="si">{</span><span class="n">custom_alias</span><span class="si">}</span><span class="s2">&#39; already taken&quot;</span><span class="p">)</span>
</span><span id="__span-1-92"><a id="__codelineno-1-92" name="__codelineno-1-92" href="#__codelineno-1-92"></a>            <span class="n">short_code</span> <span class="o">=</span> <span class="n">custom_alias</span>
</span><span id="__span-1-93"><a id="__codelineno-1-93" name="__codelineno-1-93" href="#__codelineno-1-93"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-1-94"><a id="__codelineno-1-94" name="__codelineno-1-94" href="#__codelineno-1-94"></a>            <span class="c1"># Generate short code</span>
</span><span id="__span-1-95"><a id="__codelineno-1-95" name="__codelineno-1-95" href="#__codelineno-1-95"></a>            <span class="n">short_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_short_code</span><span class="p">(</span><span class="n">long_url</span><span class="p">)</span>
</span><span id="__span-1-96"><a id="__codelineno-1-96" name="__codelineno-1-96" href="#__codelineno-1-96"></a>
</span><span id="__span-1-97"><a id="__codelineno-1-97" name="__codelineno-1-97" href="#__codelineno-1-97"></a>        <span class="c1"># Store mapping</span>
</span><span id="__span-1-98"><a id="__codelineno-1-98" name="__codelineno-1-98" href="#__codelineno-1-98"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_store_url_mapping</span><span class="p">(</span><span class="n">short_code</span><span class="p">,</span> <span class="n">long_url</span><span class="p">)</span>
</span><span id="__span-1-99"><a id="__codelineno-1-99" name="__codelineno-1-99" href="#__codelineno-1-99"></a>
</span><span id="__span-1-100"><a id="__codelineno-1-100" name="__codelineno-1-100" href="#__codelineno-1-100"></a>        <span class="c1"># Add to bloom filter</span>
</span><span id="__span-1-101"><a id="__codelineno-1-101" name="__codelineno-1-101" href="#__codelineno-1-101"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bloom</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">short_code</span><span class="p">)</span>
</span><span id="__span-1-102"><a id="__codelineno-1-102" name="__codelineno-1-102" href="#__codelineno-1-102"></a>
</span><span id="__span-1-103"><a id="__codelineno-1-103" name="__codelineno-1-103" href="#__codelineno-1-103"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;https://short.url/</span><span class="si">{</span><span class="n">short_code</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-1-104"><a id="__codelineno-1-104" name="__codelineno-1-104" href="#__codelineno-1-104"></a>
</span><span id="__span-1-105"><a id="__codelineno-1-105" name="__codelineno-1-105" href="#__codelineno-1-105"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_short_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">long_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-1-106"><a id="__codelineno-1-106" name="__codelineno-1-106" href="#__codelineno-1-106"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate short code using multiple strategies&quot;&quot;&quot;</span>
</span><span id="__span-1-107"><a id="__codelineno-1-107" name="__codelineno-1-107" href="#__codelineno-1-107"></a>        <span class="c1"># Try pre-computed codes first</span>
</span><span id="__span-1-108"><a id="__codelineno-1-108" name="__codelineno-1-108" href="#__codelineno-1-108"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">precomputed_codes</span><span class="p">:</span>
</span><span id="__span-1-109"><a id="__codelineno-1-109" name="__codelineno-1-109" href="#__codelineno-1-109"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">precomputed_codes</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span><span id="__span-1-110"><a id="__codelineno-1-110" name="__codelineno-1-110" href="#__codelineno-1-110"></a>
</span><span id="__span-1-111"><a id="__codelineno-1-111" name="__codelineno-1-111" href="#__codelineno-1-111"></a>        <span class="c1"># Counter-based approach with encoding</span>
</span><span id="__span-1-112"><a id="__codelineno-1-112" name="__codelineno-1-112" href="#__codelineno-1-112"></a>        <span class="n">counter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_next_counter</span><span class="p">()</span>
</span><span id="__span-1-113"><a id="__codelineno-1-113" name="__codelineno-1-113" href="#__codelineno-1-113"></a>        <span class="n">short_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base62_encode</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span>
</span><span id="__span-1-114"><a id="__codelineno-1-114" name="__codelineno-1-114" href="#__codelineno-1-114"></a>
</span><span id="__span-1-115"><a id="__codelineno-1-115" name="__codelineno-1-115" href="#__codelineno-1-115"></a>        <span class="c1"># Check for collisions (shouldn&#39;t happen with counter)</span>
</span><span id="__span-1-116"><a id="__codelineno-1-116" name="__codelineno-1-116" href="#__codelineno-1-116"></a>        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exists</span><span class="p">(</span><span class="n">short_code</span><span class="p">):</span>
</span><span id="__span-1-117"><a id="__codelineno-1-117" name="__codelineno-1-117" href="#__codelineno-1-117"></a>            <span class="n">counter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_next_counter</span><span class="p">()</span>
</span><span id="__span-1-118"><a id="__codelineno-1-118" name="__codelineno-1-118" href="#__codelineno-1-118"></a>            <span class="n">short_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base62_encode</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span>
</span><span id="__span-1-119"><a id="__codelineno-1-119" name="__codelineno-1-119" href="#__codelineno-1-119"></a>
</span><span id="__span-1-120"><a id="__codelineno-1-120" name="__codelineno-1-120" href="#__codelineno-1-120"></a>        <span class="k">return</span> <span class="n">short_code</span>
</span><span id="__span-1-121"><a id="__codelineno-1-121" name="__codelineno-1-121" href="#__codelineno-1-121"></a>
</span><span id="__span-1-122"><a id="__codelineno-1-122" name="__codelineno-1-122" href="#__codelineno-1-122"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_base62_encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-1-123"><a id="__codelineno-1-123" name="__codelineno-1-123" href="#__codelineno-1-123"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert number to base62 string&quot;&quot;&quot;</span>
</span><span id="__span-1-124"><a id="__codelineno-1-124" name="__codelineno-1-124" href="#__codelineno-1-124"></a>        <span class="k">if</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-1-125"><a id="__codelineno-1-125" name="__codelineno-1-125" href="#__codelineno-1-125"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">base62_chars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-1-126"><a id="__codelineno-1-126" name="__codelineno-1-126" href="#__codelineno-1-126"></a>
</span><span id="__span-1-127"><a id="__codelineno-1-127" name="__codelineno-1-127" href="#__codelineno-1-127"></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-1-128"><a id="__codelineno-1-128" name="__codelineno-1-128" href="#__codelineno-1-128"></a>        <span class="k">while</span> <span class="n">num</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-1-129"><a id="__codelineno-1-129" name="__codelineno-1-129" href="#__codelineno-1-129"></a>            <span class="n">num</span><span class="p">,</span> <span class="n">remainder</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="mi">62</span><span class="p">)</span>
</span><span id="__span-1-130"><a id="__codelineno-1-130" name="__codelineno-1-130" href="#__codelineno-1-130"></a>            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base62_chars</span><span class="p">[</span><span class="n">remainder</span><span class="p">])</span>
</span><span id="__span-1-131"><a id="__codelineno-1-131" name="__codelineno-1-131" href="#__codelineno-1-131"></a>
</span><span id="__span-1-132"><a id="__codelineno-1-132" name="__codelineno-1-132" href="#__codelineno-1-132"></a>        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
</span><span id="__span-1-133"><a id="__codelineno-1-133" name="__codelineno-1-133" href="#__codelineno-1-133"></a>
</span><span id="__span-1-134"><a id="__codelineno-1-134" name="__codelineno-1-134" href="#__codelineno-1-134"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_precompute_codes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-1-135"><a id="__codelineno-1-135" name="__codelineno-1-135" href="#__codelineno-1-135"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Pre-generate short codes for better performance&quot;&quot;&quot;</span>
</span><span id="__span-1-136"><a id="__codelineno-1-136" name="__codelineno-1-136" href="#__codelineno-1-136"></a>        <span class="c1"># Generate codes in background</span>
</span><span id="__span-1-137"><a id="__codelineno-1-137" name="__codelineno-1-137" href="#__codelineno-1-137"></a>        <span class="k">def</span><span class="w"> </span><span class="nf">generate_batch</span><span class="p">():</span>
</span><span id="__span-1-138"><a id="__codelineno-1-138" name="__codelineno-1-138" href="#__codelineno-1-138"></a>            <span class="n">batch</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-1-139"><a id="__codelineno-1-139" name="__codelineno-1-139" href="#__codelineno-1-139"></a>            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">):</span>
</span><span id="__span-1-140"><a id="__codelineno-1-140" name="__codelineno-1-140" href="#__codelineno-1-140"></a>                <span class="n">counter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_next_counter</span><span class="p">()</span>
</span><span id="__span-1-141"><a id="__codelineno-1-141" name="__codelineno-1-141" href="#__codelineno-1-141"></a>                <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base62_encode</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span>
</span><span id="__span-1-142"><a id="__codelineno-1-142" name="__codelineno-1-142" href="#__codelineno-1-142"></a>                <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
</span><span id="__span-1-143"><a id="__codelineno-1-143" name="__codelineno-1-143" href="#__codelineno-1-143"></a>            <span class="k">return</span> <span class="n">batch</span>
</span><span id="__span-1-144"><a id="__codelineno-1-144" name="__codelineno-1-144" href="#__codelineno-1-144"></a>
</span><span id="__span-1-145"><a id="__codelineno-1-145" name="__codelineno-1-145" href="#__codelineno-1-145"></a>        <span class="c1"># Async generation</span>
</span><span id="__span-1-146"><a id="__codelineno-1-146" name="__codelineno-1-146" href="#__codelineno-1-146"></a>        <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_async_precompute</span><span class="p">(</span><span class="n">generate_batch</span><span class="p">))</span>
</span><span id="__span-1-147"><a id="__codelineno-1-147" name="__codelineno-1-147" href="#__codelineno-1-147"></a>
</span><span id="__span-1-148"><a id="__codelineno-1-148" name="__codelineno-1-148" href="#__codelineno-1-148"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_populate_caches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">short_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">long_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-1-149"><a id="__codelineno-1-149" name="__codelineno-1-149" href="#__codelineno-1-149"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Populate all cache levels asynchronously&quot;&quot;&quot;</span>
</span><span id="__span-1-150"><a id="__codelineno-1-150" name="__codelineno-1-150" href="#__codelineno-1-150"></a>        <span class="c1"># Redis with TTL</span>
</span><span id="__span-1-151"><a id="__codelineno-1-151" name="__codelineno-1-151" href="#__codelineno-1-151"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-1-152"><a id="__codelineno-1-152" name="__codelineno-1-152" href="#__codelineno-1-152"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">redis_cache</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span>
</span><span id="__span-1-153"><a id="__codelineno-1-153" name="__codelineno-1-153" href="#__codelineno-1-153"></a>                <span class="sa">f</span><span class="s2">&quot;url:</span><span class="si">{</span><span class="n">short_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="__span-1-154"><a id="__codelineno-1-154" name="__codelineno-1-154" href="#__codelineno-1-154"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">cache_ttl</span><span class="p">,</span>
</span><span id="__span-1-155"><a id="__codelineno-1-155" name="__codelineno-1-155" href="#__codelineno-1-155"></a>                <span class="n">long_url</span>
</span><span id="__span-1-156"><a id="__codelineno-1-156" name="__codelineno-1-156" href="#__codelineno-1-156"></a>            <span class="p">)</span>
</span><span id="__span-1-157"><a id="__codelineno-1-157" name="__codelineno-1-157" href="#__codelineno-1-157"></a>        <span class="k">except</span> <span class="n">redis</span><span class="o">.</span><span class="n">RedisError</span><span class="p">:</span>
</span><span id="__span-1-158"><a id="__codelineno-1-158" name="__codelineno-1-158" href="#__codelineno-1-158"></a>            <span class="k">pass</span>
</span><span id="__span-1-159"><a id="__codelineno-1-159" name="__codelineno-1-159" href="#__codelineno-1-159"></a>
</span><span id="__span-1-160"><a id="__codelineno-1-160" name="__codelineno-1-160" href="#__codelineno-1-160"></a>        <span class="c1"># Edge cache (LRU)</span>
</span><span id="__span-1-161"><a id="__codelineno-1-161" name="__codelineno-1-161" href="#__codelineno-1-161"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edge_cache</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">10000</span><span class="p">:</span>
</span><span id="__span-1-162"><a id="__codelineno-1-162" name="__codelineno-1-162" href="#__codelineno-1-162"></a>            <span class="c1"># Simple LRU: remove oldest</span>
</span><span id="__span-1-163"><a id="__codelineno-1-163" name="__codelineno-1-163" href="#__codelineno-1-163"></a>            <span class="n">oldest</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edge_cache</span><span class="p">))</span>
</span><span id="__span-1-164"><a id="__codelineno-1-164" name="__codelineno-1-164" href="#__codelineno-1-164"></a>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_cache</span><span class="p">[</span><span class="n">oldest</span><span class="p">]</span>
</span><span id="__span-1-165"><a id="__codelineno-1-165" name="__codelineno-1-165" href="#__codelineno-1-165"></a>
</span><span id="__span-1-166"><a id="__codelineno-1-166" name="__codelineno-1-166" href="#__codelineno-1-166"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">edge_cache</span><span class="p">[</span><span class="n">short_code</span><span class="p">]</span> <span class="o">=</span> <span class="n">long_url</span>
</span><span id="__span-1-167"><a id="__codelineno-1-167" name="__codelineno-1-167" href="#__codelineno-1-167"></a>
</span><span id="__span-1-168"><a id="__codelineno-1-168" name="__codelineno-1-168" href="#__codelineno-1-168"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_update_analytics_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">short_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cache_level</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-1-169"><a id="__codelineno-1-169" name="__codelineno-1-169" href="#__codelineno-1-169"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update analytics without blocking redirect&quot;&quot;&quot;</span>
</span><span id="__span-1-170"><a id="__codelineno-1-170" name="__codelineno-1-170" href="#__codelineno-1-170"></a>        <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_record_analytics</span><span class="p">(</span><span class="n">short_code</span><span class="p">,</span> <span class="n">cache_level</span><span class="p">))</span>
</span><span id="__span-1-171"><a id="__codelineno-1-171" name="__codelineno-1-171" href="#__codelineno-1-171"></a>
</span><span id="__span-1-172"><a id="__codelineno-1-172" name="__codelineno-1-172" href="#__codelineno-1-172"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_record_analytics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">short_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cache_level</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-1-173"><a id="__codelineno-1-173" name="__codelineno-1-173" href="#__codelineno-1-173"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Record detailed analytics&quot;&quot;&quot;</span>
</span><span id="__span-1-174"><a id="__codelineno-1-174" name="__codelineno-1-174" href="#__codelineno-1-174"></a>        <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
</span><span id="__span-1-175"><a id="__codelineno-1-175" name="__codelineno-1-175" href="#__codelineno-1-175"></a>
</span><span id="__span-1-176"><a id="__codelineno-1-176" name="__codelineno-1-176" href="#__codelineno-1-176"></a>        <span class="c1"># Batch analytics updates</span>
</span><span id="__span-1-177"><a id="__codelineno-1-177" name="__codelineno-1-177" href="#__codelineno-1-177"></a>        <span class="n">analytics_data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-1-178"><a id="__codelineno-1-178" name="__codelineno-1-178" href="#__codelineno-1-178"></a>            <span class="s1">&#39;short_code&#39;</span><span class="p">:</span> <span class="n">short_code</span><span class="p">,</span>
</span><span id="__span-1-179"><a id="__codelineno-1-179" name="__codelineno-1-179" href="#__codelineno-1-179"></a>            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
</span><span id="__span-1-180"><a id="__codelineno-1-180" name="__codelineno-1-180" href="#__codelineno-1-180"></a>            <span class="s1">&#39;cache_level&#39;</span><span class="p">:</span> <span class="n">cache_level</span><span class="p">,</span>
</span><span id="__span-1-181"><a id="__codelineno-1-181" name="__codelineno-1-181" href="#__codelineno-1-181"></a>            <span class="s1">&#39;user_agent&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_agent</span><span class="p">(),</span>
</span><span id="__span-1-182"><a id="__codelineno-1-182" name="__codelineno-1-182" href="#__codelineno-1-182"></a>            <span class="s1">&#39;ip&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_client_ip</span><span class="p">(),</span>
</span><span id="__span-1-183"><a id="__codelineno-1-183" name="__codelineno-1-183" href="#__codelineno-1-183"></a>            <span class="s1">&#39;referer&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_referer</span><span class="p">()</span>
</span><span id="__span-1-184"><a id="__codelineno-1-184" name="__codelineno-1-184" href="#__codelineno-1-184"></a>        <span class="p">}</span>
</span><span id="__span-1-185"><a id="__codelineno-1-185" name="__codelineno-1-185" href="#__codelineno-1-185"></a>
</span><span id="__span-1-186"><a id="__codelineno-1-186" name="__codelineno-1-186" href="#__codelineno-1-186"></a>        <span class="c1"># Write to analytics pipeline</span>
</span><span id="__span-1-187"><a id="__codelineno-1-187" name="__codelineno-1-187" href="#__codelineno-1-187"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_to_analytics_stream</span><span class="p">(</span><span class="n">analytics_data</span><span class="p">)</span>
</span></code></pre></div></p>
<h4 id="axiom-2-capacity-storage-optimization">💾 Axiom 2 (Capacity): Storage Optimization<a class="headerlink" href="#axiom-2-capacity-storage-optimization" title="Permanent link">&para;</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>Storage Requirements:
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>- URLs: 100M/day × 365 days × 5 years = 180B URLs
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>- Average URL length: 100 characters
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>- Short code: 7 characters
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>- Metadata: 50 bytes (timestamps, counters)
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>Total Storage:
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>- URL mappings: 180B × 150 bytes = 27TB
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>- Analytics: 10B redirects/day × 100 bytes = 1TB/day
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>- Indexes: 180B × 20 bytes = 3.6TB
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>- Total: ~30TB active + 1.8PB analytics/year
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>Optimization Strategies:
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>- URL deduplication
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>- Compression (zstd)
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>- Tiered storage
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>- Analytics sampling
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>- Archival policies
</span></code></pre></div>
<p><strong>Implementation:</strong>
<div class="language-python highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">StorageOptimizedShortener</span><span class="p">:</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dedup_index</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Long URL -&gt; short code</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">compression_enabled</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">storage_tiers</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>            <span class="s1">&#39;hot&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;limit&#39;</span><span class="p">:</span> <span class="mi">1_000_000_000</span><span class="p">},</span>     <span class="c1"># 1B URLs in memory/SSD</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>            <span class="s1">&#39;warm&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;limit&#39;</span><span class="p">:</span> <span class="mi">10_000_000_000</span><span class="p">},</span>   <span class="c1"># 10B URLs in SSD</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>            <span class="s1">&#39;cold&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;limit&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)}</span>      <span class="c1"># Unlimited in S3</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>        <span class="p">}</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>        <span class="c1"># Sharding configuration</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shard_count</span> <span class="o">=</span> <span class="mi">1000</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">replication_factor</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">store_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">short_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">long_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Store URL with deduplication and compression&quot;&quot;&quot;</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a>        <span class="c1"># Check for duplicates</span>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>        <span class="n">existing_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dedup_index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">long_url</span><span class="p">)</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>        <span class="k">if</span> <span class="n">existing_code</span><span class="p">:</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>            <span class="c1"># URL already shortened, reuse code</span>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_create_alias</span><span class="p">(</span><span class="n">short_code</span><span class="p">,</span> <span class="n">existing_code</span><span class="p">)</span>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a>
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a>        <span class="c1"># Compress if beneficial</span>
</span><span id="__span-3-25"><a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a>        <span class="n">original_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">long_url</span><span class="p">)</span>
</span><span id="__span-3-26"><a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression_enabled</span> <span class="ow">and</span> <span class="n">original_size</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
</span><span id="__span-3-27"><a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a>            <span class="n">compressed_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compress</span><span class="p">(</span><span class="n">long_url</span><span class="p">)</span>
</span><span id="__span-3-28"><a id="__codelineno-3-28" name="__codelineno-3-28" href="#__codelineno-3-28"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">compressed_url</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">original_size</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">:</span>
</span><span id="__span-3-29"><a id="__codelineno-3-29" name="__codelineno-3-29" href="#__codelineno-3-29"></a>                <span class="n">long_url</span> <span class="o">=</span> <span class="n">compressed_url</span>
</span><span id="__span-3-30"><a id="__codelineno-3-30" name="__codelineno-3-30" href="#__codelineno-3-30"></a>                <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;compressed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-3-31"><a id="__codelineno-3-31" name="__codelineno-3-31" href="#__codelineno-3-31"></a>
</span><span id="__span-3-32"><a id="__codelineno-3-32" name="__codelineno-3-32" href="#__codelineno-3-32"></a>        <span class="c1"># Determine storage tier</span>
</span><span id="__span-3-33"><a id="__codelineno-3-33" name="__codelineno-3-33" href="#__codelineno-3-33"></a>        <span class="n">tier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_storage_tier</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
</span><span id="__span-3-34"><a id="__codelineno-3-34" name="__codelineno-3-34" href="#__codelineno-3-34"></a>
</span><span id="__span-3-35"><a id="__codelineno-3-35" name="__codelineno-3-35" href="#__codelineno-3-35"></a>        <span class="c1"># Calculate shard</span>
</span><span id="__span-3-36"><a id="__codelineno-3-36" name="__codelineno-3-36" href="#__codelineno-3-36"></a>        <span class="n">shard_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_shard</span><span class="p">(</span><span class="n">short_code</span><span class="p">)</span>
</span><span id="__span-3-37"><a id="__codelineno-3-37" name="__codelineno-3-37" href="#__codelineno-3-37"></a>
</span><span id="__span-3-38"><a id="__codelineno-3-38" name="__codelineno-3-38" href="#__codelineno-3-38"></a>        <span class="c1"># Store in appropriate tier</span>
</span><span id="__span-3-39"><a id="__codelineno-3-39" name="__codelineno-3-39" href="#__codelineno-3-39"></a>        <span class="n">stored</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store_in_tier</span><span class="p">(</span><span class="n">tier</span><span class="p">,</span> <span class="n">shard_id</span><span class="p">,</span> <span class="n">short_code</span><span class="p">,</span> <span class="n">long_url</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
</span><span id="__span-3-40"><a id="__codelineno-3-40" name="__codelineno-3-40" href="#__codelineno-3-40"></a>
</span><span id="__span-3-41"><a id="__codelineno-3-41" name="__codelineno-3-41" href="#__codelineno-3-41"></a>        <span class="k">if</span> <span class="n">stored</span><span class="p">:</span>
</span><span id="__span-3-42"><a id="__codelineno-3-42" name="__codelineno-3-42" href="#__codelineno-3-42"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dedup_index</span><span class="p">[</span><span class="n">long_url</span><span class="p">]</span> <span class="o">=</span> <span class="n">short_code</span>
</span><span id="__span-3-43"><a id="__codelineno-3-43" name="__codelineno-3-43" href="#__codelineno-3-43"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">storage_tiers</span><span class="p">[</span><span class="n">tier</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">long_url</span><span class="p">)</span>
</span><span id="__span-3-44"><a id="__codelineno-3-44" name="__codelineno-3-44" href="#__codelineno-3-44"></a>
</span><span id="__span-3-45"><a id="__codelineno-3-45" name="__codelineno-3-45" href="#__codelineno-3-45"></a>        <span class="k">return</span> <span class="n">stored</span>
</span><span id="__span-3-46"><a id="__codelineno-3-46" name="__codelineno-3-46" href="#__codelineno-3-46"></a>
</span><span id="__span-3-47"><a id="__codelineno-3-47" name="__codelineno-3-47" href="#__codelineno-3-47"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_shard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">short_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="__span-3-48"><a id="__codelineno-3-48" name="__codelineno-3-48" href="#__codelineno-3-48"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine shard for URL&quot;&quot;&quot;</span>
</span><span id="__span-3-49"><a id="__codelineno-3-49" name="__codelineno-3-49" href="#__codelineno-3-49"></a>        <span class="c1"># Use consistent hashing for even distribution</span>
</span><span id="__span-3-50"><a id="__codelineno-3-50" name="__codelineno-3-50" href="#__codelineno-3-50"></a>        <span class="n">hash_value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">short_code</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(),</span> <span class="mi">16</span><span class="p">)</span>
</span><span id="__span-3-51"><a id="__codelineno-3-51" name="__codelineno-3-51" href="#__codelineno-3-51"></a>        <span class="k">return</span> <span class="n">hash_value</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">shard_count</span>
</span><span id="__span-3-52"><a id="__codelineno-3-52" name="__codelineno-3-52" href="#__codelineno-3-52"></a>
</span><span id="__span-3-53"><a id="__codelineno-3-53" name="__codelineno-3-53" href="#__codelineno-3-53"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_select_storage_tier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-3-54"><a id="__codelineno-3-54" name="__codelineno-3-54" href="#__codelineno-3-54"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Choose storage tier based on URL characteristics&quot;&quot;&quot;</span>
</span><span id="__span-3-55"><a id="__codelineno-3-55" name="__codelineno-3-55" href="#__codelineno-3-55"></a>        <span class="c1"># Hot tier for recent/popular URLs</span>
</span><span id="__span-3-56"><a id="__codelineno-3-56" name="__codelineno-3-56" href="#__codelineno-3-56"></a>        <span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;custom_alias&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;premium_user&#39;</span><span class="p">):</span>
</span><span id="__span-3-57"><a id="__codelineno-3-57" name="__codelineno-3-57" href="#__codelineno-3-57"></a>            <span class="k">return</span> <span class="s1">&#39;hot&#39;</span>
</span><span id="__span-3-58"><a id="__codelineno-3-58" name="__codelineno-3-58" href="#__codelineno-3-58"></a>
</span><span id="__span-3-59"><a id="__codelineno-3-59" name="__codelineno-3-59" href="#__codelineno-3-59"></a>        <span class="c1"># Warm tier for regular URLs</span>
</span><span id="__span-3-60"><a id="__codelineno-3-60" name="__codelineno-3-60" href="#__codelineno-3-60"></a>        <span class="n">age_days</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="mi">86400</span>
</span><span id="__span-3-61"><a id="__codelineno-3-61" name="__codelineno-3-61" href="#__codelineno-3-61"></a>        <span class="k">if</span> <span class="n">age_days</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">:</span>
</span><span id="__span-3-62"><a id="__codelineno-3-62" name="__codelineno-3-62" href="#__codelineno-3-62"></a>            <span class="k">return</span> <span class="s1">&#39;warm&#39;</span>
</span><span id="__span-3-63"><a id="__codelineno-3-63" name="__codelineno-3-63" href="#__codelineno-3-63"></a>
</span><span id="__span-3-64"><a id="__codelineno-3-64" name="__codelineno-3-64" href="#__codelineno-3-64"></a>        <span class="c1"># Cold tier for old URLs</span>
</span><span id="__span-3-65"><a id="__codelineno-3-65" name="__codelineno-3-65" href="#__codelineno-3-65"></a>        <span class="k">return</span> <span class="s1">&#39;cold&#39;</span>
</span><span id="__span-3-66"><a id="__codelineno-3-66" name="__codelineno-3-66" href="#__codelineno-3-66"></a>
</span><span id="__span-3-67"><a id="__codelineno-3-67" name="__codelineno-3-67" href="#__codelineno-3-67"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">migrate_to_cold_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-3-68"><a id="__codelineno-3-68" name="__codelineno-3-68" href="#__codelineno-3-68"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Move old URLs to cheaper storage&quot;&quot;&quot;</span>
</span><span id="__span-3-69"><a id="__codelineno-3-69" name="__codelineno-3-69" href="#__codelineno-3-69"></a>        <span class="n">migrated_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-3-70"><a id="__codelineno-3-70" name="__codelineno-3-70" href="#__codelineno-3-70"></a>        <span class="n">migrated_size</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-3-71"><a id="__codelineno-3-71" name="__codelineno-3-71" href="#__codelineno-3-71"></a>
</span><span id="__span-3-72"><a id="__codelineno-3-72" name="__codelineno-3-72" href="#__codelineno-3-72"></a>        <span class="c1"># Query warm tier for old URLs</span>
</span><span id="__span-3-73"><a id="__codelineno-3-73" name="__codelineno-3-73" href="#__codelineno-3-73"></a>        <span class="n">cutoff_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="p">(</span><span class="mi">90</span> <span class="o">*</span> <span class="mi">86400</span><span class="p">)</span>  <span class="c1"># 90 days</span>
</span><span id="__span-3-74"><a id="__codelineno-3-74" name="__codelineno-3-74" href="#__codelineno-3-74"></a>
</span><span id="__span-3-75"><a id="__codelineno-3-75" name="__codelineno-3-75" href="#__codelineno-3-75"></a>        <span class="k">for</span> <span class="n">shard_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shard_count</span><span class="p">):</span>
</span><span id="__span-3-76"><a id="__codelineno-3-76" name="__codelineno-3-76" href="#__codelineno-3-76"></a>            <span class="n">old_urls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_old_urls</span><span class="p">(</span><span class="n">shard_id</span><span class="p">,</span> <span class="n">cutoff_time</span><span class="p">)</span>
</span><span id="__span-3-77"><a id="__codelineno-3-77" name="__codelineno-3-77" href="#__codelineno-3-77"></a>
</span><span id="__span-3-78"><a id="__codelineno-3-78" name="__codelineno-3-78" href="#__codelineno-3-78"></a>            <span class="k">for</span> <span class="n">url_data</span> <span class="ow">in</span> <span class="n">old_urls</span><span class="p">:</span>
</span><span id="__span-3-79"><a id="__codelineno-3-79" name="__codelineno-3-79" href="#__codelineno-3-79"></a>                <span class="c1"># Check access frequency</span>
</span><span id="__span-3-80"><a id="__codelineno-3-80" name="__codelineno-3-80" href="#__codelineno-3-80"></a>                <span class="k">if</span> <span class="n">url_data</span><span class="p">[</span><span class="s1">&#39;access_count&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># Rarely accessed</span>
</span><span id="__span-3-81"><a id="__codelineno-3-81" name="__codelineno-3-81" href="#__codelineno-3-81"></a>                    <span class="c1"># Move to cold storage</span>
</span><span id="__span-3-82"><a id="__codelineno-3-82" name="__codelineno-3-82" href="#__codelineno-3-82"></a>                    <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_move_to_cold</span><span class="p">(</span>
</span><span id="__span-3-83"><a id="__codelineno-3-83" name="__codelineno-3-83" href="#__codelineno-3-83"></a>                        <span class="n">url_data</span><span class="p">[</span><span class="s1">&#39;short_code&#39;</span><span class="p">],</span>
</span><span id="__span-3-84"><a id="__codelineno-3-84" name="__codelineno-3-84" href="#__codelineno-3-84"></a>                        <span class="n">url_data</span><span class="p">[</span><span class="s1">&#39;long_url&#39;</span><span class="p">],</span>
</span><span id="__span-3-85"><a id="__codelineno-3-85" name="__codelineno-3-85" href="#__codelineno-3-85"></a>                        <span class="n">url_data</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span>
</span><span id="__span-3-86"><a id="__codelineno-3-86" name="__codelineno-3-86" href="#__codelineno-3-86"></a>                    <span class="p">)</span>
</span><span id="__span-3-87"><a id="__codelineno-3-87" name="__codelineno-3-87" href="#__codelineno-3-87"></a>
</span><span id="__span-3-88"><a id="__codelineno-3-88" name="__codelineno-3-88" href="#__codelineno-3-88"></a>                    <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
</span><span id="__span-3-89"><a id="__codelineno-3-89" name="__codelineno-3-89" href="#__codelineno-3-89"></a>                        <span class="n">migrated_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-3-90"><a id="__codelineno-3-90" name="__codelineno-3-90" href="#__codelineno-3-90"></a>                        <span class="n">migrated_size</span> <span class="o">+=</span> <span class="n">url_data</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>
</span><span id="__span-3-91"><a id="__codelineno-3-91" name="__codelineno-3-91" href="#__codelineno-3-91"></a>
</span><span id="__span-3-92"><a id="__codelineno-3-92" name="__codelineno-3-92" href="#__codelineno-3-92"></a>                        <span class="c1"># Update tier tracking</span>
</span><span id="__span-3-93"><a id="__codelineno-3-93" name="__codelineno-3-93" href="#__codelineno-3-93"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">storage_tiers</span><span class="p">[</span><span class="s1">&#39;warm&#39;</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="n">url_data</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>
</span><span id="__span-3-94"><a id="__codelineno-3-94" name="__codelineno-3-94" href="#__codelineno-3-94"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">storage_tiers</span><span class="p">[</span><span class="s1">&#39;cold&#39;</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">url_data</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>
</span><span id="__span-3-95"><a id="__codelineno-3-95" name="__codelineno-3-95" href="#__codelineno-3-95"></a>
</span><span id="__span-3-96"><a id="__codelineno-3-96" name="__codelineno-3-96" href="#__codelineno-3-96"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-3-97"><a id="__codelineno-3-97" name="__codelineno-3-97" href="#__codelineno-3-97"></a>            <span class="s1">&#39;migrated_urls&#39;</span><span class="p">:</span> <span class="n">migrated_count</span><span class="p">,</span>
</span><span id="__span-3-98"><a id="__codelineno-3-98" name="__codelineno-3-98" href="#__codelineno-3-98"></a>            <span class="s1">&#39;space_freed_gb&#39;</span><span class="p">:</span> <span class="n">migrated_size</span> <span class="o">/</span> <span class="mi">1_000_000_000</span><span class="p">,</span>
</span><span id="__span-3-99"><a id="__codelineno-3-99" name="__codelineno-3-99" href="#__codelineno-3-99"></a>            <span class="s1">&#39;cost_savings_monthly&#39;</span><span class="p">:</span> <span class="n">migrated_size</span> <span class="o">*</span> <span class="mf">0.02</span> <span class="o">/</span> <span class="mi">1_000_000_000</span>  <span class="c1"># $0.02/GB</span>
</span><span id="__span-3-100"><a id="__codelineno-3-100" name="__codelineno-3-100" href="#__codelineno-3-100"></a>        <span class="p">}</span>
</span><span id="__span-3-101"><a id="__codelineno-3-101" name="__codelineno-3-101" href="#__codelineno-3-101"></a>
</span><span id="__span-3-102"><a id="__codelineno-3-102" name="__codelineno-3-102" href="#__codelineno-3-102"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_storage_costs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="__span-3-103"><a id="__codelineno-3-103" name="__codelineno-3-103" href="#__codelineno-3-103"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate current storage costs&quot;&quot;&quot;</span>
</span><span id="__span-3-104"><a id="__codelineno-3-104" name="__codelineno-3-104" href="#__codelineno-3-104"></a>        <span class="n">costs</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-3-105"><a id="__codelineno-3-105" name="__codelineno-3-105" href="#__codelineno-3-105"></a>            <span class="s1">&#39;hot&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_tiers</span><span class="p">[</span><span class="s1">&#39;hot&#39;</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.10</span> <span class="o">/</span> <span class="mi">1_000_000_000</span><span class="p">,</span>   <span class="c1"># $0.10/GB</span>
</span><span id="__span-3-106"><a id="__codelineno-3-106" name="__codelineno-3-106" href="#__codelineno-3-106"></a>            <span class="s1">&#39;warm&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_tiers</span><span class="p">[</span><span class="s1">&#39;warm&#39;</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.05</span> <span class="o">/</span> <span class="mi">1_000_000_000</span><span class="p">,</span>  <span class="c1"># $0.05/GB</span>
</span><span id="__span-3-107"><a id="__codelineno-3-107" name="__codelineno-3-107" href="#__codelineno-3-107"></a>            <span class="s1">&#39;cold&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_tiers</span><span class="p">[</span><span class="s1">&#39;cold&#39;</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.02</span> <span class="o">/</span> <span class="mi">1_000_000_000</span>   <span class="c1"># $0.02/GB</span>
</span><span id="__span-3-108"><a id="__codelineno-3-108" name="__codelineno-3-108" href="#__codelineno-3-108"></a>        <span class="p">}</span>
</span><span id="__span-3-109"><a id="__codelineno-3-109" name="__codelineno-3-109" href="#__codelineno-3-109"></a>
</span><span id="__span-3-110"><a id="__codelineno-3-110" name="__codelineno-3-110" href="#__codelineno-3-110"></a>        <span class="n">costs</span><span class="p">[</span><span class="s1">&#39;total_monthly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">costs</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="__span-3-111"><a id="__codelineno-3-111" name="__codelineno-3-111" href="#__codelineno-3-111"></a>        <span class="n">costs</span><span class="p">[</span><span class="s1">&#39;total_yearly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">costs</span><span class="p">[</span><span class="s1">&#39;total_monthly&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">12</span>
</span><span id="__span-3-112"><a id="__codelineno-3-112" name="__codelineno-3-112" href="#__codelineno-3-112"></a>
</span><span id="__span-3-113"><a id="__codelineno-3-113" name="__codelineno-3-113" href="#__codelineno-3-113"></a>        <span class="k">return</span> <span class="n">costs</span>
</span></code></pre></div></p>
<h4 id="axiom-3-failure-resilience-and-recovery">🔥 Axiom 3 (Failure): Resilience and Recovery<a class="headerlink" href="#axiom-3-failure-resilience-and-recovery" title="Permanent link">&para;</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>Failure Modes:
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>1. Database failures
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>2. Cache inconsistency
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>3. Short code collisions
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>4. Redirect loops
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>5. Malicious URLs
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>6. DDoS attacks
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>Mitigation Strategies:
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>- Multi-region deployment
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>- Cache fallback hierarchy
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>- Collision detection
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>- Loop detection
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>- URL blacklisting
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>- Rate limiting
</span></code></pre></div>
<p><strong>Implementation:</strong>
<div class="language-python highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">ResilientURLShortener</span><span class="p">:</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">regions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;us-east&#39;</span><span class="p">,</span> <span class="s1">&#39;us-west&#39;</span><span class="p">,</span> <span class="s1">&#39;eu-west&#39;</span><span class="p">,</span> <span class="s1">&#39;ap-south&#39;</span><span class="p">]</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">primary_region</span> <span class="o">=</span> <span class="s1">&#39;us-east&#39;</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>        <span class="c1"># Failure detection</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">circuit_breakers</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">health_checks</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>        <span class="c1"># Safety mechanisms</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">redirect_loop_detector</span> <span class="o">=</span> <span class="n">RedirectLoopDetector</span><span class="p">()</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">malware_scanner</span> <span class="o">=</span> <span class="n">MalwareScanner</span><span class="p">()</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rate_limiter</span> <span class="o">=</span> <span class="n">RateLimiter</span><span class="p">()</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>        <span class="c1"># Chaos engineering</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">chaos_enabled</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">failure_injection_rate</span> <span class="o">=</span> <span class="mf">0.001</span>  <span class="c1"># 0.1%</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">safe_redirect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">short_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">request_context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Redirect with comprehensive safety checks&quot;&quot;&quot;</span>
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>        <span class="c1"># Rate limiting</span>
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>        <span class="n">client_ip</span> <span class="o">=</span> <span class="n">request_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ip&#39;</span><span class="p">)</span>
</span><span id="__span-5-23"><a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_limiter</span><span class="o">.</span><span class="n">allow</span><span class="p">(</span><span class="n">client_ip</span><span class="p">):</span>
</span><span id="__span-5-24"><a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>            <span class="k">raise</span> <span class="n">RateLimitExceeded</span><span class="p">(</span><span class="s2">&quot;Too many requests&quot;</span><span class="p">)</span>
</span><span id="__span-5-25"><a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>
</span><span id="__span-5-26"><a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>        <span class="c1"># Get URL with fallback</span>
</span><span id="__span-5-27"><a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>        <span class="n">long_url</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_url_with_fallback</span><span class="p">(</span><span class="n">short_code</span><span class="p">)</span>
</span><span id="__span-5-28"><a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">long_url</span><span class="p">:</span>
</span><span id="__span-5-29"><a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="__span-5-30"><a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a>
</span><span id="__span-5-31"><a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a>        <span class="c1"># Safety checks</span>
</span><span id="__span-5-32"><a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a>        <span class="n">safety_checks</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
</span><span id="__span-5-33"><a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_check_redirect_loop</span><span class="p">(</span><span class="n">short_code</span><span class="p">,</span> <span class="n">long_url</span><span class="p">),</span>
</span><span id="__span-5-34"><a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_check_malware</span><span class="p">(</span><span class="n">long_url</span><span class="p">),</span>
</span><span id="__span-5-35"><a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_check_blacklist</span><span class="p">(</span><span class="n">long_url</span><span class="p">),</span>
</span><span id="__span-5-36"><a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a>            <span class="n">return_exceptions</span><span class="o">=</span><span class="kc">True</span>
</span><span id="__span-5-37"><a id="__codelineno-5-37" name="__codelineno-5-37" href="#__codelineno-5-37"></a>        <span class="p">)</span>
</span><span id="__span-5-38"><a id="__codelineno-5-38" name="__codelineno-5-38" href="#__codelineno-5-38"></a>
</span><span id="__span-5-39"><a id="__codelineno-5-39" name="__codelineno-5-39" href="#__codelineno-5-39"></a>        <span class="k">for</span> <span class="n">check</span> <span class="ow">in</span> <span class="n">safety_checks</span><span class="p">:</span>
</span><span id="__span-5-40"><a id="__codelineno-5-40" name="__codelineno-5-40" href="#__codelineno-5-40"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">check</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
</span><span id="__span-5-41"><a id="__codelineno-5-41" name="__codelineno-5-41" href="#__codelineno-5-41"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Safety check failed: </span><span class="si">{</span><span class="n">check</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-5-42"><a id="__codelineno-5-42" name="__codelineno-5-42" href="#__codelineno-5-42"></a>                <span class="k">raise</span> <span class="n">check</span>
</span><span id="__span-5-43"><a id="__codelineno-5-43" name="__codelineno-5-43" href="#__codelineno-5-43"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">check</span><span class="p">:</span>
</span><span id="__span-5-44"><a id="__codelineno-5-44" name="__codelineno-5-44" href="#__codelineno-5-44"></a>                <span class="k">raise</span> <span class="n">UnsafeURLError</span><span class="p">(</span><span class="s2">&quot;URL failed safety checks&quot;</span><span class="p">)</span>
</span><span id="__span-5-45"><a id="__codelineno-5-45" name="__codelineno-5-45" href="#__codelineno-5-45"></a>
</span><span id="__span-5-46"><a id="__codelineno-5-46" name="__codelineno-5-46" href="#__codelineno-5-46"></a>        <span class="c1"># Record successful redirect</span>
</span><span id="__span-5-47"><a id="__codelineno-5-47" name="__codelineno-5-47" href="#__codelineno-5-47"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record_redirect</span><span class="p">(</span><span class="n">short_code</span><span class="p">,</span> <span class="n">request_context</span><span class="p">)</span>
</span><span id="__span-5-48"><a id="__codelineno-5-48" name="__codelineno-5-48" href="#__codelineno-5-48"></a>
</span><span id="__span-5-49"><a id="__codelineno-5-49" name="__codelineno-5-49" href="#__codelineno-5-49"></a>        <span class="k">return</span> <span class="n">long_url</span>
</span><span id="__span-5-50"><a id="__codelineno-5-50" name="__codelineno-5-50" href="#__codelineno-5-50"></a>
</span><span id="__span-5-51"><a id="__codelineno-5-51" name="__codelineno-5-51" href="#__codelineno-5-51"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_get_url_with_fallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">short_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="__span-5-52"><a id="__codelineno-5-52" name="__codelineno-5-52" href="#__codelineno-5-52"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get URL with regional fallback&quot;&quot;&quot;</span>
</span><span id="__span-5-53"><a id="__codelineno-5-53" name="__codelineno-5-53" href="#__codelineno-5-53"></a>        <span class="c1"># Try primary region first</span>
</span><span id="__span-5-54"><a id="__codelineno-5-54" name="__codelineno-5-54" href="#__codelineno-5-54"></a>        <span class="n">primary_cb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_circuit_breaker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_region</span><span class="p">)</span>
</span><span id="__span-5-55"><a id="__codelineno-5-55" name="__codelineno-5-55" href="#__codelineno-5-55"></a>
</span><span id="__span-5-56"><a id="__codelineno-5-56" name="__codelineno-5-56" href="#__codelineno-5-56"></a>        <span class="k">if</span> <span class="n">primary_cb</span><span class="o">.</span><span class="n">is_open</span><span class="p">():</span>
</span><span id="__span-5-57"><a id="__codelineno-5-57" name="__codelineno-5-57" href="#__codelineno-5-57"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Primary region </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_region</span><span class="si">}</span><span class="s2"> circuit open&quot;</span><span class="p">)</span>
</span><span id="__span-5-58"><a id="__codelineno-5-58" name="__codelineno-5-58" href="#__codelineno-5-58"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-5-59"><a id="__codelineno-5-59" name="__codelineno-5-59" href="#__codelineno-5-59"></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="__span-5-60"><a id="__codelineno-5-60" name="__codelineno-5-60" href="#__codelineno-5-60"></a>                <span class="n">url</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_from_region</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_region</span><span class="p">,</span> <span class="n">short_code</span><span class="p">)</span>
</span><span id="__span-5-61"><a id="__codelineno-5-61" name="__codelineno-5-61" href="#__codelineno-5-61"></a>                <span class="k">if</span> <span class="n">url</span><span class="p">:</span>
</span><span id="__span-5-62"><a id="__codelineno-5-62" name="__codelineno-5-62" href="#__codelineno-5-62"></a>                    <span class="k">return</span> <span class="n">url</span>
</span><span id="__span-5-63"><a id="__codelineno-5-63" name="__codelineno-5-63" href="#__codelineno-5-63"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-5-64"><a id="__codelineno-5-64" name="__codelineno-5-64" href="#__codelineno-5-64"></a>                <span class="n">primary_cb</span><span class="o">.</span><span class="n">record_failure</span><span class="p">()</span>
</span><span id="__span-5-65"><a id="__codelineno-5-65" name="__codelineno-5-65" href="#__codelineno-5-65"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Primary region failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-5-66"><a id="__codelineno-5-66" name="__codelineno-5-66" href="#__codelineno-5-66"></a>
</span><span id="__span-5-67"><a id="__codelineno-5-67" name="__codelineno-5-67" href="#__codelineno-5-67"></a>        <span class="c1"># Try other regions</span>
</span><span id="__span-5-68"><a id="__codelineno-5-68" name="__codelineno-5-68" href="#__codelineno-5-68"></a>        <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">:</span>
</span><span id="__span-5-69"><a id="__codelineno-5-69" name="__codelineno-5-69" href="#__codelineno-5-69"></a>            <span class="k">if</span> <span class="n">region</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_region</span><span class="p">:</span>
</span><span id="__span-5-70"><a id="__codelineno-5-70" name="__codelineno-5-70" href="#__codelineno-5-70"></a>                <span class="k">continue</span>
</span><span id="__span-5-71"><a id="__codelineno-5-71" name="__codelineno-5-71" href="#__codelineno-5-71"></a>
</span><span id="__span-5-72"><a id="__codelineno-5-72" name="__codelineno-5-72" href="#__codelineno-5-72"></a>            <span class="n">cb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_circuit_breaker</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>
</span><span id="__span-5-73"><a id="__codelineno-5-73" name="__codelineno-5-73" href="#__codelineno-5-73"></a>            <span class="k">if</span> <span class="n">cb</span><span class="o">.</span><span class="n">is_open</span><span class="p">():</span>
</span><span id="__span-5-74"><a id="__codelineno-5-74" name="__codelineno-5-74" href="#__codelineno-5-74"></a>                <span class="k">continue</span>
</span><span id="__span-5-75"><a id="__codelineno-5-75" name="__codelineno-5-75" href="#__codelineno-5-75"></a>
</span><span id="__span-5-76"><a id="__codelineno-5-76" name="__codelineno-5-76" href="#__codelineno-5-76"></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="__span-5-77"><a id="__codelineno-5-77" name="__codelineno-5-77" href="#__codelineno-5-77"></a>                <span class="n">url</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_from_region</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">short_code</span><span class="p">)</span>
</span><span id="__span-5-78"><a id="__codelineno-5-78" name="__codelineno-5-78" href="#__codelineno-5-78"></a>                <span class="k">if</span> <span class="n">url</span><span class="p">:</span>
</span><span id="__span-5-79"><a id="__codelineno-5-79" name="__codelineno-5-79" href="#__codelineno-5-79"></a>                    <span class="c1"># Update primary cache asynchronously</span>
</span><span id="__span-5-80"><a id="__codelineno-5-80" name="__codelineno-5-80" href="#__codelineno-5-80"></a>                    <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span>
</span><span id="__span-5-81"><a id="__codelineno-5-81" name="__codelineno-5-81" href="#__codelineno-5-81"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_sync_to_primary</span><span class="p">(</span><span class="n">short_code</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
</span><span id="__span-5-82"><a id="__codelineno-5-82" name="__codelineno-5-82" href="#__codelineno-5-82"></a>                    <span class="p">)</span>
</span><span id="__span-5-83"><a id="__codelineno-5-83" name="__codelineno-5-83" href="#__codelineno-5-83"></a>                    <span class="k">return</span> <span class="n">url</span>
</span><span id="__span-5-84"><a id="__codelineno-5-84" name="__codelineno-5-84" href="#__codelineno-5-84"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-5-85"><a id="__codelineno-5-85" name="__codelineno-5-85" href="#__codelineno-5-85"></a>                <span class="n">cb</span><span class="o">.</span><span class="n">record_failure</span><span class="p">()</span>
</span><span id="__span-5-86"><a id="__codelineno-5-86" name="__codelineno-5-86" href="#__codelineno-5-86"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2"> failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-5-87"><a id="__codelineno-5-87" name="__codelineno-5-87" href="#__codelineno-5-87"></a>
</span><span id="__span-5-88"><a id="__codelineno-5-88" name="__codelineno-5-88" href="#__codelineno-5-88"></a>        <span class="k">return</span> <span class="kc">None</span>
</span><span id="__span-5-89"><a id="__codelineno-5-89" name="__codelineno-5-89" href="#__codelineno-5-89"></a>
</span><span id="__span-5-90"><a id="__codelineno-5-90" name="__codelineno-5-90" href="#__codelineno-5-90"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_circuit_breaker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CircuitBreaker</span><span class="p">:</span>
</span><span id="__span-5-91"><a id="__codelineno-5-91" name="__codelineno-5-91" href="#__codelineno-5-91"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get or create circuit breaker for region&quot;&quot;&quot;</span>
</span><span id="__span-5-92"><a id="__codelineno-5-92" name="__codelineno-5-92" href="#__codelineno-5-92"></a>        <span class="k">if</span> <span class="n">region</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">circuit_breakers</span><span class="p">:</span>
</span><span id="__span-5-93"><a id="__codelineno-5-93" name="__codelineno-5-93" href="#__codelineno-5-93"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">circuit_breakers</span><span class="p">[</span><span class="n">region</span><span class="p">]</span> <span class="o">=</span> <span class="n">CircuitBreaker</span><span class="p">(</span>
</span><span id="__span-5-94"><a id="__codelineno-5-94" name="__codelineno-5-94" href="#__codelineno-5-94"></a>                <span class="n">failure_threshold</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
</span><span id="__span-5-95"><a id="__codelineno-5-95" name="__codelineno-5-95" href="#__codelineno-5-95"></a>                <span class="n">recovery_timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
</span><span id="__span-5-96"><a id="__codelineno-5-96" name="__codelineno-5-96" href="#__codelineno-5-96"></a>                <span class="n">expected_exception</span><span class="o">=</span><span class="n">DatabaseError</span>
</span><span id="__span-5-97"><a id="__codelineno-5-97" name="__codelineno-5-97" href="#__codelineno-5-97"></a>            <span class="p">)</span>
</span><span id="__span-5-98"><a id="__codelineno-5-98" name="__codelineno-5-98" href="#__codelineno-5-98"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">circuit_breakers</span><span class="p">[</span><span class="n">region</span><span class="p">]</span>
</span><span id="__span-5-99"><a id="__codelineno-5-99" name="__codelineno-5-99" href="#__codelineno-5-99"></a>
</span><span id="__span-5-100"><a id="__codelineno-5-100" name="__codelineno-5-100" href="#__codelineno-5-100"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_check_redirect_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">short_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">long_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="__span-5-101"><a id="__codelineno-5-101" name="__codelineno-5-101" href="#__codelineno-5-101"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Detect redirect loops&quot;&quot;&quot;</span>
</span><span id="__span-5-102"><a id="__codelineno-5-102" name="__codelineno-5-102" href="#__codelineno-5-102"></a>        <span class="c1"># Check if long_url points back to our service</span>
</span><span id="__span-5-103"><a id="__codelineno-5-103" name="__codelineno-5-103" href="#__codelineno-5-103"></a>        <span class="k">if</span> <span class="s1">&#39;short.url&#39;</span> <span class="ow">in</span> <span class="n">long_url</span><span class="p">:</span>
</span><span id="__span-5-104"><a id="__codelineno-5-104" name="__codelineno-5-104" href="#__codelineno-5-104"></a>            <span class="c1"># Extract potential short code</span>
</span><span id="__span-5-105"><a id="__codelineno-5-105" name="__codelineno-5-105" href="#__codelineno-5-105"></a>            <span class="n">potential_code</span> <span class="o">=</span> <span class="n">long_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="__span-5-106"><a id="__codelineno-5-106" name="__codelineno-5-106" href="#__codelineno-5-106"></a>
</span><span id="__span-5-107"><a id="__codelineno-5-107" name="__codelineno-5-107" href="#__codelineno-5-107"></a>            <span class="c1"># Check for direct loop</span>
</span><span id="__span-5-108"><a id="__codelineno-5-108" name="__codelineno-5-108" href="#__codelineno-5-108"></a>            <span class="k">if</span> <span class="n">potential_code</span> <span class="o">==</span> <span class="n">short_code</span><span class="p">:</span>
</span><span id="__span-5-109"><a id="__codelineno-5-109" name="__codelineno-5-109" href="#__codelineno-5-109"></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-5-110"><a id="__codelineno-5-110" name="__codelineno-5-110" href="#__codelineno-5-110"></a>
</span><span id="__span-5-111"><a id="__codelineno-5-111" name="__codelineno-5-111" href="#__codelineno-5-111"></a>            <span class="c1"># Check for indirect loops (A-&gt;B-&gt;C-&gt;A)</span>
</span><span id="__span-5-112"><a id="__codelineno-5-112" name="__codelineno-5-112" href="#__codelineno-5-112"></a>            <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="__span-5-113"><a id="__codelineno-5-113" name="__codelineno-5-113" href="#__codelineno-5-113"></a>            <span class="n">current</span> <span class="o">=</span> <span class="n">potential_code</span>
</span><span id="__span-5-114"><a id="__codelineno-5-114" name="__codelineno-5-114" href="#__codelineno-5-114"></a>
</span><span id="__span-5-115"><a id="__codelineno-5-115" name="__codelineno-5-115" href="#__codelineno-5-115"></a>            <span class="k">while</span> <span class="n">current</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">visited</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
</span><span id="__span-5-116"><a id="__codelineno-5-116" name="__codelineno-5-116" href="#__codelineno-5-116"></a>                <span class="k">if</span> <span class="n">current</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
</span><span id="__span-5-117"><a id="__codelineno-5-117" name="__codelineno-5-117" href="#__codelineno-5-117"></a>                    <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># Loop detected</span>
</span><span id="__span-5-118"><a id="__codelineno-5-118" name="__codelineno-5-118" href="#__codelineno-5-118"></a>                <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
</span><span id="__span-5-119"><a id="__codelineno-5-119" name="__codelineno-5-119" href="#__codelineno-5-119"></a>
</span><span id="__span-5-120"><a id="__codelineno-5-120" name="__codelineno-5-120" href="#__codelineno-5-120"></a>                <span class="c1"># Get next URL in chain</span>
</span><span id="__span-5-121"><a id="__codelineno-5-121" name="__codelineno-5-121" href="#__codelineno-5-121"></a>                <span class="n">next_url</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_url_with_fallback</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
</span><span id="__span-5-122"><a id="__codelineno-5-122" name="__codelineno-5-122" href="#__codelineno-5-122"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">next_url</span> <span class="ow">or</span> <span class="s1">&#39;short.url&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">next_url</span><span class="p">:</span>
</span><span id="__span-5-123"><a id="__codelineno-5-123" name="__codelineno-5-123" href="#__codelineno-5-123"></a>                    <span class="k">break</span>
</span><span id="__span-5-124"><a id="__codelineno-5-124" name="__codelineno-5-124" href="#__codelineno-5-124"></a>
</span><span id="__span-5-125"><a id="__codelineno-5-125" name="__codelineno-5-125" href="#__codelineno-5-125"></a>                <span class="n">current</span> <span class="o">=</span> <span class="n">next_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="__span-5-126"><a id="__codelineno-5-126" name="__codelineno-5-126" href="#__codelineno-5-126"></a>
</span><span id="__span-5-127"><a id="__codelineno-5-127" name="__codelineno-5-127" href="#__codelineno-5-127"></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="__span-5-128"><a id="__codelineno-5-128" name="__codelineno-5-128" href="#__codelineno-5-128"></a>
</span><span id="__span-5-129"><a id="__codelineno-5-129" name="__codelineno-5-129" href="#__codelineno-5-129"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_check_malware</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="__span-5-130"><a id="__codelineno-5-130" name="__codelineno-5-130" href="#__codelineno-5-130"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check URL against malware databases&quot;&quot;&quot;</span>
</span><span id="__span-5-131"><a id="__codelineno-5-131" name="__codelineno-5-131" href="#__codelineno-5-131"></a>        <span class="c1"># Fast bloom filter check first</span>
</span><span id="__span-5-132"><a id="__codelineno-5-132" name="__codelineno-5-132" href="#__codelineno-5-132"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">malware_scanner</span><span class="o">.</span><span class="n">is_known_safe</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
</span><span id="__span-5-133"><a id="__codelineno-5-133" name="__codelineno-5-133" href="#__codelineno-5-133"></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="__span-5-134"><a id="__codelineno-5-134" name="__codelineno-5-134" href="#__codelineno-5-134"></a>
</span><span id="__span-5-135"><a id="__codelineno-5-135" name="__codelineno-5-135" href="#__codelineno-5-135"></a>        <span class="c1"># Check against Google Safe Browsing API</span>
</span><span id="__span-5-136"><a id="__codelineno-5-136" name="__codelineno-5-136" href="#__codelineno-5-136"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-5-137"><a id="__codelineno-5-137" name="__codelineno-5-137" href="#__codelineno-5-137"></a>            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">malware_scanner</span><span class="o">.</span><span class="n">check_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span id="__span-5-138"><a id="__codelineno-5-138" name="__codelineno-5-138" href="#__codelineno-5-138"></a>            <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">is_safe</span>
</span><span id="__span-5-139"><a id="__codelineno-5-139" name="__codelineno-5-139" href="#__codelineno-5-139"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-5-140"><a id="__codelineno-5-140" name="__codelineno-5-140" href="#__codelineno-5-140"></a>            <span class="c1"># Fail open for availability</span>
</span><span id="__span-5-141"><a id="__codelineno-5-141" name="__codelineno-5-141" href="#__codelineno-5-141"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Malware check failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-5-142"><a id="__codelineno-5-142" name="__codelineno-5-142" href="#__codelineno-5-142"></a>            <span class="n">metrics</span><span class="o">.</span><span class="n">increment</span><span class="p">(</span><span class="s1">&#39;malware_check_failures&#39;</span><span class="p">)</span>
</span><span id="__span-5-143"><a id="__codelineno-5-143" name="__codelineno-5-143" href="#__codelineno-5-143"></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="__span-5-144"><a id="__codelineno-5-144" name="__codelineno-5-144" href="#__codelineno-5-144"></a>
</span><span id="__span-5-145"><a id="__codelineno-5-145" name="__codelineno-5-145" href="#__codelineno-5-145"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">handle_collision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">short_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">long_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-5-146"><a id="__codelineno-5-146" name="__codelineno-5-146" href="#__codelineno-5-146"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle short code collisions&quot;&quot;&quot;</span>
</span><span id="__span-5-147"><a id="__codelineno-5-147" name="__codelineno-5-147" href="#__codelineno-5-147"></a>        <span class="c1"># Check if collision is real or hash collision</span>
</span><span id="__span-5-148"><a id="__codelineno-5-148" name="__codelineno-5-148" href="#__codelineno-5-148"></a>        <span class="n">existing_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_existing_url</span><span class="p">(</span><span class="n">short_code</span><span class="p">)</span>
</span><span id="__span-5-149"><a id="__codelineno-5-149" name="__codelineno-5-149" href="#__codelineno-5-149"></a>
</span><span id="__span-5-150"><a id="__codelineno-5-150" name="__codelineno-5-150" href="#__codelineno-5-150"></a>        <span class="k">if</span> <span class="n">existing_url</span> <span class="o">==</span> <span class="n">long_url</span><span class="p">:</span>
</span><span id="__span-5-151"><a id="__codelineno-5-151" name="__codelineno-5-151" href="#__codelineno-5-151"></a>            <span class="c1"># Same URL, return existing code</span>
</span><span id="__span-5-152"><a id="__codelineno-5-152" name="__codelineno-5-152" href="#__codelineno-5-152"></a>            <span class="k">return</span> <span class="n">short_code</span>
</span><span id="__span-5-153"><a id="__codelineno-5-153" name="__codelineno-5-153" href="#__codelineno-5-153"></a>
</span><span id="__span-5-154"><a id="__codelineno-5-154" name="__codelineno-5-154" href="#__codelineno-5-154"></a>        <span class="c1"># Real collision - generate alternative</span>
</span><span id="__span-5-155"><a id="__codelineno-5-155" name="__codelineno-5-155" href="#__codelineno-5-155"></a>        <span class="n">attempt</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-5-156"><a id="__codelineno-5-156" name="__codelineno-5-156" href="#__codelineno-5-156"></a>        <span class="k">while</span> <span class="n">attempt</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
</span><span id="__span-5-157"><a id="__codelineno-5-157" name="__codelineno-5-157" href="#__codelineno-5-157"></a>            <span class="c1"># Add suffix to make unique</span>
</span><span id="__span-5-158"><a id="__codelineno-5-158" name="__codelineno-5-158" href="#__codelineno-5-158"></a>            <span class="n">new_code</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">short_code</span><span class="si">}{</span><span class="n">attempt</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-5-159"><a id="__codelineno-5-159" name="__codelineno-5-159" href="#__codelineno-5-159"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exists</span><span class="p">(</span><span class="n">new_code</span><span class="p">):</span>
</span><span id="__span-5-160"><a id="__codelineno-5-160" name="__codelineno-5-160" href="#__codelineno-5-160"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Collision resolved: </span><span class="si">{</span><span class="n">short_code</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">new_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-5-161"><a id="__codelineno-5-161" name="__codelineno-5-161" href="#__codelineno-5-161"></a>                <span class="n">metrics</span><span class="o">.</span><span class="n">increment</span><span class="p">(</span><span class="s1">&#39;collisions_resolved&#39;</span><span class="p">)</span>
</span><span id="__span-5-162"><a id="__codelineno-5-162" name="__codelineno-5-162" href="#__codelineno-5-162"></a>                <span class="k">return</span> <span class="n">new_code</span>
</span><span id="__span-5-163"><a id="__codelineno-5-163" name="__codelineno-5-163" href="#__codelineno-5-163"></a>            <span class="n">attempt</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-5-164"><a id="__codelineno-5-164" name="__codelineno-5-164" href="#__codelineno-5-164"></a>
</span><span id="__span-5-165"><a id="__codelineno-5-165" name="__codelineno-5-165" href="#__codelineno-5-165"></a>        <span class="c1"># Fall back to completely new code</span>
</span><span id="__span-5-166"><a id="__codelineno-5-166" name="__codelineno-5-166" href="#__codelineno-5-166"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_new_code</span><span class="p">()</span>
</span><span id="__span-5-167"><a id="__codelineno-5-167" name="__codelineno-5-167" href="#__codelineno-5-167"></a>
</span><span id="__span-5-168"><a id="__codelineno-5-168" name="__codelineno-5-168" href="#__codelineno-5-168"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">disaster_recovery</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">failed_region</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-5-169"><a id="__codelineno-5-169" name="__codelineno-5-169" href="#__codelineno-5-169"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Automated disaster recovery procedure&quot;&quot;&quot;</span>
</span><span id="__span-5-170"><a id="__codelineno-5-170" name="__codelineno-5-170" href="#__codelineno-5-170"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initiating disaster recovery for </span><span class="si">{</span><span class="n">failed_region</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-5-171"><a id="__codelineno-5-171" name="__codelineno-5-171" href="#__codelineno-5-171"></a>
</span><span id="__span-5-172"><a id="__codelineno-5-172" name="__codelineno-5-172" href="#__codelineno-5-172"></a>        <span class="c1"># Step 1: Verify region is actually down</span>
</span><span id="__span-5-173"><a id="__codelineno-5-173" name="__codelineno-5-173" href="#__codelineno-5-173"></a>        <span class="k">if</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_region_failure</span><span class="p">(</span><span class="n">failed_region</span><span class="p">):</span>
</span><span id="__span-5-174"><a id="__codelineno-5-174" name="__codelineno-5-174" href="#__codelineno-5-174"></a>
</span><span id="__span-5-175"><a id="__codelineno-5-175" name="__codelineno-5-175" href="#__codelineno-5-175"></a>            <span class="c1"># Step 2: Promote secondary region</span>
</span><span id="__span-5-176"><a id="__codelineno-5-176" name="__codelineno-5-176" href="#__codelineno-5-176"></a>            <span class="n">new_primary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_new_primary</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="n">failed_region</span><span class="p">)</span>
</span><span id="__span-5-177"><a id="__codelineno-5-177" name="__codelineno-5-177" href="#__codelineno-5-177"></a>            <span class="n">old_primary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_region</span>
</span><span id="__span-5-178"><a id="__codelineno-5-178" name="__codelineno-5-178" href="#__codelineno-5-178"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">primary_region</span> <span class="o">=</span> <span class="n">new_primary</span>
</span><span id="__span-5-179"><a id="__codelineno-5-179" name="__codelineno-5-179" href="#__codelineno-5-179"></a>
</span><span id="__span-5-180"><a id="__codelineno-5-180" name="__codelineno-5-180" href="#__codelineno-5-180"></a>            <span class="c1"># Step 3: Update DNS</span>
</span><span id="__span-5-181"><a id="__codelineno-5-181" name="__codelineno-5-181" href="#__codelineno-5-181"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_dns_records</span><span class="p">(</span><span class="n">new_primary</span><span class="p">)</span>
</span><span id="__span-5-182"><a id="__codelineno-5-182" name="__codelineno-5-182" href="#__codelineno-5-182"></a>
</span><span id="__span-5-183"><a id="__codelineno-5-183" name="__codelineno-5-183" href="#__codelineno-5-183"></a>            <span class="c1"># Step 4: Sync data</span>
</span><span id="__span-5-184"><a id="__codelineno-5-184" name="__codelineno-5-184" href="#__codelineno-5-184"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emergency_data_sync</span><span class="p">(</span><span class="n">failed_region</span><span class="p">,</span> <span class="n">new_primary</span><span class="p">)</span>
</span><span id="__span-5-185"><a id="__codelineno-5-185" name="__codelineno-5-185" href="#__codelineno-5-185"></a>
</span><span id="__span-5-186"><a id="__codelineno-5-186" name="__codelineno-5-186" href="#__codelineno-5-186"></a>            <span class="c1"># Step 5: Notify</span>
</span><span id="__span-5-187"><a id="__codelineno-5-187" name="__codelineno-5-187" href="#__codelineno-5-187"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_alerts</span><span class="p">({</span>
</span><span id="__span-5-188"><a id="__codelineno-5-188" name="__codelineno-5-188" href="#__codelineno-5-188"></a>                <span class="s1">&#39;event&#39;</span><span class="p">:</span> <span class="s1">&#39;region_failover&#39;</span><span class="p">,</span>
</span><span id="__span-5-189"><a id="__codelineno-5-189" name="__codelineno-5-189" href="#__codelineno-5-189"></a>                <span class="s1">&#39;failed_region&#39;</span><span class="p">:</span> <span class="n">failed_region</span><span class="p">,</span>
</span><span id="__span-5-190"><a id="__codelineno-5-190" name="__codelineno-5-190" href="#__codelineno-5-190"></a>                <span class="s1">&#39;new_primary&#39;</span><span class="p">:</span> <span class="n">new_primary</span><span class="p">,</span>
</span><span id="__span-5-191"><a id="__codelineno-5-191" name="__codelineno-5-191" href="#__codelineno-5-191"></a>                <span class="s1">&#39;old_primary&#39;</span><span class="p">:</span> <span class="n">old_primary</span><span class="p">,</span>
</span><span id="__span-5-192"><a id="__codelineno-5-192" name="__codelineno-5-192" href="#__codelineno-5-192"></a>                <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="__span-5-193"><a id="__codelineno-5-193" name="__codelineno-5-193" href="#__codelineno-5-193"></a>            <span class="p">})</span>
</span><span id="__span-5-194"><a id="__codelineno-5-194" name="__codelineno-5-194" href="#__codelineno-5-194"></a>
</span><span id="__span-5-195"><a id="__codelineno-5-195" name="__codelineno-5-195" href="#__codelineno-5-195"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Disaster recovery complete. New primary: </span><span class="si">{</span><span class="n">new_primary</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></div></p>
<h4 id="axiom-4-concurrency-parallel-processing">🔀 Axiom 4 (Concurrency): Parallel Processing<a class="headerlink" href="#axiom-4-concurrency-parallel-processing" title="Permanent link">&para;</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>Concurrency Challenges:
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>- Simultaneous URL shortening
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>- Parallel analytics updates
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>- Concurrent cache updates
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>- Race conditions in counting
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>- Distributed locking
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>Solutions:
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>- Optimistic locking
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>- Event-driven analytics
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>- Eventually consistent counters
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>- Lock-free data structures
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>- Partition-based parallelism
</span></code></pre></div>
<p><strong>Implementation:</strong>
<div class="language-python highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ThreadPoolExecutor</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">aioredis</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">ConcurrentURLShortener</span><span class="p">:</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>        <span class="c1"># Thread pool for CPU-bound tasks</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">executor</span> <span class="o">=</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>        <span class="c1"># Async connection pools</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">redis_pool</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">db_pool</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>        <span class="c1"># Lock-free counters</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">counters</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;clicks&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;lock&#39;</span><span class="p">:</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()})</span>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>        <span class="c1"># Batch processing</span>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_queue</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_processor_task</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-7-22"><a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a>
</span><span id="__span-7-23"><a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>        <span class="c1"># Sharding for parallelism</span>
</span><span id="__span-7-24"><a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shard_count</span> <span class="o">=</span> <span class="mi">100</span>
</span><span id="__span-7-25"><a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shard_locks</span> <span class="o">=</span> <span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shard_count</span><span class="p">)]</span>
</span><span id="__span-7-26"><a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a>
</span><span id="__span-7-27"><a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-7-28"><a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize connection pools and workers&quot;&quot;&quot;</span>
</span><span id="__span-7-29"><a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a>        <span class="c1"># Redis connection pool</span>
</span><span id="__span-7-30"><a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">redis_pool</span> <span class="o">=</span> <span class="k">await</span> <span class="n">aioredis</span><span class="o">.</span><span class="n">create_redis_pool</span><span class="p">(</span>
</span><span id="__span-7-31"><a id="__codelineno-7-31" name="__codelineno-7-31" href="#__codelineno-7-31"></a>            <span class="s1">&#39;redis://localhost&#39;</span><span class="p">,</span>
</span><span id="__span-7-32"><a id="__codelineno-7-32" name="__codelineno-7-32" href="#__codelineno-7-32"></a>            <span class="n">minsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="__span-7-33"><a id="__codelineno-7-33" name="__codelineno-7-33" href="#__codelineno-7-33"></a>            <span class="n">maxsize</span><span class="o">=</span><span class="mi">100</span>
</span><span id="__span-7-34"><a id="__codelineno-7-34" name="__codelineno-7-34" href="#__codelineno-7-34"></a>        <span class="p">)</span>
</span><span id="__span-7-35"><a id="__codelineno-7-35" name="__codelineno-7-35" href="#__codelineno-7-35"></a>
</span><span id="__span-7-36"><a id="__codelineno-7-36" name="__codelineno-7-36" href="#__codelineno-7-36"></a>        <span class="c1"># Start batch processor</span>
</span><span id="__span-7-37"><a id="__codelineno-7-37" name="__codelineno-7-37" href="#__codelineno-7-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_processor_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_batch_processor</span><span class="p">())</span>
</span><span id="__span-7-38"><a id="__codelineno-7-38" name="__codelineno-7-38" href="#__codelineno-7-38"></a>
</span><span id="__span-7-39"><a id="__codelineno-7-39" name="__codelineno-7-39" href="#__codelineno-7-39"></a>        <span class="c1"># Start analytics aggregators</span>
</span><span id="__span-7-40"><a id="__codelineno-7-40" name="__codelineno-7-40" href="#__codelineno-7-40"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>  <span class="c1"># 4 parallel aggregators</span>
</span><span id="__span-7-41"><a id="__codelineno-7-41" name="__codelineno-7-41" href="#__codelineno-7-41"></a>            <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_analytics_aggregator</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
</span><span id="__span-7-42"><a id="__codelineno-7-42" name="__codelineno-7-42" href="#__codelineno-7-42"></a>
</span><span id="__span-7-43"><a id="__codelineno-7-43" name="__codelineno-7-43" href="#__codelineno-7-43"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">shorten_concurrent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">urls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="__span-7-44"><a id="__codelineno-7-44" name="__codelineno-7-44" href="#__codelineno-7-44"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Shorten multiple URLs concurrently&quot;&quot;&quot;</span>
</span><span id="__span-7-45"><a id="__codelineno-7-45" name="__codelineno-7-45" href="#__codelineno-7-45"></a>        <span class="c1"># Prepare tasks</span>
</span><span id="__span-7-46"><a id="__codelineno-7-46" name="__codelineno-7-46" href="#__codelineno-7-46"></a>        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-7-47"><a id="__codelineno-7-47" name="__codelineno-7-47" href="#__codelineno-7-47"></a>        <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
</span><span id="__span-7-48"><a id="__codelineno-7-48" name="__codelineno-7-48" href="#__codelineno-7-48"></a>            <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shorten_single</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span id="__span-7-49"><a id="__codelineno-7-49" name="__codelineno-7-49" href="#__codelineno-7-49"></a>            <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
</span><span id="__span-7-50"><a id="__codelineno-7-50" name="__codelineno-7-50" href="#__codelineno-7-50"></a>
</span><span id="__span-7-51"><a id="__codelineno-7-51" name="__codelineno-7-51" href="#__codelineno-7-51"></a>        <span class="c1"># Execute concurrently with semaphore to limit parallelism</span>
</span><span id="__span-7-52"><a id="__codelineno-7-52" name="__codelineno-7-52" href="#__codelineno-7-52"></a>        <span class="n">semaphore</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>  <span class="c1"># Max 100 concurrent</span>
</span><span id="__span-7-53"><a id="__codelineno-7-53" name="__codelineno-7-53" href="#__codelineno-7-53"></a>
</span><span id="__span-7-54"><a id="__codelineno-7-54" name="__codelineno-7-54" href="#__codelineno-7-54"></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">bounded_shorten</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
</span><span id="__span-7-55"><a id="__codelineno-7-55" name="__codelineno-7-55" href="#__codelineno-7-55"></a>            <span class="k">async</span> <span class="k">with</span> <span class="n">semaphore</span><span class="p">:</span>
</span><span id="__span-7-56"><a id="__codelineno-7-56" name="__codelineno-7-56" href="#__codelineno-7-56"></a>                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shorten_single</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span id="__span-7-57"><a id="__codelineno-7-57" name="__codelineno-7-57" href="#__codelineno-7-57"></a>
</span><span id="__span-7-58"><a id="__codelineno-7-58" name="__codelineno-7-58" href="#__codelineno-7-58"></a>        <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
</span><span id="__span-7-59"><a id="__codelineno-7-59" name="__codelineno-7-59" href="#__codelineno-7-59"></a>            <span class="o">*</span><span class="p">[</span><span class="n">bounded_shorten</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">],</span>
</span><span id="__span-7-60"><a id="__codelineno-7-60" name="__codelineno-7-60" href="#__codelineno-7-60"></a>            <span class="n">return_exceptions</span><span class="o">=</span><span class="kc">True</span>
</span><span id="__span-7-61"><a id="__codelineno-7-61" name="__codelineno-7-61" href="#__codelineno-7-61"></a>        <span class="p">)</span>
</span><span id="__span-7-62"><a id="__codelineno-7-62" name="__codelineno-7-62" href="#__codelineno-7-62"></a>
</span><span id="__span-7-63"><a id="__codelineno-7-63" name="__codelineno-7-63" href="#__codelineno-7-63"></a>        <span class="c1"># Process results</span>
</span><span id="__span-7-64"><a id="__codelineno-7-64" name="__codelineno-7-64" href="#__codelineno-7-64"></a>        <span class="n">short_urls</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-7-65"><a id="__codelineno-7-65" name="__codelineno-7-65" href="#__codelineno-7-65"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
</span><span id="__span-7-66"><a id="__codelineno-7-66" name="__codelineno-7-66" href="#__codelineno-7-66"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
</span><span id="__span-7-67"><a id="__codelineno-7-67" name="__codelineno-7-67" href="#__codelineno-7-67"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to shorten </span><span class="si">{</span><span class="n">urls</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-7-68"><a id="__codelineno-7-68" name="__codelineno-7-68" href="#__codelineno-7-68"></a>                <span class="n">short_urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span><span id="__span-7-69"><a id="__codelineno-7-69" name="__codelineno-7-69" href="#__codelineno-7-69"></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="__span-7-70"><a id="__codelineno-7-70" name="__codelineno-7-70" href="#__codelineno-7-70"></a>                <span class="n">short_urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span id="__span-7-71"><a id="__codelineno-7-71" name="__codelineno-7-71" href="#__codelineno-7-71"></a>
</span><span id="__span-7-72"><a id="__codelineno-7-72" name="__codelineno-7-72" href="#__codelineno-7-72"></a>        <span class="k">return</span> <span class="n">short_urls</span>
</span><span id="__span-7-73"><a id="__codelineno-7-73" name="__codelineno-7-73" href="#__codelineno-7-73"></a>
</span><span id="__span-7-74"><a id="__codelineno-7-74" name="__codelineno-7-74" href="#__codelineno-7-74"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_shorten_single</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">long_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-7-75"><a id="__codelineno-7-75" name="__codelineno-7-75" href="#__codelineno-7-75"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Shorten single URL with proper concurrency control&quot;&quot;&quot;</span>
</span><span id="__span-7-76"><a id="__codelineno-7-76" name="__codelineno-7-76" href="#__codelineno-7-76"></a>        <span class="c1"># Hash-based sharding</span>
</span><span id="__span-7-77"><a id="__codelineno-7-77" name="__codelineno-7-77" href="#__codelineno-7-77"></a>        <span class="n">shard_id</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">long_url</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">shard_count</span>
</span><span id="__span-7-78"><a id="__codelineno-7-78" name="__codelineno-7-78" href="#__codelineno-7-78"></a>
</span><span id="__span-7-79"><a id="__codelineno-7-79" name="__codelineno-7-79" href="#__codelineno-7-79"></a>        <span class="c1"># Use shard-specific lock to reduce contention</span>
</span><span id="__span-7-80"><a id="__codelineno-7-80" name="__codelineno-7-80" href="#__codelineno-7-80"></a>        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">shard_locks</span><span class="p">[</span><span class="n">shard_id</span><span class="p">]:</span>
</span><span id="__span-7-81"><a id="__codelineno-7-81" name="__codelineno-7-81" href="#__codelineno-7-81"></a>            <span class="c1"># Check if already exists (deduplication)</span>
</span><span id="__span-7-82"><a id="__codelineno-7-82" name="__codelineno-7-82" href="#__codelineno-7-82"></a>            <span class="n">existing</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_existing</span><span class="p">(</span><span class="n">long_url</span><span class="p">)</span>
</span><span id="__span-7-83"><a id="__codelineno-7-83" name="__codelineno-7-83" href="#__codelineno-7-83"></a>            <span class="k">if</span> <span class="n">existing</span><span class="p">:</span>
</span><span id="__span-7-84"><a id="__codelineno-7-84" name="__codelineno-7-84" href="#__codelineno-7-84"></a>                <span class="k">return</span> <span class="n">existing</span>
</span><span id="__span-7-85"><a id="__codelineno-7-85" name="__codelineno-7-85" href="#__codelineno-7-85"></a>
</span><span id="__span-7-86"><a id="__codelineno-7-86" name="__codelineno-7-86" href="#__codelineno-7-86"></a>            <span class="c1"># Generate short code in thread pool (CPU-bound)</span>
</span><span id="__span-7-87"><a id="__codelineno-7-87" name="__codelineno-7-87" href="#__codelineno-7-87"></a>            <span class="n">short_code</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span>
</span><span id="__span-7-88"><a id="__codelineno-7-88" name="__codelineno-7-88" href="#__codelineno-7-88"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="p">,</span>
</span><span id="__span-7-89"><a id="__codelineno-7-89" name="__codelineno-7-89" href="#__codelineno-7-89"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_generate_short_code_cpu_bound</span><span class="p">,</span>
</span><span id="__span-7-90"><a id="__codelineno-7-90" name="__codelineno-7-90" href="#__codelineno-7-90"></a>                <span class="n">long_url</span>
</span><span id="__span-7-91"><a id="__codelineno-7-91" name="__codelineno-7-91" href="#__codelineno-7-91"></a>            <span class="p">)</span>
</span><span id="__span-7-92"><a id="__codelineno-7-92" name="__codelineno-7-92" href="#__codelineno-7-92"></a>
</span><span id="__span-7-93"><a id="__codelineno-7-93" name="__codelineno-7-93" href="#__codelineno-7-93"></a>            <span class="c1"># Store with optimistic locking</span>
</span><span id="__span-7-94"><a id="__codelineno-7-94" name="__codelineno-7-94" href="#__codelineno-7-94"></a>            <span class="n">stored</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-7-95"><a id="__codelineno-7-95" name="__codelineno-7-95" href="#__codelineno-7-95"></a>            <span class="n">attempts</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-7-96"><a id="__codelineno-7-96" name="__codelineno-7-96" href="#__codelineno-7-96"></a>
</span><span id="__span-7-97"><a id="__codelineno-7-97" name="__codelineno-7-97" href="#__codelineno-7-97"></a>            <span class="k">while</span> <span class="ow">not</span> <span class="n">stored</span> <span class="ow">and</span> <span class="n">attempts</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="__span-7-98"><a id="__codelineno-7-98" name="__codelineno-7-98" href="#__codelineno-7-98"></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="__span-7-99"><a id="__codelineno-7-99" name="__codelineno-7-99" href="#__codelineno-7-99"></a>                    <span class="n">stored</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store_url_optimistic</span><span class="p">(</span>
</span><span id="__span-7-100"><a id="__codelineno-7-100" name="__codelineno-7-100" href="#__codelineno-7-100"></a>                        <span class="n">short_code</span><span class="p">,</span> 
</span><span id="__span-7-101"><a id="__codelineno-7-101" name="__codelineno-7-101" href="#__codelineno-7-101"></a>                        <span class="n">long_url</span><span class="p">,</span>
</span><span id="__span-7-102"><a id="__codelineno-7-102" name="__codelineno-7-102" href="#__codelineno-7-102"></a>                        <span class="n">shard_id</span>
</span><span id="__span-7-103"><a id="__codelineno-7-103" name="__codelineno-7-103" href="#__codelineno-7-103"></a>                    <span class="p">)</span>
</span><span id="__span-7-104"><a id="__codelineno-7-104" name="__codelineno-7-104" href="#__codelineno-7-104"></a>                <span class="k">except</span> <span class="n">OptimisticLockError</span><span class="p">:</span>
</span><span id="__span-7-105"><a id="__codelineno-7-105" name="__codelineno-7-105" href="#__codelineno-7-105"></a>                    <span class="n">attempts</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-7-106"><a id="__codelineno-7-106" name="__codelineno-7-106" href="#__codelineno-7-106"></a>                    <span class="c1"># Regenerate code on collision</span>
</span><span id="__span-7-107"><a id="__codelineno-7-107" name="__codelineno-7-107" href="#__codelineno-7-107"></a>                    <span class="n">short_code</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span>
</span><span id="__span-7-108"><a id="__codelineno-7-108" name="__codelineno-7-108" href="#__codelineno-7-108"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="p">,</span>
</span><span id="__span-7-109"><a id="__codelineno-7-109" name="__codelineno-7-109" href="#__codelineno-7-109"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_generate_short_code_cpu_bound</span><span class="p">,</span>
</span><span id="__span-7-110"><a id="__codelineno-7-110" name="__codelineno-7-110" href="#__codelineno-7-110"></a>                        <span class="n">long_url</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">attempts</span><span class="p">)</span>
</span><span id="__span-7-111"><a id="__codelineno-7-111" name="__codelineno-7-111" href="#__codelineno-7-111"></a>                    <span class="p">)</span>
</span><span id="__span-7-112"><a id="__codelineno-7-112" name="__codelineno-7-112" href="#__codelineno-7-112"></a>
</span><span id="__span-7-113"><a id="__codelineno-7-113" name="__codelineno-7-113" href="#__codelineno-7-113"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">stored</span><span class="p">:</span>
</span><span id="__span-7-114"><a id="__codelineno-7-114" name="__codelineno-7-114" href="#__codelineno-7-114"></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to store URL after retries&quot;</span><span class="p">)</span>
</span><span id="__span-7-115"><a id="__codelineno-7-115" name="__codelineno-7-115" href="#__codelineno-7-115"></a>
</span><span id="__span-7-116"><a id="__codelineno-7-116" name="__codelineno-7-116" href="#__codelineno-7-116"></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;https://short.url/</span><span class="si">{</span><span class="n">short_code</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-7-117"><a id="__codelineno-7-117" name="__codelineno-7-117" href="#__codelineno-7-117"></a>
</span><span id="__span-7-118"><a id="__codelineno-7-118" name="__codelineno-7-118" href="#__codelineno-7-118"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_short_code_cpu_bound</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">long_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-7-119"><a id="__codelineno-7-119" name="__codelineno-7-119" href="#__codelineno-7-119"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;CPU-intensive short code generation&quot;&quot;&quot;</span>
</span><span id="__span-7-120"><a id="__codelineno-7-120" name="__codelineno-7-120" href="#__codelineno-7-120"></a>        <span class="c1"># Try multiple hash functions for better distribution</span>
</span><span id="__span-7-121"><a id="__codelineno-7-121" name="__codelineno-7-121" href="#__codelineno-7-121"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">hash_func</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">,</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">,</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">]):</span>
</span><span id="__span-7-122"><a id="__codelineno-7-122" name="__codelineno-7-122" href="#__codelineno-7-122"></a>            <span class="c1"># Add salt for uniqueness</span>
</span><span id="__span-7-123"><a id="__codelineno-7-123" name="__codelineno-7-123" href="#__codelineno-7-123"></a>            <span class="n">salted</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">long_url</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time_ns</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-7-124"><a id="__codelineno-7-124" name="__codelineno-7-124" href="#__codelineno-7-124"></a>            <span class="n">hash_bytes</span> <span class="o">=</span> <span class="n">hash_func</span><span class="p">(</span><span class="n">salted</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
</span><span id="__span-7-125"><a id="__codelineno-7-125" name="__codelineno-7-125" href="#__codelineno-7-125"></a>
</span><span id="__span-7-126"><a id="__codelineno-7-126" name="__codelineno-7-126" href="#__codelineno-7-126"></a>            <span class="c1"># Take first 6 bytes and encode</span>
</span><span id="__span-7-127"><a id="__codelineno-7-127" name="__codelineno-7-127" href="#__codelineno-7-127"></a>            <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base62_encode</span><span class="p">(</span><span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">hash_bytes</span><span class="p">[:</span><span class="mi">6</span><span class="p">],</span> <span class="s1">&#39;big&#39;</span><span class="p">))</span>
</span><span id="__span-7-128"><a id="__codelineno-7-128" name="__codelineno-7-128" href="#__codelineno-7-128"></a>
</span><span id="__span-7-129"><a id="__codelineno-7-129" name="__codelineno-7-129" href="#__codelineno-7-129"></a>            <span class="c1"># Ensure minimum length</span>
</span><span id="__span-7-130"><a id="__codelineno-7-130" name="__codelineno-7-130" href="#__codelineno-7-130"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">:</span>
</span><span id="__span-7-131"><a id="__codelineno-7-131" name="__codelineno-7-131" href="#__codelineno-7-131"></a>                <span class="k">return</span> <span class="n">code</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span>  <span class="c1"># Trim to 7 chars</span>
</span><span id="__span-7-132"><a id="__codelineno-7-132" name="__codelineno-7-132" href="#__codelineno-7-132"></a>
</span><span id="__span-7-133"><a id="__codelineno-7-133" name="__codelineno-7-133" href="#__codelineno-7-133"></a>        <span class="c1"># Fallback to random</span>
</span><span id="__span-7-134"><a id="__codelineno-7-134" name="__codelineno-7-134" href="#__codelineno-7-134"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_random_code</span><span class="p">()</span>
</span><span id="__span-7-135"><a id="__codelineno-7-135" name="__codelineno-7-135" href="#__codelineno-7-135"></a>
</span><span id="__span-7-136"><a id="__codelineno-7-136" name="__codelineno-7-136" href="#__codelineno-7-136"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_analytics_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]):</span>
</span><span id="__span-7-137"><a id="__codelineno-7-137" name="__codelineno-7-137" href="#__codelineno-7-137"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Process analytics events in batches&quot;&quot;&quot;</span>
</span><span id="__span-7-138"><a id="__codelineno-7-138" name="__codelineno-7-138" href="#__codelineno-7-138"></a>        <span class="c1"># Queue events for batch processing</span>
</span><span id="__span-7-139"><a id="__codelineno-7-139" name="__codelineno-7-139" href="#__codelineno-7-139"></a>        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span><span id="__span-7-140"><a id="__codelineno-7-140" name="__codelineno-7-140" href="#__codelineno-7-140"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</span><span id="__span-7-141"><a id="__codelineno-7-141" name="__codelineno-7-141" href="#__codelineno-7-141"></a>
</span><span id="__span-7-142"><a id="__codelineno-7-142" name="__codelineno-7-142" href="#__codelineno-7-142"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_batch_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-7-143"><a id="__codelineno-7-143" name="__codelineno-7-143" href="#__codelineno-7-143"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Process analytics events in batches&quot;&quot;&quot;</span>
</span><span id="__span-7-144"><a id="__codelineno-7-144" name="__codelineno-7-144" href="#__codelineno-7-144"></a>        <span class="n">batch</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-7-145"><a id="__codelineno-7-145" name="__codelineno-7-145" href="#__codelineno-7-145"></a>        <span class="n">last_flush</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="__span-7-146"><a id="__codelineno-7-146" name="__codelineno-7-146" href="#__codelineno-7-146"></a>
</span><span id="__span-7-147"><a id="__codelineno-7-147" name="__codelineno-7-147" href="#__codelineno-7-147"></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="__span-7-148"><a id="__codelineno-7-148" name="__codelineno-7-148" href="#__codelineno-7-148"></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="__span-7-149"><a id="__codelineno-7-149" name="__codelineno-7-149" href="#__codelineno-7-149"></a>                <span class="c1"># Collect events with timeout</span>
</span><span id="__span-7-150"><a id="__codelineno-7-150" name="__codelineno-7-150" href="#__codelineno-7-150"></a>                <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>  <span class="c1"># Batch size</span>
</span><span id="__span-7-151"><a id="__codelineno-7-151" name="__codelineno-7-151" href="#__codelineno-7-151"></a>                    <span class="n">timeout</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">5.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">last_flush</span><span class="p">))</span>
</span><span id="__span-7-152"><a id="__codelineno-7-152" name="__codelineno-7-152" href="#__codelineno-7-152"></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-7-153"><a id="__codelineno-7-153" name="__codelineno-7-153" href="#__codelineno-7-153"></a>                        <span class="n">event</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span>
</span><span id="__span-7-154"><a id="__codelineno-7-154" name="__codelineno-7-154" href="#__codelineno-7-154"></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">batch_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
</span><span id="__span-7-155"><a id="__codelineno-7-155" name="__codelineno-7-155" href="#__codelineno-7-155"></a>                            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span>
</span><span id="__span-7-156"><a id="__codelineno-7-156" name="__codelineno-7-156" href="#__codelineno-7-156"></a>                        <span class="p">)</span>
</span><span id="__span-7-157"><a id="__codelineno-7-157" name="__codelineno-7-157" href="#__codelineno-7-157"></a>                        <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</span><span id="__span-7-158"><a id="__codelineno-7-158" name="__codelineno-7-158" href="#__codelineno-7-158"></a>                    <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
</span><span id="__span-7-159"><a id="__codelineno-7-159" name="__codelineno-7-159" href="#__codelineno-7-159"></a>                        <span class="k">break</span>
</span><span id="__span-7-160"><a id="__codelineno-7-160" name="__codelineno-7-160" href="#__codelineno-7-160"></a>
</span><span id="__span-7-161"><a id="__codelineno-7-161" name="__codelineno-7-161" href="#__codelineno-7-161"></a>                <span class="c1"># Process batch if we have events or timeout reached</span>
</span><span id="__span-7-162"><a id="__codelineno-7-162" name="__codelineno-7-162" href="#__codelineno-7-162"></a>                <span class="k">if</span> <span class="n">batch</span> <span class="ow">or</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">last_flush</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">5.0</span><span class="p">:</span>
</span><span id="__span-7-163"><a id="__codelineno-7-163" name="__codelineno-7-163" href="#__codelineno-7-163"></a>                    <span class="k">if</span> <span class="n">batch</span><span class="p">:</span>
</span><span id="__span-7-164"><a id="__codelineno-7-164" name="__codelineno-7-164" href="#__codelineno-7-164"></a>                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flush_analytics_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="__span-7-165"><a id="__codelineno-7-165" name="__codelineno-7-165" href="#__codelineno-7-165"></a>                        <span class="n">batch</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-7-166"><a id="__codelineno-7-166" name="__codelineno-7-166" href="#__codelineno-7-166"></a>                    <span class="n">last_flush</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="__span-7-167"><a id="__codelineno-7-167" name="__codelineno-7-167" href="#__codelineno-7-167"></a>
</span><span id="__span-7-168"><a id="__codelineno-7-168" name="__codelineno-7-168" href="#__codelineno-7-168"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-7-169"><a id="__codelineno-7-169" name="__codelineno-7-169" href="#__codelineno-7-169"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Batch processor error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-7-170"><a id="__codelineno-7-170" name="__codelineno-7-170" href="#__codelineno-7-170"></a>                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-7-171"><a id="__codelineno-7-171" name="__codelineno-7-171" href="#__codelineno-7-171"></a>
</span><span id="__span-7-172"><a id="__codelineno-7-172" name="__codelineno-7-172" href="#__codelineno-7-172"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_flush_analytics_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]):</span>
</span><span id="__span-7-173"><a id="__codelineno-7-173" name="__codelineno-7-173" href="#__codelineno-7-173"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Efficiently write analytics batch&quot;&quot;&quot;</span>
</span><span id="__span-7-174"><a id="__codelineno-7-174" name="__codelineno-7-174" href="#__codelineno-7-174"></a>        <span class="c1"># Group by short code</span>
</span><span id="__span-7-175"><a id="__codelineno-7-175" name="__codelineno-7-175" href="#__codelineno-7-175"></a>        <span class="n">by_code</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
</span><span id="__span-7-176"><a id="__codelineno-7-176" name="__codelineno-7-176" href="#__codelineno-7-176"></a>        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
</span><span id="__span-7-177"><a id="__codelineno-7-177" name="__codelineno-7-177" href="#__codelineno-7-177"></a>            <span class="n">by_code</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;short_code&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</span><span id="__span-7-178"><a id="__codelineno-7-178" name="__codelineno-7-178" href="#__codelineno-7-178"></a>
</span><span id="__span-7-179"><a id="__codelineno-7-179" name="__codelineno-7-179" href="#__codelineno-7-179"></a>        <span class="c1"># Parallel updates with pipelining</span>
</span><span id="__span-7-180"><a id="__codelineno-7-180" name="__codelineno-7-180" href="#__codelineno-7-180"></a>        <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_pool</span><span class="o">.</span><span class="n">pipeline</span><span class="p">()</span>
</span><span id="__span-7-181"><a id="__codelineno-7-181" name="__codelineno-7-181" href="#__codelineno-7-181"></a>
</span><span id="__span-7-182"><a id="__codelineno-7-182" name="__codelineno-7-182" href="#__codelineno-7-182"></a>        <span class="k">for</span> <span class="n">short_code</span><span class="p">,</span> <span class="n">events</span> <span class="ow">in</span> <span class="n">by_code</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-7-183"><a id="__codelineno-7-183" name="__codelineno-7-183" href="#__codelineno-7-183"></a>            <span class="c1"># Increment counters</span>
</span><span id="__span-7-184"><a id="__codelineno-7-184" name="__codelineno-7-184" href="#__codelineno-7-184"></a>            <span class="n">click_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">events</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;click&#39;</span><span class="p">])</span>
</span><span id="__span-7-185"><a id="__codelineno-7-185" name="__codelineno-7-185" href="#__codelineno-7-185"></a>            <span class="k">if</span> <span class="n">click_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-7-186"><a id="__codelineno-7-186" name="__codelineno-7-186" href="#__codelineno-7-186"></a>                <span class="n">pipeline</span><span class="o">.</span><span class="n">hincrby</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;analytics:</span><span class="si">{</span><span class="n">short_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s1">&#39;clicks&#39;</span><span class="p">,</span> <span class="n">click_count</span><span class="p">)</span>
</span><span id="__span-7-187"><a id="__codelineno-7-187" name="__codelineno-7-187" href="#__codelineno-7-187"></a>
</span><span id="__span-7-188"><a id="__codelineno-7-188" name="__codelineno-7-188" href="#__codelineno-7-188"></a>            <span class="c1"># Update time series data</span>
</span><span id="__span-7-189"><a id="__codelineno-7-189" name="__codelineno-7-189" href="#__codelineno-7-189"></a>            <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span><span id="__span-7-190"><a id="__codelineno-7-190" name="__codelineno-7-190" href="#__codelineno-7-190"></a>                <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">])</span>
</span><span id="__span-7-191"><a id="__codelineno-7-191" name="__codelineno-7-191" href="#__codelineno-7-191"></a>                <span class="n">pipeline</span><span class="o">.</span><span class="n">zadd</span><span class="p">(</span>
</span><span id="__span-7-192"><a id="__codelineno-7-192" name="__codelineno-7-192" href="#__codelineno-7-192"></a>                    <span class="sa">f</span><span class="s2">&quot;timeseries:</span><span class="si">{</span><span class="n">short_code</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">timestamp</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="mi">3600</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>  <span class="c1"># Hourly buckets</span>
</span><span id="__span-7-193"><a id="__codelineno-7-193" name="__codelineno-7-193" href="#__codelineno-7-193"></a>                    <span class="p">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">event</span><span class="p">):</span> <span class="n">timestamp</span><span class="p">}</span>
</span><span id="__span-7-194"><a id="__codelineno-7-194" name="__codelineno-7-194" href="#__codelineno-7-194"></a>                <span class="p">)</span>
</span><span id="__span-7-195"><a id="__codelineno-7-195" name="__codelineno-7-195" href="#__codelineno-7-195"></a>
</span><span id="__span-7-196"><a id="__codelineno-7-196" name="__codelineno-7-196" href="#__codelineno-7-196"></a>        <span class="c1"># Execute pipeline</span>
</span><span id="__span-7-197"><a id="__codelineno-7-197" name="__codelineno-7-197" href="#__codelineno-7-197"></a>        <span class="k">await</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</span><span id="__span-7-198"><a id="__codelineno-7-198" name="__codelineno-7-198" href="#__codelineno-7-198"></a>
</span><span id="__span-7-199"><a id="__codelineno-7-199" name="__codelineno-7-199" href="#__codelineno-7-199"></a>        <span class="c1"># Also write to data warehouse</span>
</span><span id="__span-7-200"><a id="__codelineno-7-200" name="__codelineno-7-200" href="#__codelineno-7-200"></a>        <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_write_to_warehouse</span><span class="p">(</span><span class="n">batch</span><span class="p">))</span>
</span><span id="__span-7-201"><a id="__codelineno-7-201" name="__codelineno-7-201" href="#__codelineno-7-201"></a>
</span><span id="__span-7-202"><a id="__codelineno-7-202" name="__codelineno-7-202" href="#__codelineno-7-202"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">increment_counter_lockfree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">short_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">delta</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="__span-7-203"><a id="__codelineno-7-203" name="__codelineno-7-203" href="#__codelineno-7-203"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Lock-free counter increment using CAS&quot;&quot;&quot;</span>
</span><span id="__span-7-204"><a id="__codelineno-7-204" name="__codelineno-7-204" href="#__codelineno-7-204"></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="__span-7-205"><a id="__codelineno-7-205" name="__codelineno-7-205" href="#__codelineno-7-205"></a>            <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counters</span><span class="p">[</span><span class="n">short_code</span><span class="p">][</span><span class="n">field</span><span class="p">]</span>
</span><span id="__span-7-206"><a id="__codelineno-7-206" name="__codelineno-7-206" href="#__codelineno-7-206"></a>            <span class="n">new_value</span> <span class="o">=</span> <span class="n">current</span> <span class="o">+</span> <span class="n">delta</span>
</span><span id="__span-7-207"><a id="__codelineno-7-207" name="__codelineno-7-207" href="#__codelineno-7-207"></a>
</span><span id="__span-7-208"><a id="__codelineno-7-208" name="__codelineno-7-208" href="#__codelineno-7-208"></a>            <span class="c1"># Compare and swap</span>
</span><span id="__span-7-209"><a id="__codelineno-7-209" name="__codelineno-7-209" href="#__codelineno-7-209"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cas_update</span><span class="p">(</span><span class="n">short_code</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="n">new_value</span><span class="p">):</span>
</span><span id="__span-7-210"><a id="__codelineno-7-210" name="__codelineno-7-210" href="#__codelineno-7-210"></a>                <span class="k">break</span>
</span><span id="__span-7-211"><a id="__codelineno-7-211" name="__codelineno-7-211" href="#__codelineno-7-211"></a>
</span><span id="__span-7-212"><a id="__codelineno-7-212" name="__codelineno-7-212" href="#__codelineno-7-212"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_cas_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">short_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">expected</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">new_value</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="__span-7-213"><a id="__codelineno-7-213" name="__codelineno-7-213" href="#__codelineno-7-213"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compare-and-swap update&quot;&quot;&quot;</span>
</span><span id="__span-7-214"><a id="__codelineno-7-214" name="__codelineno-7-214" href="#__codelineno-7-214"></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">counters</span><span class="p">[</span><span class="n">short_code</span><span class="p">][</span><span class="s1">&#39;lock&#39;</span><span class="p">]:</span>
</span><span id="__span-7-215"><a id="__codelineno-7-215" name="__codelineno-7-215" href="#__codelineno-7-215"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">counters</span><span class="p">[</span><span class="n">short_code</span><span class="p">][</span><span class="n">field</span><span class="p">]</span> <span class="o">==</span> <span class="n">expected</span><span class="p">:</span>
</span><span id="__span-7-216"><a id="__codelineno-7-216" name="__codelineno-7-216" href="#__codelineno-7-216"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">counters</span><span class="p">[</span><span class="n">short_code</span><span class="p">][</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_value</span>
</span><span id="__span-7-217"><a id="__codelineno-7-217" name="__codelineno-7-217" href="#__codelineno-7-217"></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="__span-7-218"><a id="__codelineno-7-218" name="__codelineno-7-218" href="#__codelineno-7-218"></a>            <span class="k">return</span> <span class="kc">False</span>
</span></code></pre></div></p>
<h4 id="axiom-5-coordination-distributed-consensus">🤝 Axiom 5 (Coordination): Distributed Consensus<a class="headerlink" href="#axiom-5-coordination-distributed-consensus" title="Permanent link">&para;</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>Coordination Needs:
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>- Short code uniqueness
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>- Counter synchronization
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>- Cache invalidation
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>- Configuration updates
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>- Failover coordination
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>Strategies:
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>- Distributed ID generation
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>- Gossip for counters
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>- Pub/sub for cache
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>- Consensus for config
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>- Leader election for failover
</span></code></pre></div>
<p><strong>Implementation:</strong>
<div class="language-python highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">kazoo.client</span><span class="w"> </span><span class="kn">import</span> <span class="n">KazooClient</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">consul</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">etcd3</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">DistributedURLShortener</span><span class="p">:</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordination_service</span><span class="o">=</span><span class="s1">&#39;zookeeper&#39;</span><span class="p">):</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coordination_service</span> <span class="o">=</span> <span class="n">coordination_service</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">node_id</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>        <span class="c1"># Initialize coordination client</span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>        <span class="k">if</span> <span class="n">coordination_service</span> <span class="o">==</span> <span class="s1">&#39;zookeeper&#39;</span><span class="p">:</span>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">coord_client</span> <span class="o">=</span> <span class="n">KazooClient</span><span class="p">(</span><span class="n">hosts</span><span class="o">=</span><span class="s1">&#39;127.0.0.1:2181&#39;</span><span class="p">)</span>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">coord_client</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>        <span class="k">elif</span> <span class="n">coordination_service</span> <span class="o">==</span> <span class="s1">&#39;consul&#39;</span><span class="p">:</span>
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">coord_client</span> <span class="o">=</span> <span class="n">consul</span><span class="o">.</span><span class="n">Consul</span><span class="p">()</span>
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>        <span class="k">elif</span> <span class="n">coordination_service</span> <span class="o">==</span> <span class="s1">&#39;etcd&#39;</span><span class="p">:</span>
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">coord_client</span> <span class="o">=</span> <span class="n">etcd3</span><span class="o">.</span><span class="n">client</span><span class="p">()</span>
</span><span id="__span-9-18"><a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a>
</span><span id="__span-9-19"><a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a>        <span class="c1"># Distributed components</span>
</span><span id="__span-9-20"><a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">distributed_counter</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-9-21"><a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_invalidator</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-9-22"><a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config_watcher</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-9-23"><a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a>
</span><span id="__span-9-24"><a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_coordination</span><span class="p">()</span>
</span><span id="__span-9-25"><a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a>
</span><span id="__span-9-26"><a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_coordination</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-9-27"><a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set up distributed coordination&quot;&quot;&quot;</span>
</span><span id="__span-9-28"><a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a>        <span class="c1"># Distributed counter for short codes</span>
</span><span id="__span-9-29"><a id="__codelineno-9-29" name="__codelineno-9-29" href="#__codelineno-9-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">distributed_counter</span> <span class="o">=</span> <span class="n">DistributedCounter</span><span class="p">(</span>
</span><span id="__span-9-30"><a id="__codelineno-9-30" name="__codelineno-9-30" href="#__codelineno-9-30"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">coord_client</span><span class="p">,</span>
</span><span id="__span-9-31"><a id="__codelineno-9-31" name="__codelineno-9-31" href="#__codelineno-9-31"></a>            <span class="s1">&#39;/urlshortener/counter&#39;</span>
</span><span id="__span-9-32"><a id="__codelineno-9-32" name="__codelineno-9-32" href="#__codelineno-9-32"></a>        <span class="p">)</span>
</span><span id="__span-9-33"><a id="__codelineno-9-33" name="__codelineno-9-33" href="#__codelineno-9-33"></a>
</span><span id="__span-9-34"><a id="__codelineno-9-34" name="__codelineno-9-34" href="#__codelineno-9-34"></a>        <span class="c1"># Cache invalidation pub/sub</span>
</span><span id="__span-9-35"><a id="__codelineno-9-35" name="__codelineno-9-35" href="#__codelineno-9-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_invalidator</span> <span class="o">=</span> <span class="n">CacheInvalidator</span><span class="p">(</span>
</span><span id="__span-9-36"><a id="__codelineno-9-36" name="__codelineno-9-36" href="#__codelineno-9-36"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">coord_client</span><span class="p">,</span>
</span><span id="__span-9-37"><a id="__codelineno-9-37" name="__codelineno-9-37" href="#__codelineno-9-37"></a>            <span class="s1">&#39;/urlshortener/cache_events&#39;</span>
</span><span id="__span-9-38"><a id="__codelineno-9-38" name="__codelineno-9-38" href="#__codelineno-9-38"></a>        <span class="p">)</span>
</span><span id="__span-9-39"><a id="__codelineno-9-39" name="__codelineno-9-39" href="#__codelineno-9-39"></a>
</span><span id="__span-9-40"><a id="__codelineno-9-40" name="__codelineno-9-40" href="#__codelineno-9-40"></a>        <span class="c1"># Configuration management</span>
</span><span id="__span-9-41"><a id="__codelineno-9-41" name="__codelineno-9-41" href="#__codelineno-9-41"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config_watcher</span> <span class="o">=</span> <span class="n">ConfigWatcher</span><span class="p">(</span>
</span><span id="__span-9-42"><a id="__codelineno-9-42" name="__codelineno-9-42" href="#__codelineno-9-42"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">coord_client</span><span class="p">,</span>
</span><span id="__span-9-43"><a id="__codelineno-9-43" name="__codelineno-9-43" href="#__codelineno-9-43"></a>            <span class="s1">&#39;/urlshortener/config&#39;</span>
</span><span id="__span-9-44"><a id="__codelineno-9-44" name="__codelineno-9-44" href="#__codelineno-9-44"></a>        <span class="p">)</span>
</span><span id="__span-9-45"><a id="__codelineno-9-45" name="__codelineno-9-45" href="#__codelineno-9-45"></a>
</span><span id="__span-9-46"><a id="__codelineno-9-46" name="__codelineno-9-46" href="#__codelineno-9-46"></a>        <span class="c1"># Register this node</span>
</span><span id="__span-9-47"><a id="__codelineno-9-47" name="__codelineno-9-47" href="#__codelineno-9-47"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_register_node</span><span class="p">()</span>
</span><span id="__span-9-48"><a id="__codelineno-9-48" name="__codelineno-9-48" href="#__codelineno-9-48"></a>
</span><span id="__span-9-49"><a id="__codelineno-9-49" name="__codelineno-9-49" href="#__codelineno-9-49"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_register_node</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-9-50"><a id="__codelineno-9-50" name="__codelineno-9-50" href="#__codelineno-9-50"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Register node in service discovery&quot;&quot;&quot;</span>
</span><span id="__span-9-51"><a id="__codelineno-9-51" name="__codelineno-9-51" href="#__codelineno-9-51"></a>        <span class="n">node_data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-9-52"><a id="__codelineno-9-52" name="__codelineno-9-52" href="#__codelineno-9-52"></a>            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_id</span><span class="p">,</span>
</span><span id="__span-9-53"><a id="__codelineno-9-53" name="__codelineno-9-53" href="#__codelineno-9-53"></a>            <span class="s1">&#39;ip&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ip</span><span class="p">(),</span>
</span><span id="__span-9-54"><a id="__codelineno-9-54" name="__codelineno-9-54" href="#__codelineno-9-54"></a>            <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="mi">8080</span><span class="p">,</span>
</span><span id="__span-9-55"><a id="__codelineno-9-55" name="__codelineno-9-55" href="#__codelineno-9-55"></a>            <span class="s1">&#39;region&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;REGION&#39;</span><span class="p">,</span> <span class="s1">&#39;us-east&#39;</span><span class="p">),</span>
</span><span id="__span-9-56"><a id="__codelineno-9-56" name="__codelineno-9-56" href="#__codelineno-9-56"></a>            <span class="s1">&#39;capacity&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_capacity</span><span class="p">(),</span>
</span><span id="__span-9-57"><a id="__codelineno-9-57" name="__codelineno-9-57" href="#__codelineno-9-57"></a>            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;healthy&#39;</span>
</span><span id="__span-9-58"><a id="__codelineno-9-58" name="__codelineno-9-58" href="#__codelineno-9-58"></a>        <span class="p">}</span>
</span><span id="__span-9-59"><a id="__codelineno-9-59" name="__codelineno-9-59" href="#__codelineno-9-59"></a>
</span><span id="__span-9-60"><a id="__codelineno-9-60" name="__codelineno-9-60" href="#__codelineno-9-60"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordination_service</span> <span class="o">==</span> <span class="s1">&#39;zookeeper&#39;</span><span class="p">:</span>
</span><span id="__span-9-61"><a id="__codelineno-9-61" name="__codelineno-9-61" href="#__codelineno-9-61"></a>            <span class="c1"># Ephemeral node - automatically removed on disconnect</span>
</span><span id="__span-9-62"><a id="__codelineno-9-62" name="__codelineno-9-62" href="#__codelineno-9-62"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">coord_client</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span><span id="__span-9-63"><a id="__codelineno-9-63" name="__codelineno-9-63" href="#__codelineno-9-63"></a>                <span class="sa">f</span><span class="s1">&#39;/urlshortener/nodes/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">node_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
</span><span id="__span-9-64"><a id="__codelineno-9-64" name="__codelineno-9-64" href="#__codelineno-9-64"></a>                <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">node_data</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span>
</span><span id="__span-9-65"><a id="__codelineno-9-65" name="__codelineno-9-65" href="#__codelineno-9-65"></a>                <span class="n">ephemeral</span><span class="o">=</span><span class="kc">True</span>
</span><span id="__span-9-66"><a id="__codelineno-9-66" name="__codelineno-9-66" href="#__codelineno-9-66"></a>            <span class="p">)</span>
</span><span id="__span-9-67"><a id="__codelineno-9-67" name="__codelineno-9-67" href="#__codelineno-9-67"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordination_service</span> <span class="o">==</span> <span class="s1">&#39;consul&#39;</span><span class="p">:</span>
</span><span id="__span-9-68"><a id="__codelineno-9-68" name="__codelineno-9-68" href="#__codelineno-9-68"></a>            <span class="c1"># Service registration with health check</span>
</span><span id="__span-9-69"><a id="__codelineno-9-69" name="__codelineno-9-69" href="#__codelineno-9-69"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">coord_client</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
</span><span id="__span-9-70"><a id="__codelineno-9-70" name="__codelineno-9-70" href="#__codelineno-9-70"></a>                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;urlshortener&#39;</span><span class="p">,</span>
</span><span id="__span-9-71"><a id="__codelineno-9-71" name="__codelineno-9-71" href="#__codelineno-9-71"></a>                <span class="n">service_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node_id</span><span class="p">,</span>
</span><span id="__span-9-72"><a id="__codelineno-9-72" name="__codelineno-9-72" href="#__codelineno-9-72"></a>                <span class="n">address</span><span class="o">=</span><span class="n">node_data</span><span class="p">[</span><span class="s1">&#39;ip&#39;</span><span class="p">],</span>
</span><span id="__span-9-73"><a id="__codelineno-9-73" name="__codelineno-9-73" href="#__codelineno-9-73"></a>                <span class="n">port</span><span class="o">=</span><span class="n">node_data</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">],</span>
</span><span id="__span-9-74"><a id="__codelineno-9-74" name="__codelineno-9-74" href="#__codelineno-9-74"></a>                <span class="n">check</span><span class="o">=</span><span class="n">consul</span><span class="o">.</span><span class="n">Check</span><span class="o">.</span><span class="n">http</span><span class="p">(</span>
</span><span id="__span-9-75"><a id="__codelineno-9-75" name="__codelineno-9-75" href="#__codelineno-9-75"></a>                    <span class="sa">f</span><span class="s2">&quot;http://</span><span class="si">{</span><span class="n">node_data</span><span class="p">[</span><span class="s1">&#39;ip&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">node_data</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/health&quot;</span><span class="p">,</span>
</span><span id="__span-9-76"><a id="__codelineno-9-76" name="__codelineno-9-76" href="#__codelineno-9-76"></a>                    <span class="n">interval</span><span class="o">=</span><span class="s1">&#39;10s&#39;</span>
</span><span id="__span-9-77"><a id="__codelineno-9-77" name="__codelineno-9-77" href="#__codelineno-9-77"></a>                <span class="p">)</span>
</span><span id="__span-9-78"><a id="__codelineno-9-78" name="__codelineno-9-78" href="#__codelineno-9-78"></a>            <span class="p">)</span>
</span><span id="__span-9-79"><a id="__codelineno-9-79" name="__codelineno-9-79" href="#__codelineno-9-79"></a>
</span><span id="__span-9-80"><a id="__codelineno-9-80" name="__codelineno-9-80" href="#__codelineno-9-80"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_unique_short_code</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-9-81"><a id="__codelineno-9-81" name="__codelineno-9-81" href="#__codelineno-9-81"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate globally unique short code&quot;&quot;&quot;</span>
</span><span id="__span-9-82"><a id="__codelineno-9-82" name="__codelineno-9-82" href="#__codelineno-9-82"></a>        <span class="c1"># Use distributed counter</span>
</span><span id="__span-9-83"><a id="__codelineno-9-83" name="__codelineno-9-83" href="#__codelineno-9-83"></a>        <span class="n">counter_value</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">distributed_counter</span><span class="o">.</span><span class="n">increment</span><span class="p">()</span>
</span><span id="__span-9-84"><a id="__codelineno-9-84" name="__codelineno-9-84" href="#__codelineno-9-84"></a>
</span><span id="__span-9-85"><a id="__codelineno-9-85" name="__codelineno-9-85" href="#__codelineno-9-85"></a>        <span class="c1"># Encode with node ID for guaranteed uniqueness</span>
</span><span id="__span-9-86"><a id="__codelineno-9-86" name="__codelineno-9-86" href="#__codelineno-9-86"></a>        <span class="n">node_component</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_id</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># First 2 chars of node ID</span>
</span><span id="__span-9-87"><a id="__codelineno-9-87" name="__codelineno-9-87" href="#__codelineno-9-87"></a>        <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base62_encode</span><span class="p">(</span><span class="n">counter_value</span><span class="p">)</span>
</span><span id="__span-9-88"><a id="__codelineno-9-88" name="__codelineno-9-88" href="#__codelineno-9-88"></a>
</span><span id="__span-9-89"><a id="__codelineno-9-89" name="__codelineno-9-89" href="#__codelineno-9-89"></a>        <span class="c1"># Combine for uniqueness across nodes</span>
</span><span id="__span-9-90"><a id="__codelineno-9-90" name="__codelineno-9-90" href="#__codelineno-9-90"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">code</span><span class="si">}{</span><span class="n">node_component</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-9-91"><a id="__codelineno-9-91" name="__codelineno-9-91" href="#__codelineno-9-91"></a>
</span><span id="__span-9-92"><a id="__codelineno-9-92" name="__codelineno-9-92" href="#__codelineno-9-92"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_url_distributed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">short_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">updates</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="__span-9-93"><a id="__codelineno-9-93" name="__codelineno-9-93" href="#__codelineno-9-93"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update URL with distributed coordination&quot;&quot;&quot;</span>
</span><span id="__span-9-94"><a id="__codelineno-9-94" name="__codelineno-9-94" href="#__codelineno-9-94"></a>        <span class="c1"># Acquire distributed lock</span>
</span><span id="__span-9-95"><a id="__codelineno-9-95" name="__codelineno-9-95" href="#__codelineno-9-95"></a>        <span class="n">lock_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;/urlshortener/locks/</span><span class="si">{</span><span class="n">short_code</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="__span-9-96"><a id="__codelineno-9-96" name="__codelineno-9-96" href="#__codelineno-9-96"></a>
</span><span id="__span-9-97"><a id="__codelineno-9-97" name="__codelineno-9-97" href="#__codelineno-9-97"></a>        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">distributed_lock</span><span class="p">(</span><span class="n">lock_path</span><span class="p">):</span>
</span><span id="__span-9-98"><a id="__codelineno-9-98" name="__codelineno-9-98" href="#__codelineno-9-98"></a>            <span class="c1"># Read current state</span>
</span><span id="__span-9-99"><a id="__codelineno-9-99" name="__codelineno-9-99" href="#__codelineno-9-99"></a>            <span class="n">current</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_url</span><span class="p">(</span><span class="n">short_code</span><span class="p">)</span>
</span><span id="__span-9-100"><a id="__codelineno-9-100" name="__codelineno-9-100" href="#__codelineno-9-100"></a>
</span><span id="__span-9-101"><a id="__codelineno-9-101" name="__codelineno-9-101" href="#__codelineno-9-101"></a>            <span class="c1"># Apply updates</span>
</span><span id="__span-9-102"><a id="__codelineno-9-102" name="__codelineno-9-102" href="#__codelineno-9-102"></a>            <span class="n">updated</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">current</span><span class="p">,</span> <span class="o">**</span><span class="n">updates</span><span class="p">}</span>
</span><span id="__span-9-103"><a id="__codelineno-9-103" name="__codelineno-9-103" href="#__codelineno-9-103"></a>
</span><span id="__span-9-104"><a id="__codelineno-9-104" name="__codelineno-9-104" href="#__codelineno-9-104"></a>            <span class="c1"># Write back</span>
</span><span id="__span-9-105"><a id="__codelineno-9-105" name="__codelineno-9-105" href="#__codelineno-9-105"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_url</span><span class="p">(</span><span class="n">short_code</span><span class="p">,</span> <span class="n">updated</span><span class="p">)</span>
</span><span id="__span-9-106"><a id="__codelineno-9-106" name="__codelineno-9-106" href="#__codelineno-9-106"></a>
</span><span id="__span-9-107"><a id="__codelineno-9-107" name="__codelineno-9-107" href="#__codelineno-9-107"></a>            <span class="c1"># Invalidate caches across cluster</span>
</span><span id="__span-9-108"><a id="__codelineno-9-108" name="__codelineno-9-108" href="#__codelineno-9-108"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_invalidator</span><span class="o">.</span><span class="n">publish</span><span class="p">({</span>
</span><span id="__span-9-109"><a id="__codelineno-9-109" name="__codelineno-9-109" href="#__codelineno-9-109"></a>                <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;invalidate&#39;</span><span class="p">,</span>
</span><span id="__span-9-110"><a id="__codelineno-9-110" name="__codelineno-9-110" href="#__codelineno-9-110"></a>                <span class="s1">&#39;short_code&#39;</span><span class="p">:</span> <span class="n">short_code</span><span class="p">,</span>
</span><span id="__span-9-111"><a id="__codelineno-9-111" name="__codelineno-9-111" href="#__codelineno-9-111"></a>                <span class="s1">&#39;node&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_id</span>
</span><span id="__span-9-112"><a id="__codelineno-9-112" name="__codelineno-9-112" href="#__codelineno-9-112"></a>            <span class="p">})</span>
</span><span id="__span-9-113"><a id="__codelineno-9-113" name="__codelineno-9-113" href="#__codelineno-9-113"></a>
</span><span id="__span-9-114"><a id="__codelineno-9-114" name="__codelineno-9-114" href="#__codelineno-9-114"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">distributed_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">):</span>
</span><span id="__span-9-115"><a id="__codelineno-9-115" name="__codelineno-9-115" href="#__codelineno-9-115"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Distributed lock context manager&quot;&quot;&quot;</span>
</span><span id="__span-9-116"><a id="__codelineno-9-116" name="__codelineno-9-116" href="#__codelineno-9-116"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordination_service</span> <span class="o">==</span> <span class="s1">&#39;zookeeper&#39;</span><span class="p">:</span>
</span><span id="__span-9-117"><a id="__codelineno-9-117" name="__codelineno-9-117" href="#__codelineno-9-117"></a>            <span class="n">lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_client</span><span class="o">.</span><span class="n">Lock</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_id</span><span class="p">)</span>
</span><span id="__span-9-118"><a id="__codelineno-9-118" name="__codelineno-9-118" href="#__codelineno-9-118"></a>            <span class="k">return</span> <span class="n">ZookeeperLockContext</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
</span><span id="__span-9-119"><a id="__codelineno-9-119" name="__codelineno-9-119" href="#__codelineno-9-119"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordination_service</span> <span class="o">==</span> <span class="s1">&#39;consul&#39;</span><span class="p">:</span>
</span><span id="__span-9-120"><a id="__codelineno-9-120" name="__codelineno-9-120" href="#__codelineno-9-120"></a>            <span class="k">return</span> <span class="n">ConsulLockContext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coord_client</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
</span><span id="__span-9-121"><a id="__codelineno-9-121" name="__codelineno-9-121" href="#__codelineno-9-121"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordination_service</span> <span class="o">==</span> <span class="s1">&#39;etcd&#39;</span><span class="p">:</span>
</span><span id="__span-9-122"><a id="__codelineno-9-122" name="__codelineno-9-122" href="#__codelineno-9-122"></a>            <span class="k">return</span> <span class="n">EtcdLockContext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coord_client</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
</span><span id="__span-9-123"><a id="__codelineno-9-123" name="__codelineno-9-123" href="#__codelineno-9-123"></a>
</span><span id="__span-9-124"><a id="__codelineno-9-124" name="__codelineno-9-124" href="#__codelineno-9-124"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">coordinate_failover</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">failed_node</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-9-125"><a id="__codelineno-9-125" name="__codelineno-9-125" href="#__codelineno-9-125"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Coordinate failover when node fails&quot;&quot;&quot;</span>
</span><span id="__span-9-126"><a id="__codelineno-9-126" name="__codelineno-9-126" href="#__codelineno-9-126"></a>        <span class="c1"># Step 1: Leader election for coordinator</span>
</span><span id="__span-9-127"><a id="__codelineno-9-127" name="__codelineno-9-127" href="#__codelineno-9-127"></a>        <span class="n">leader_path</span> <span class="o">=</span> <span class="s1">&#39;/urlshortener/failover_leader&#39;</span>
</span><span id="__span-9-128"><a id="__codelineno-9-128" name="__codelineno-9-128" href="#__codelineno-9-128"></a>
</span><span id="__span-9-129"><a id="__codelineno-9-129" name="__codelineno-9-129" href="#__codelineno-9-129"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-9-130"><a id="__codelineno-9-130" name="__codelineno-9-130" href="#__codelineno-9-130"></a>            <span class="c1"># Try to become leader</span>
</span><span id="__span-9-131"><a id="__codelineno-9-131" name="__codelineno-9-131" href="#__codelineno-9-131"></a>            <span class="k">if</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_become_leader</span><span class="p">(</span><span class="n">leader_path</span><span class="p">):</span>
</span><span id="__span-9-132"><a id="__codelineno-9-132" name="__codelineno-9-132" href="#__codelineno-9-132"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Node </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">node_id</span><span class="si">}</span><span class="s2"> coordinating failover for </span><span class="si">{</span><span class="n">failed_node</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-9-133"><a id="__codelineno-9-133" name="__codelineno-9-133" href="#__codelineno-9-133"></a>
</span><span id="__span-9-134"><a id="__codelineno-9-134" name="__codelineno-9-134" href="#__codelineno-9-134"></a>                <span class="c1"># Step 2: Get failed node&#39;s responsibilities</span>
</span><span id="__span-9-135"><a id="__codelineno-9-135" name="__codelineno-9-135" href="#__codelineno-9-135"></a>                <span class="n">failed_node_data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_node_data</span><span class="p">(</span><span class="n">failed_node</span><span class="p">)</span>
</span><span id="__span-9-136"><a id="__codelineno-9-136" name="__codelineno-9-136" href="#__codelineno-9-136"></a>
</span><span id="__span-9-137"><a id="__codelineno-9-137" name="__codelineno-9-137" href="#__codelineno-9-137"></a>                <span class="c1"># Step 3: Redistribute work</span>
</span><span id="__span-9-138"><a id="__codelineno-9-138" name="__codelineno-9-138" href="#__codelineno-9-138"></a>                <span class="n">redistribution_plan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_redistribution</span><span class="p">(</span>
</span><span id="__span-9-139"><a id="__codelineno-9-139" name="__codelineno-9-139" href="#__codelineno-9-139"></a>                    <span class="n">failed_node_data</span><span class="p">,</span>
</span><span id="__span-9-140"><a id="__codelineno-9-140" name="__codelineno-9-140" href="#__codelineno-9-140"></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_healthy_nodes</span><span class="p">()</span>
</span><span id="__span-9-141"><a id="__codelineno-9-141" name="__codelineno-9-141" href="#__codelineno-9-141"></a>                <span class="p">)</span>
</span><span id="__span-9-142"><a id="__codelineno-9-142" name="__codelineno-9-142" href="#__codelineno-9-142"></a>
</span><span id="__span-9-143"><a id="__codelineno-9-143" name="__codelineno-9-143" href="#__codelineno-9-143"></a>                <span class="c1"># Step 4: Execute redistribution</span>
</span><span id="__span-9-144"><a id="__codelineno-9-144" name="__codelineno-9-144" href="#__codelineno-9-144"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_redistribution</span><span class="p">(</span><span class="n">redistribution_plan</span><span class="p">)</span>
</span><span id="__span-9-145"><a id="__codelineno-9-145" name="__codelineno-9-145" href="#__codelineno-9-145"></a>
</span><span id="__span-9-146"><a id="__codelineno-9-146" name="__codelineno-9-146" href="#__codelineno-9-146"></a>                <span class="c1"># Step 5: Update routing</span>
</span><span id="__span-9-147"><a id="__codelineno-9-147" name="__codelineno-9-147" href="#__codelineno-9-147"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_routing_table</span><span class="p">(</span><span class="n">redistribution_plan</span><span class="p">)</span>
</span><span id="__span-9-148"><a id="__codelineno-9-148" name="__codelineno-9-148" href="#__codelineno-9-148"></a>
</span><span id="__span-9-149"><a id="__codelineno-9-149" name="__codelineno-9-149" href="#__codelineno-9-149"></a>                <span class="c1"># Step 6: Notify all nodes</span>
</span><span id="__span-9-150"><a id="__codelineno-9-150" name="__codelineno-9-150" href="#__codelineno-9-150"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_broadcast_failover_complete</span><span class="p">(</span><span class="n">failed_node</span><span class="p">,</span> <span class="n">redistribution_plan</span><span class="p">)</span>
</span><span id="__span-9-151"><a id="__codelineno-9-151" name="__codelineno-9-151" href="#__codelineno-9-151"></a>
</span><span id="__span-9-152"><a id="__codelineno-9-152" name="__codelineno-9-152" href="#__codelineno-9-152"></a>        <span class="k">finally</span><span class="p">:</span>
</span><span id="__span-9-153"><a id="__codelineno-9-153" name="__codelineno-9-153" href="#__codelineno-9-153"></a>            <span class="c1"># Release leadership</span>
</span><span id="__span-9-154"><a id="__codelineno-9-154" name="__codelineno-9-154" href="#__codelineno-9-154"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_release_leadership</span><span class="p">(</span><span class="n">leader_path</span><span class="p">)</span>
</span><span id="__span-9-155"><a id="__codelineno-9-155" name="__codelineno-9-155" href="#__codelineno-9-155"></a>
</span><span id="__span-9-156"><a id="__codelineno-9-156" name="__codelineno-9-156" href="#__codelineno-9-156"></a><span class="k">class</span><span class="w"> </span><span class="nc">DistributedCounter</span><span class="p">:</span>
</span><span id="__span-9-157"><a id="__codelineno-9-157" name="__codelineno-9-157" href="#__codelineno-9-157"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Distributed counter using coordination service&quot;&quot;&quot;</span>
</span><span id="__span-9-158"><a id="__codelineno-9-158" name="__codelineno-9-158" href="#__codelineno-9-158"></a>
</span><span id="__span-9-159"><a id="__codelineno-9-159" name="__codelineno-9-159" href="#__codelineno-9-159"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">base_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-9-160"><a id="__codelineno-9-160" name="__codelineno-9-160" href="#__codelineno-9-160"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span>
</span><span id="__span-9-161"><a id="__codelineno-9-161" name="__codelineno-9-161" href="#__codelineno-9-161"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">base_path</span> <span class="o">=</span> <span class="n">base_path</span>
</span><span id="__span-9-162"><a id="__codelineno-9-162" name="__codelineno-9-162" href="#__codelineno-9-162"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">local_cache</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-9-163"><a id="__codelineno-9-163" name="__codelineno-9-163" href="#__codelineno-9-163"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1000</span>
</span><span id="__span-9-164"><a id="__codelineno-9-164" name="__codelineno-9-164" href="#__codelineno-9-164"></a>
</span><span id="__span-9-165"><a id="__codelineno-9-165" name="__codelineno-9-165" href="#__codelineno-9-165"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">increment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="__span-9-166"><a id="__codelineno-9-166" name="__codelineno-9-166" href="#__codelineno-9-166"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get next counter value&quot;&quot;&quot;</span>
</span><span id="__span-9-167"><a id="__codelineno-9-167" name="__codelineno-9-167" href="#__codelineno-9-167"></a>        <span class="c1"># Use local cache for performance</span>
</span><span id="__span-9-168"><a id="__codelineno-9-168" name="__codelineno-9-168" href="#__codelineno-9-168"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_cache</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-9-169"><a id="__codelineno-9-169" name="__codelineno-9-169" href="#__codelineno-9-169"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">local_cache</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="__span-9-170"><a id="__codelineno-9-170" name="__codelineno-9-170" href="#__codelineno-9-170"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_base_value</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_cache</span><span class="p">)</span>
</span><span id="__span-9-171"><a id="__codelineno-9-171" name="__codelineno-9-171" href="#__codelineno-9-171"></a>
</span><span id="__span-9-172"><a id="__codelineno-9-172" name="__codelineno-9-172" href="#__codelineno-9-172"></a>        <span class="c1"># Refill from distributed counter</span>
</span><span id="__span-9-173"><a id="__codelineno-9-173" name="__codelineno-9-173" href="#__codelineno-9-173"></a>        <span class="n">new_base</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_increment_distributed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
</span><span id="__span-9-174"><a id="__codelineno-9-174" name="__codelineno-9-174" href="#__codelineno-9-174"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">local_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="__span-9-175"><a id="__codelineno-9-175" name="__codelineno-9-175" href="#__codelineno-9-175"></a>
</span><span id="__span-9-176"><a id="__codelineno-9-176" name="__codelineno-9-176" href="#__codelineno-9-176"></a>        <span class="k">return</span> <span class="n">new_base</span>
</span><span id="__span-9-177"><a id="__codelineno-9-177" name="__codelineno-9-177" href="#__codelineno-9-177"></a>
</span><span id="__span-9-178"><a id="__codelineno-9-178" name="__codelineno-9-178" href="#__codelineno-9-178"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_increment_distributed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="__span-9-179"><a id="__codelineno-9-179" name="__codelineno-9-179" href="#__codelineno-9-179"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Atomically increment distributed counter&quot;&quot;&quot;</span>
</span><span id="__span-9-180"><a id="__codelineno-9-180" name="__codelineno-9-180" href="#__codelineno-9-180"></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="__span-9-181"><a id="__codelineno-9-181" name="__codelineno-9-181" href="#__codelineno-9-181"></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="__span-9-182"><a id="__codelineno-9-182" name="__codelineno-9-182" href="#__codelineno-9-182"></a>                <span class="c1"># Read current value</span>
</span><span id="__span-9-183"><a id="__codelineno-9-183" name="__codelineno-9-183" href="#__codelineno-9-183"></a>                <span class="n">current</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_counter</span><span class="p">()</span>
</span><span id="__span-9-184"><a id="__codelineno-9-184" name="__codelineno-9-184" href="#__codelineno-9-184"></a>                <span class="n">new_value</span> <span class="o">=</span> <span class="n">current</span> <span class="o">+</span> <span class="n">delta</span>
</span><span id="__span-9-185"><a id="__codelineno-9-185" name="__codelineno-9-185" href="#__codelineno-9-185"></a>
</span><span id="__span-9-186"><a id="__codelineno-9-186" name="__codelineno-9-186" href="#__codelineno-9-186"></a>                <span class="c1"># Try to update</span>
</span><span id="__span-9-187"><a id="__codelineno-9-187" name="__codelineno-9-187" href="#__codelineno-9-187"></a>                <span class="k">if</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cas_counter</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">new_value</span><span class="p">):</span>
</span><span id="__span-9-188"><a id="__codelineno-9-188" name="__codelineno-9-188" href="#__codelineno-9-188"></a>                    <span class="k">return</span> <span class="n">new_value</span>
</span><span id="__span-9-189"><a id="__codelineno-9-189" name="__codelineno-9-189" href="#__codelineno-9-189"></a>
</span><span id="__span-9-190"><a id="__codelineno-9-190" name="__codelineno-9-190" href="#__codelineno-9-190"></a>                <span class="c1"># Retry on conflict</span>
</span><span id="__span-9-191"><a id="__codelineno-9-191" name="__codelineno-9-191" href="#__codelineno-9-191"></a>                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span> <span class="o">*</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span>
</span><span id="__span-9-192"><a id="__codelineno-9-192" name="__codelineno-9-192" href="#__codelineno-9-192"></a>
</span><span id="__span-9-193"><a id="__codelineno-9-193" name="__codelineno-9-193" href="#__codelineno-9-193"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-9-194"><a id="__codelineno-9-194" name="__codelineno-9-194" href="#__codelineno-9-194"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Counter increment failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-9-195"><a id="__codelineno-9-195" name="__codelineno-9-195" href="#__codelineno-9-195"></a>                <span class="k">raise</span>
</span><span id="__span-9-196"><a id="__codelineno-9-196" name="__codelineno-9-196" href="#__codelineno-9-196"></a>
</span><span id="__span-9-197"><a id="__codelineno-9-197" name="__codelineno-9-197" href="#__codelineno-9-197"></a><span class="k">class</span><span class="w"> </span><span class="nc">CacheInvalidator</span><span class="p">:</span>
</span><span id="__span-9-198"><a id="__codelineno-9-198" name="__codelineno-9-198" href="#__codelineno-9-198"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Distributed cache invalidation&quot;&quot;&quot;</span>
</span><span id="__span-9-199"><a id="__codelineno-9-199" name="__codelineno-9-199" href="#__codelineno-9-199"></a>
</span><span id="__span-9-200"><a id="__codelineno-9-200" name="__codelineno-9-200" href="#__codelineno-9-200"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-9-201"><a id="__codelineno-9-201" name="__codelineno-9-201" href="#__codelineno-9-201"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span>
</span><span id="__span-9-202"><a id="__codelineno-9-202" name="__codelineno-9-202" href="#__codelineno-9-202"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">topic</span> <span class="o">=</span> <span class="n">topic</span>
</span><span id="__span-9-203"><a id="__codelineno-9-203" name="__codelineno-9-203" href="#__codelineno-9-203"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">subscribers</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-9-204"><a id="__codelineno-9-204" name="__codelineno-9-204" href="#__codelineno-9-204"></a>
</span><span id="__span-9-205"><a id="__codelineno-9-205" name="__codelineno-9-205" href="#__codelineno-9-205"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">publish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="__span-9-206"><a id="__codelineno-9-206" name="__codelineno-9-206" href="#__codelineno-9-206"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Publish cache invalidation event&quot;&quot;&quot;</span>
</span><span id="__span-9-207"><a id="__codelineno-9-207" name="__codelineno-9-207" href="#__codelineno-9-207"></a>        <span class="n">message</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="__span-9-208"><a id="__codelineno-9-208" name="__codelineno-9-208" href="#__codelineno-9-208"></a>        <span class="n">message_bytes</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">message</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span><span id="__span-9-209"><a id="__codelineno-9-209" name="__codelineno-9-209" href="#__codelineno-9-209"></a>
</span><span id="__span-9-210"><a id="__codelineno-9-210" name="__codelineno-9-210" href="#__codelineno-9-210"></a>        <span class="c1"># Publish to all subscribers</span>
</span><span id="__span-9-211"><a id="__codelineno-9-211" name="__codelineno-9-211" href="#__codelineno-9-211"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">,</span> <span class="n">KazooClient</span><span class="p">):</span>
</span><span id="__span-9-212"><a id="__codelineno-9-212" name="__codelineno-9-212" href="#__codelineno-9-212"></a>            <span class="c1"># Use Zookeeper watchers</span>
</span><span id="__span-9-213"><a id="__codelineno-9-213" name="__codelineno-9-213" href="#__codelineno-9-213"></a>            <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time_ns</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-9-214"><a id="__codelineno-9-214" name="__codelineno-9-214" href="#__codelineno-9-214"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">message_bytes</span><span class="p">,</span> <span class="n">sequence</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-9-215"><a id="__codelineno-9-215" name="__codelineno-9-215" href="#__codelineno-9-215"></a>        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">,</span> <span class="s1">&#39;kv&#39;</span><span class="p">):</span>  <span class="c1"># etcd</span>
</span><span id="__span-9-216"><a id="__codelineno-9-216" name="__codelineno-9-216" href="#__codelineno-9-216"></a>            <span class="c1"># Use etcd pub/sub</span>
</span><span id="__span-9-217"><a id="__codelineno-9-217" name="__codelineno-9-217" href="#__codelineno-9-217"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
</span><span id="__span-9-218"><a id="__codelineno-9-218" name="__codelineno-9-218" href="#__codelineno-9-218"></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">message</span><span class="p">[</span><span class="s1">&#39;short_code&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="__span-9-219"><a id="__codelineno-9-219" name="__codelineno-9-219" href="#__codelineno-9-219"></a>                <span class="n">message_bytes</span><span class="p">,</span>
</span><span id="__span-9-220"><a id="__codelineno-9-220" name="__codelineno-9-220" href="#__codelineno-9-220"></a>                <span class="n">lease</span><span class="o">=</span><span class="mi">60</span>  <span class="c1"># Auto-expire</span>
</span><span id="__span-9-221"><a id="__codelineno-9-221" name="__codelineno-9-221" href="#__codelineno-9-221"></a>            <span class="p">)</span>
</span><span id="__span-9-222"><a id="__codelineno-9-222" name="__codelineno-9-222" href="#__codelineno-9-222"></a>
</span><span id="__span-9-223"><a id="__codelineno-9-223" name="__codelineno-9-223" href="#__codelineno-9-223"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">subscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">):</span>
</span><span id="__span-9-224"><a id="__codelineno-9-224" name="__codelineno-9-224" href="#__codelineno-9-224"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Subscribe to invalidation events&quot;&quot;&quot;</span>
</span><span id="__span-9-225"><a id="__codelineno-9-225" name="__codelineno-9-225" href="#__codelineno-9-225"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">,</span> <span class="n">KazooClient</span><span class="p">):</span>
</span><span id="__span-9-226"><a id="__codelineno-9-226" name="__codelineno-9-226" href="#__codelineno-9-226"></a>            <span class="nd">@self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">ChildrenWatch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topic</span><span class="p">)</span>
</span><span id="__span-9-227"><a id="__codelineno-9-227" name="__codelineno-9-227" href="#__codelineno-9-227"></a>            <span class="k">def</span><span class="w"> </span><span class="nf">watch_children</span><span class="p">(</span><span class="n">children</span><span class="p">):</span>
</span><span id="__span-9-228"><a id="__codelineno-9-228" name="__codelineno-9-228" href="#__codelineno-9-228"></a>                <span class="c1"># Process new events</span>
</span><span id="__span-9-229"><a id="__codelineno-9-229" name="__codelineno-9-229" href="#__codelineno-9-229"></a>                <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_process_events</span><span class="p">(</span><span class="n">children</span><span class="p">,</span> <span class="n">callback</span><span class="p">))</span>
</span><span id="__span-9-230"><a id="__codelineno-9-230" name="__codelineno-9-230" href="#__codelineno-9-230"></a>
</span><span id="__span-9-231"><a id="__codelineno-9-231" name="__codelineno-9-231" href="#__codelineno-9-231"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">subscribers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
</span></code></pre></div></p>
<h4 id="axiom-6-observability-analytics-pipeline">👁️ Axiom 6 (Observability): Analytics Pipeline<a class="headerlink" href="#axiom-6-observability-analytics-pipeline" title="Permanent link">&para;</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>Analytics Requirements:
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>- Click tracking (time, location, device)
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>- Referrer analysis
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>- Geographic distribution
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>- Time series data
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>- Real-time dashboards
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>- Custom reports
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>Pipeline Architecture:
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>- Clickstream capture
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>- Stream processing
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>- Data warehouse
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>- Real-time aggregation
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>- Dashboard API
</span></code></pre></div>
<p><strong>Implementation:</strong>
<div class="language-python highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">aiokafka</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">clickhouse_driver</span><span class="w"> </span><span class="kn">import</span> <span class="n">Client</span> <span class="k">as</span> <span class="n">ClickHouseClient</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">prometheus_client</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">AnalyticsURLShortener</span><span class="p">:</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>        <span class="c1"># Metrics collection</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">click_counter</span> <span class="o">=</span> <span class="n">prometheus_client</span><span class="o">.</span><span class="n">Counter</span><span class="p">(</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>            <span class="s1">&#39;url_shortener_clicks_total&#39;</span><span class="p">,</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>            <span class="s1">&#39;Total clicks&#39;</span><span class="p">,</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>            <span class="p">[</span><span class="s1">&#39;short_code&#39;</span><span class="p">,</span> <span class="s1">&#39;region&#39;</span><span class="p">,</span> <span class="s1">&#39;device_type&#39;</span><span class="p">]</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>        <span class="p">)</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">latency_histogram</span> <span class="o">=</span> <span class="n">prometheus_client</span><span class="o">.</span><span class="n">Histogram</span><span class="p">(</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>            <span class="s1">&#39;url_shortener_redirect_latency_seconds&#39;</span><span class="p">,</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>            <span class="s1">&#39;Redirect latency&#39;</span><span class="p">,</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a>            <span class="n">buckets</span><span class="o">=</span><span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a>        <span class="p">)</span>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a>        <span class="c1"># Analytics pipeline</span>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">kafka_producer</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clickhouse_client</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stream_processor</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a>
</span><span id="__span-11-25"><a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a>        <span class="c1"># Real-time aggregates</span>
</span><span id="__span-11-26"><a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">realtime_stats</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-11-27"><a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a>            <span class="s1">&#39;clicks&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="__span-11-28"><a id="__codelineno-11-28" name="__codelineno-11-28" href="#__codelineno-11-28"></a>            <span class="s1">&#39;unique_visitors&#39;</span><span class="p">:</span> <span class="nb">set</span><span class="p">(),</span>
</span><span id="__span-11-29"><a id="__codelineno-11-29" name="__codelineno-11-29" href="#__codelineno-11-29"></a>            <span class="s1">&#39;countries&#39;</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
</span><span id="__span-11-30"><a id="__codelineno-11-30" name="__codelineno-11-30" href="#__codelineno-11-30"></a>            <span class="s1">&#39;referrers&#39;</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="__span-11-31"><a id="__codelineno-11-31" name="__codelineno-11-31" href="#__codelineno-11-31"></a>        <span class="p">})</span>
</span><span id="__span-11-32"><a id="__codelineno-11-32" name="__codelineno-11-32" href="#__codelineno-11-32"></a>
</span><span id="__span-11-33"><a id="__codelineno-11-33" name="__codelineno-11-33" href="#__codelineno-11-33"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">initialize_analytics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-11-34"><a id="__codelineno-11-34" name="__codelineno-11-34" href="#__codelineno-11-34"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize analytics pipeline&quot;&quot;&quot;</span>
</span><span id="__span-11-35"><a id="__codelineno-11-35" name="__codelineno-11-35" href="#__codelineno-11-35"></a>        <span class="c1"># Kafka for event streaming</span>
</span><span id="__span-11-36"><a id="__codelineno-11-36" name="__codelineno-11-36" href="#__codelineno-11-36"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">kafka_producer</span> <span class="o">=</span> <span class="n">aiokafka</span><span class="o">.</span><span class="n">AIOKafkaProducer</span><span class="p">(</span>
</span><span id="__span-11-37"><a id="__codelineno-11-37" name="__codelineno-11-37" href="#__codelineno-11-37"></a>            <span class="n">bootstrap_servers</span><span class="o">=</span><span class="s1">&#39;localhost:9092&#39;</span><span class="p">,</span>
</span><span id="__span-11-38"><a id="__codelineno-11-38" name="__codelineno-11-38" href="#__codelineno-11-38"></a>            <span class="n">value_serializer</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span><span id="__span-11-39"><a id="__codelineno-11-39" name="__codelineno-11-39" href="#__codelineno-11-39"></a>        <span class="p">)</span>
</span><span id="__span-11-40"><a id="__codelineno-11-40" name="__codelineno-11-40" href="#__codelineno-11-40"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">kafka_producer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="__span-11-41"><a id="__codelineno-11-41" name="__codelineno-11-41" href="#__codelineno-11-41"></a>
</span><span id="__span-11-42"><a id="__codelineno-11-42" name="__codelineno-11-42" href="#__codelineno-11-42"></a>        <span class="c1"># ClickHouse for analytics storage</span>
</span><span id="__span-11-43"><a id="__codelineno-11-43" name="__codelineno-11-43" href="#__codelineno-11-43"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clickhouse_client</span> <span class="o">=</span> <span class="n">ClickHouseClient</span><span class="p">(</span>
</span><span id="__span-11-44"><a id="__codelineno-11-44" name="__codelineno-11-44" href="#__codelineno-11-44"></a>            <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
</span><span id="__span-11-45"><a id="__codelineno-11-45" name="__codelineno-11-45" href="#__codelineno-11-45"></a>            <span class="n">database</span><span class="o">=</span><span class="s1">&#39;urlshortener&#39;</span>
</span><span id="__span-11-46"><a id="__codelineno-11-46" name="__codelineno-11-46" href="#__codelineno-11-46"></a>        <span class="p">)</span>
</span><span id="__span-11-47"><a id="__codelineno-11-47" name="__codelineno-11-47" href="#__codelineno-11-47"></a>
</span><span id="__span-11-48"><a id="__codelineno-11-48" name="__codelineno-11-48" href="#__codelineno-11-48"></a>        <span class="c1"># Start stream processor</span>
</span><span id="__span-11-49"><a id="__codelineno-11-49" name="__codelineno-11-49" href="#__codelineno-11-49"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stream_processor</span> <span class="o">=</span> <span class="n">StreamProcessor</span><span class="p">()</span>
</span><span id="__span-11-50"><a id="__codelineno-11-50" name="__codelineno-11-50" href="#__codelineno-11-50"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_processor</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="__span-11-51"><a id="__codelineno-11-51" name="__codelineno-11-51" href="#__codelineno-11-51"></a>
</span><span id="__span-11-52"><a id="__codelineno-11-52" name="__codelineno-11-52" href="#__codelineno-11-52"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">track_click</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">short_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">request_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="__span-11-53"><a id="__codelineno-11-53" name="__codelineno-11-53" href="#__codelineno-11-53"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Track click event with rich analytics&quot;&quot;&quot;</span>
</span><span id="__span-11-54"><a id="__codelineno-11-54" name="__codelineno-11-54" href="#__codelineno-11-54"></a>        <span class="c1"># Extract analytics data</span>
</span><span id="__span-11-55"><a id="__codelineno-11-55" name="__codelineno-11-55" href="#__codelineno-11-55"></a>        <span class="n">event</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-11-56"><a id="__codelineno-11-56" name="__codelineno-11-56" href="#__codelineno-11-56"></a>            <span class="s1">&#39;event_id&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
</span><span id="__span-11-57"><a id="__codelineno-11-57" name="__codelineno-11-57" href="#__codelineno-11-57"></a>            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
</span><span id="__span-11-58"><a id="__codelineno-11-58" name="__codelineno-11-58" href="#__codelineno-11-58"></a>            <span class="s1">&#39;short_code&#39;</span><span class="p">:</span> <span class="n">short_code</span><span class="p">,</span>
</span><span id="__span-11-59"><a id="__codelineno-11-59" name="__codelineno-11-59" href="#__codelineno-11-59"></a>            <span class="s1">&#39;ip&#39;</span><span class="p">:</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ip&#39;</span><span class="p">),</span>
</span><span id="__span-11-60"><a id="__codelineno-11-60" name="__codelineno-11-60" href="#__codelineno-11-60"></a>            <span class="s1">&#39;user_agent&#39;</span><span class="p">:</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_agent&#39;</span><span class="p">),</span>
</span><span id="__span-11-61"><a id="__codelineno-11-61" name="__codelineno-11-61" href="#__codelineno-11-61"></a>            <span class="s1">&#39;referer&#39;</span><span class="p">:</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;referer&#39;</span><span class="p">),</span>
</span><span id="__span-11-62"><a id="__codelineno-11-62" name="__codelineno-11-62" href="#__codelineno-11-62"></a>            <span class="s1">&#39;accept_language&#39;</span><span class="p">:</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;accept_language&#39;</span><span class="p">),</span>
</span><span id="__span-11-63"><a id="__codelineno-11-63" name="__codelineno-11-63" href="#__codelineno-11-63"></a>            <span class="s1">&#39;query_params&#39;</span><span class="p">:</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;query_params&#39;</span><span class="p">,</span> <span class="p">{}),</span>
</span><span id="__span-11-64"><a id="__codelineno-11-64" name="__codelineno-11-64" href="#__codelineno-11-64"></a>
</span><span id="__span-11-65"><a id="__codelineno-11-65" name="__codelineno-11-65" href="#__codelineno-11-65"></a>            <span class="c1"># Derived fields</span>
</span><span id="__span-11-66"><a id="__codelineno-11-66" name="__codelineno-11-66" href="#__codelineno-11-66"></a>            <span class="s1">&#39;country&#39;</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_country_from_ip</span><span class="p">(</span><span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ip&#39;</span><span class="p">)),</span>
</span><span id="__span-11-67"><a id="__codelineno-11-67" name="__codelineno-11-67" href="#__codelineno-11-67"></a>            <span class="s1">&#39;device_type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_device_type</span><span class="p">(</span><span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_agent&#39;</span><span class="p">)),</span>
</span><span id="__span-11-68"><a id="__codelineno-11-68" name="__codelineno-11-68" href="#__codelineno-11-68"></a>            <span class="s1">&#39;browser&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_browser</span><span class="p">(</span><span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_agent&#39;</span><span class="p">)),</span>
</span><span id="__span-11-69"><a id="__codelineno-11-69" name="__codelineno-11-69" href="#__codelineno-11-69"></a>            <span class="s1">&#39;os&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_os</span><span class="p">(</span><span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_agent&#39;</span><span class="p">)),</span>
</span><span id="__span-11-70"><a id="__codelineno-11-70" name="__codelineno-11-70" href="#__codelineno-11-70"></a>            <span class="s1">&#39;is_bot&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_bot</span><span class="p">(</span><span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_agent&#39;</span><span class="p">)),</span>
</span><span id="__span-11-71"><a id="__codelineno-11-71" name="__codelineno-11-71" href="#__codelineno-11-71"></a>
</span><span id="__span-11-72"><a id="__codelineno-11-72" name="__codelineno-11-72" href="#__codelineno-11-72"></a>            <span class="c1"># UTM parameters</span>
</span><span id="__span-11-73"><a id="__codelineno-11-73" name="__codelineno-11-73" href="#__codelineno-11-73"></a>            <span class="s1">&#39;utm_source&#39;</span><span class="p">:</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;query_params&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;utm_source&#39;</span><span class="p">),</span>
</span><span id="__span-11-74"><a id="__codelineno-11-74" name="__codelineno-11-74" href="#__codelineno-11-74"></a>            <span class="s1">&#39;utm_medium&#39;</span><span class="p">:</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;query_params&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;utm_medium&#39;</span><span class="p">),</span>
</span><span id="__span-11-75"><a id="__codelineno-11-75" name="__codelineno-11-75" href="#__codelineno-11-75"></a>            <span class="s1">&#39;utm_campaign&#39;</span><span class="p">:</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;query_params&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;utm_campaign&#39;</span><span class="p">)</span>
</span><span id="__span-11-76"><a id="__codelineno-11-76" name="__codelineno-11-76" href="#__codelineno-11-76"></a>        <span class="p">}</span>
</span><span id="__span-11-77"><a id="__codelineno-11-77" name="__codelineno-11-77" href="#__codelineno-11-77"></a>
</span><span id="__span-11-78"><a id="__codelineno-11-78" name="__codelineno-11-78" href="#__codelineno-11-78"></a>        <span class="c1"># Update metrics</span>
</span><span id="__span-11-79"><a id="__codelineno-11-79" name="__codelineno-11-79" href="#__codelineno-11-79"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">click_counter</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span>
</span><span id="__span-11-80"><a id="__codelineno-11-80" name="__codelineno-11-80" href="#__codelineno-11-80"></a>            <span class="n">short_code</span><span class="o">=</span><span class="n">short_code</span><span class="p">,</span>
</span><span id="__span-11-81"><a id="__codelineno-11-81" name="__codelineno-11-81" href="#__codelineno-11-81"></a>            <span class="n">region</span><span class="o">=</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;country&#39;</span><span class="p">],</span>
</span><span id="__span-11-82"><a id="__codelineno-11-82" name="__codelineno-11-82" href="#__codelineno-11-82"></a>            <span class="n">device_type</span><span class="o">=</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;device_type&#39;</span><span class="p">]</span>
</span><span id="__span-11-83"><a id="__codelineno-11-83" name="__codelineno-11-83" href="#__codelineno-11-83"></a>        <span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
</span><span id="__span-11-84"><a id="__codelineno-11-84" name="__codelineno-11-84" href="#__codelineno-11-84"></a>
</span><span id="__span-11-85"><a id="__codelineno-11-85" name="__codelineno-11-85" href="#__codelineno-11-85"></a>        <span class="c1"># Send to Kafka</span>
</span><span id="__span-11-86"><a id="__codelineno-11-86" name="__codelineno-11-86" href="#__codelineno-11-86"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">kafka_producer</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
</span><span id="__span-11-87"><a id="__codelineno-11-87" name="__codelineno-11-87" href="#__codelineno-11-87"></a>            <span class="s1">&#39;url_clicks&#39;</span><span class="p">,</span>
</span><span id="__span-11-88"><a id="__codelineno-11-88" name="__codelineno-11-88" href="#__codelineno-11-88"></a>            <span class="n">value</span><span class="o">=</span><span class="n">event</span><span class="p">,</span>
</span><span id="__span-11-89"><a id="__codelineno-11-89" name="__codelineno-11-89" href="#__codelineno-11-89"></a>            <span class="n">key</span><span class="o">=</span><span class="n">short_code</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span><span id="__span-11-90"><a id="__codelineno-11-90" name="__codelineno-11-90" href="#__codelineno-11-90"></a>        <span class="p">)</span>
</span><span id="__span-11-91"><a id="__codelineno-11-91" name="__codelineno-11-91" href="#__codelineno-11-91"></a>
</span><span id="__span-11-92"><a id="__codelineno-11-92" name="__codelineno-11-92" href="#__codelineno-11-92"></a>        <span class="c1"># Update real-time stats</span>
</span><span id="__span-11-93"><a id="__codelineno-11-93" name="__codelineno-11-93" href="#__codelineno-11-93"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_update_realtime_stats</span><span class="p">(</span><span class="n">short_code</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
</span><span id="__span-11-94"><a id="__codelineno-11-94" name="__codelineno-11-94" href="#__codelineno-11-94"></a>
</span><span id="__span-11-95"><a id="__codelineno-11-95" name="__codelineno-11-95" href="#__codelineno-11-95"></a>        <span class="c1"># Store in time-series database for fast queries</span>
</span><span id="__span-11-96"><a id="__codelineno-11-96" name="__codelineno-11-96" href="#__codelineno-11-96"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store_timeseries</span><span class="p">(</span><span class="n">short_code</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
</span><span id="__span-11-97"><a id="__codelineno-11-97" name="__codelineno-11-97" href="#__codelineno-11-97"></a>
</span><span id="__span-11-98"><a id="__codelineno-11-98" name="__codelineno-11-98" href="#__codelineno-11-98"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_update_realtime_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">short_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="__span-11-99"><a id="__codelineno-11-99" name="__codelineno-11-99" href="#__codelineno-11-99"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update in-memory real-time statistics&quot;&quot;&quot;</span>
</span><span id="__span-11-100"><a id="__codelineno-11-100" name="__codelineno-11-100" href="#__codelineno-11-100"></a>        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">realtime_stats</span><span class="p">[</span><span class="n">short_code</span><span class="p">]</span>
</span><span id="__span-11-101"><a id="__codelineno-11-101" name="__codelineno-11-101" href="#__codelineno-11-101"></a>
</span><span id="__span-11-102"><a id="__codelineno-11-102" name="__codelineno-11-102" href="#__codelineno-11-102"></a>        <span class="c1"># Increment clicks</span>
</span><span id="__span-11-103"><a id="__codelineno-11-103" name="__codelineno-11-103" href="#__codelineno-11-103"></a>        <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;clicks&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-11-104"><a id="__codelineno-11-104" name="__codelineno-11-104" href="#__codelineno-11-104"></a>
</span><span id="__span-11-105"><a id="__codelineno-11-105" name="__codelineno-11-105" href="#__codelineno-11-105"></a>        <span class="c1"># Track unique visitors (by IP + User-Agent hash)</span>
</span><span id="__span-11-106"><a id="__codelineno-11-106" name="__codelineno-11-106" href="#__codelineno-11-106"></a>        <span class="n">visitor_id</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span>
</span><span id="__span-11-107"><a id="__codelineno-11-107" name="__codelineno-11-107" href="#__codelineno-11-107"></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;ip&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;user_agent&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span><span id="__span-11-108"><a id="__codelineno-11-108" name="__codelineno-11-108" href="#__codelineno-11-108"></a>        <span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span><span id="__span-11-109"><a id="__codelineno-11-109" name="__codelineno-11-109" href="#__codelineno-11-109"></a>        <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;unique_visitors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">visitor_id</span><span class="p">)</span>
</span><span id="__span-11-110"><a id="__codelineno-11-110" name="__codelineno-11-110" href="#__codelineno-11-110"></a>
</span><span id="__span-11-111"><a id="__codelineno-11-111" name="__codelineno-11-111" href="#__codelineno-11-111"></a>        <span class="c1"># Geographic distribution</span>
</span><span id="__span-11-112"><a id="__codelineno-11-112" name="__codelineno-11-112" href="#__codelineno-11-112"></a>        <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;country&#39;</span><span class="p">]:</span>
</span><span id="__span-11-113"><a id="__codelineno-11-113" name="__codelineno-11-113" href="#__codelineno-11-113"></a>            <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;countries&#39;</span><span class="p">][</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;country&#39;</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-11-114"><a id="__codelineno-11-114" name="__codelineno-11-114" href="#__codelineno-11-114"></a>
</span><span id="__span-11-115"><a id="__codelineno-11-115" name="__codelineno-11-115" href="#__codelineno-11-115"></a>        <span class="c1"># Referrer tracking</span>
</span><span id="__span-11-116"><a id="__codelineno-11-116" name="__codelineno-11-116" href="#__codelineno-11-116"></a>        <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;referer&#39;</span><span class="p">]:</span>
</span><span id="__span-11-117"><a id="__codelineno-11-117" name="__codelineno-11-117" href="#__codelineno-11-117"></a>            <span class="n">domain</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;referer&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">netloc</span>
</span><span id="__span-11-118"><a id="__codelineno-11-118" name="__codelineno-11-118" href="#__codelineno-11-118"></a>            <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;referrers&#39;</span><span class="p">][</span><span class="n">domain</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-11-119"><a id="__codelineno-11-119" name="__codelineno-11-119" href="#__codelineno-11-119"></a>
</span><span id="__span-11-120"><a id="__codelineno-11-120" name="__codelineno-11-120" href="#__codelineno-11-120"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_analytics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">short_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">time_range</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;24h&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="__span-11-121"><a id="__codelineno-11-121" name="__codelineno-11-121" href="#__codelineno-11-121"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get comprehensive analytics for URL&quot;&quot;&quot;</span>
</span><span id="__span-11-122"><a id="__codelineno-11-122" name="__codelineno-11-122" href="#__codelineno-11-122"></a>        <span class="c1"># Parse time range</span>
</span><span id="__span-11-123"><a id="__codelineno-11-123" name="__codelineno-11-123" href="#__codelineno-11-123"></a>        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="__span-11-124"><a id="__codelineno-11-124" name="__codelineno-11-124" href="#__codelineno-11-124"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_time_range</span><span class="p">(</span><span class="n">time_range</span><span class="p">)</span>
</span><span id="__span-11-125"><a id="__codelineno-11-125" name="__codelineno-11-125" href="#__codelineno-11-125"></a>
</span><span id="__span-11-126"><a id="__codelineno-11-126" name="__codelineno-11-126" href="#__codelineno-11-126"></a>        <span class="c1"># Fetch from multiple sources in parallel</span>
</span><span id="__span-11-127"><a id="__codelineno-11-127" name="__codelineno-11-127" href="#__codelineno-11-127"></a>        <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
</span><span id="__span-11-128"><a id="__codelineno-11-128" name="__codelineno-11-128" href="#__codelineno-11-128"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_get_clickhouse_analytics</span><span class="p">(</span><span class="n">short_code</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">),</span>
</span><span id="__span-11-129"><a id="__codelineno-11-129" name="__codelineno-11-129" href="#__codelineno-11-129"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_get_realtime_analytics</span><span class="p">(</span><span class="n">short_code</span><span class="p">),</span>
</span><span id="__span-11-130"><a id="__codelineno-11-130" name="__codelineno-11-130" href="#__codelineno-11-130"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_get_geographic_analytics</span><span class="p">(</span><span class="n">short_code</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">),</span>
</span><span id="__span-11-131"><a id="__codelineno-11-131" name="__codelineno-11-131" href="#__codelineno-11-131"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_get_device_analytics</span><span class="p">(</span><span class="n">short_code</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">),</span>
</span><span id="__span-11-132"><a id="__codelineno-11-132" name="__codelineno-11-132" href="#__codelineno-11-132"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_get_referrer_analytics</span><span class="p">(</span><span class="n">short_code</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
</span><span id="__span-11-133"><a id="__codelineno-11-133" name="__codelineno-11-133" href="#__codelineno-11-133"></a>        <span class="p">)</span>
</span><span id="__span-11-134"><a id="__codelineno-11-134" name="__codelineno-11-134" href="#__codelineno-11-134"></a>
</span><span id="__span-11-135"><a id="__codelineno-11-135" name="__codelineno-11-135" href="#__codelineno-11-135"></a>        <span class="n">clickhouse_data</span><span class="p">,</span> <span class="n">realtime_data</span><span class="p">,</span> <span class="n">geo_data</span><span class="p">,</span> <span class="n">device_data</span><span class="p">,</span> <span class="n">referrer_data</span> <span class="o">=</span> <span class="n">results</span>
</span><span id="__span-11-136"><a id="__codelineno-11-136" name="__codelineno-11-136" href="#__codelineno-11-136"></a>
</span><span id="__span-11-137"><a id="__codelineno-11-137" name="__codelineno-11-137" href="#__codelineno-11-137"></a>        <span class="c1"># Combine and return</span>
</span><span id="__span-11-138"><a id="__codelineno-11-138" name="__codelineno-11-138" href="#__codelineno-11-138"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-11-139"><a id="__codelineno-11-139" name="__codelineno-11-139" href="#__codelineno-11-139"></a>            <span class="s1">&#39;short_code&#39;</span><span class="p">:</span> <span class="n">short_code</span><span class="p">,</span>
</span><span id="__span-11-140"><a id="__codelineno-11-140" name="__codelineno-11-140" href="#__codelineno-11-140"></a>            <span class="s1">&#39;time_range&#39;</span><span class="p">:</span> <span class="n">time_range</span><span class="p">,</span>
</span><span id="__span-11-141"><a id="__codelineno-11-141" name="__codelineno-11-141" href="#__codelineno-11-141"></a>            <span class="s1">&#39;total_clicks&#39;</span><span class="p">:</span> <span class="n">clickhouse_data</span><span class="p">[</span><span class="s1">&#39;total_clicks&#39;</span><span class="p">],</span>
</span><span id="__span-11-142"><a id="__codelineno-11-142" name="__codelineno-11-142" href="#__codelineno-11-142"></a>            <span class="s1">&#39;unique_visitors&#39;</span><span class="p">:</span> <span class="n">clickhouse_data</span><span class="p">[</span><span class="s1">&#39;unique_visitors&#39;</span><span class="p">],</span>
</span><span id="__span-11-143"><a id="__codelineno-11-143" name="__codelineno-11-143" href="#__codelineno-11-143"></a>            <span class="s1">&#39;average_daily_clicks&#39;</span><span class="p">:</span> <span class="n">clickhouse_data</span><span class="p">[</span><span class="s1">&#39;total_clicks&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">/</span> <span class="mi">86400</span><span class="p">),</span>
</span><span id="__span-11-144"><a id="__codelineno-11-144" name="__codelineno-11-144" href="#__codelineno-11-144"></a>
</span><span id="__span-11-145"><a id="__codelineno-11-145" name="__codelineno-11-145" href="#__codelineno-11-145"></a>            <span class="c1"># Time series</span>
</span><span id="__span-11-146"><a id="__codelineno-11-146" name="__codelineno-11-146" href="#__codelineno-11-146"></a>            <span class="s1">&#39;clicks_over_time&#39;</span><span class="p">:</span> <span class="n">clickhouse_data</span><span class="p">[</span><span class="s1">&#39;time_series&#39;</span><span class="p">],</span>
</span><span id="__span-11-147"><a id="__codelineno-11-147" name="__codelineno-11-147" href="#__codelineno-11-147"></a>
</span><span id="__span-11-148"><a id="__codelineno-11-148" name="__codelineno-11-148" href="#__codelineno-11-148"></a>            <span class="c1"># Geographic</span>
</span><span id="__span-11-149"><a id="__codelineno-11-149" name="__codelineno-11-149" href="#__codelineno-11-149"></a>            <span class="s1">&#39;top_countries&#39;</span><span class="p">:</span> <span class="n">geo_data</span><span class="p">[</span><span class="s1">&#39;top_countries&#39;</span><span class="p">],</span>
</span><span id="__span-11-150"><a id="__codelineno-11-150" name="__codelineno-11-150" href="#__codelineno-11-150"></a>            <span class="s1">&#39;geographic_distribution&#39;</span><span class="p">:</span> <span class="n">geo_data</span><span class="p">[</span><span class="s1">&#39;distribution&#39;</span><span class="p">],</span>
</span><span id="__span-11-151"><a id="__codelineno-11-151" name="__codelineno-11-151" href="#__codelineno-11-151"></a>
</span><span id="__span-11-152"><a id="__codelineno-11-152" name="__codelineno-11-152" href="#__codelineno-11-152"></a>            <span class="c1"># Devices</span>
</span><span id="__span-11-153"><a id="__codelineno-11-153" name="__codelineno-11-153" href="#__codelineno-11-153"></a>            <span class="s1">&#39;device_breakdown&#39;</span><span class="p">:</span> <span class="n">device_data</span><span class="p">,</span>
</span><span id="__span-11-154"><a id="__codelineno-11-154" name="__codelineno-11-154" href="#__codelineno-11-154"></a>
</span><span id="__span-11-155"><a id="__codelineno-11-155" name="__codelineno-11-155" href="#__codelineno-11-155"></a>            <span class="c1"># Referrers</span>
</span><span id="__span-11-156"><a id="__codelineno-11-156" name="__codelineno-11-156" href="#__codelineno-11-156"></a>            <span class="s1">&#39;top_referrers&#39;</span><span class="p">:</span> <span class="n">referrer_data</span><span class="p">[</span><span class="s1">&#39;top_referrers&#39;</span><span class="p">],</span>
</span><span id="__span-11-157"><a id="__codelineno-11-157" name="__codelineno-11-157" href="#__codelineno-11-157"></a>            <span class="s1">&#39;referrer_breakdown&#39;</span><span class="p">:</span> <span class="n">referrer_data</span><span class="p">[</span><span class="s1">&#39;breakdown&#39;</span><span class="p">],</span>
</span><span id="__span-11-158"><a id="__codelineno-11-158" name="__codelineno-11-158" href="#__codelineno-11-158"></a>
</span><span id="__span-11-159"><a id="__codelineno-11-159" name="__codelineno-11-159" href="#__codelineno-11-159"></a>            <span class="c1"># Real-time (last hour)</span>
</span><span id="__span-11-160"><a id="__codelineno-11-160" name="__codelineno-11-160" href="#__codelineno-11-160"></a>            <span class="s1">&#39;realtime&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-11-161"><a id="__codelineno-11-161" name="__codelineno-11-161" href="#__codelineno-11-161"></a>                <span class="s1">&#39;clicks_last_hour&#39;</span><span class="p">:</span> <span class="n">realtime_data</span><span class="p">[</span><span class="s1">&#39;clicks&#39;</span><span class="p">],</span>
</span><span id="__span-11-162"><a id="__codelineno-11-162" name="__codelineno-11-162" href="#__codelineno-11-162"></a>                <span class="s1">&#39;active_visitors&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">realtime_data</span><span class="p">[</span><span class="s1">&#39;unique_visitors&#39;</span><span class="p">])</span>
</span><span id="__span-11-163"><a id="__codelineno-11-163" name="__codelineno-11-163" href="#__codelineno-11-163"></a>            <span class="p">}</span>
</span><span id="__span-11-164"><a id="__codelineno-11-164" name="__codelineno-11-164" href="#__codelineno-11-164"></a>        <span class="p">}</span>
</span><span id="__span-11-165"><a id="__codelineno-11-165" name="__codelineno-11-165" href="#__codelineno-11-165"></a>
</span><span id="__span-11-166"><a id="__codelineno-11-166" name="__codelineno-11-166" href="#__codelineno-11-166"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_get_clickhouse_analytics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">short_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
</span><span id="__span-11-167"><a id="__codelineno-11-167" name="__codelineno-11-167" href="#__codelineno-11-167"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Query ClickHouse for historical analytics&quot;&quot;&quot;</span>
</span><span id="__span-11-168"><a id="__codelineno-11-168" name="__codelineno-11-168" href="#__codelineno-11-168"></a>        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
</span><span id="__span-11-169"><a id="__codelineno-11-169" name="__codelineno-11-169" href="#__codelineno-11-169"></a><span class="s2">        SELECT</span>
</span><span id="__span-11-170"><a id="__codelineno-11-170" name="__codelineno-11-170" href="#__codelineno-11-170"></a><span class="s2">            count() as total_clicks,</span>
</span><span id="__span-11-171"><a id="__codelineno-11-171" name="__codelineno-11-171" href="#__codelineno-11-171"></a><span class="s2">            uniqExact(visitor_id) as unique_visitors,</span>
</span><span id="__span-11-172"><a id="__codelineno-11-172" name="__codelineno-11-172" href="#__codelineno-11-172"></a><span class="s2">            toStartOfHour(timestamp) as hour,</span>
</span><span id="__span-11-173"><a id="__codelineno-11-173" name="__codelineno-11-173" href="#__codelineno-11-173"></a><span class="s2">            count() as clicks</span>
</span><span id="__span-11-174"><a id="__codelineno-11-174" name="__codelineno-11-174" href="#__codelineno-11-174"></a><span class="s2">        FROM url_clicks</span>
</span><span id="__span-11-175"><a id="__codelineno-11-175" name="__codelineno-11-175" href="#__codelineno-11-175"></a><span class="s2">        WHERE short_code = </span><span class="si">%(short_code)s</span>
</span><span id="__span-11-176"><a id="__codelineno-11-176" name="__codelineno-11-176" href="#__codelineno-11-176"></a><span class="s2">            AND timestamp &gt;= </span><span class="si">%(start_time)s</span>
</span><span id="__span-11-177"><a id="__codelineno-11-177" name="__codelineno-11-177" href="#__codelineno-11-177"></a><span class="s2">            AND timestamp &lt;= </span><span class="si">%(end_time)s</span>
</span><span id="__span-11-178"><a id="__codelineno-11-178" name="__codelineno-11-178" href="#__codelineno-11-178"></a><span class="s2">        GROUP BY hour</span>
</span><span id="__span-11-179"><a id="__codelineno-11-179" name="__codelineno-11-179" href="#__codelineno-11-179"></a><span class="s2">        ORDER BY hour</span>
</span><span id="__span-11-180"><a id="__codelineno-11-180" name="__codelineno-11-180" href="#__codelineno-11-180"></a><span class="s2">        &quot;&quot;&quot;</span>
</span><span id="__span-11-181"><a id="__codelineno-11-181" name="__codelineno-11-181" href="#__codelineno-11-181"></a>
</span><span id="__span-11-182"><a id="__codelineno-11-182" name="__codelineno-11-182" href="#__codelineno-11-182"></a>        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clickhouse_client</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="__span-11-183"><a id="__codelineno-11-183" name="__codelineno-11-183" href="#__codelineno-11-183"></a>            <span class="n">query</span><span class="p">,</span>
</span><span id="__span-11-184"><a id="__codelineno-11-184" name="__codelineno-11-184" href="#__codelineno-11-184"></a>            <span class="p">{</span>
</span><span id="__span-11-185"><a id="__codelineno-11-185" name="__codelineno-11-185" href="#__codelineno-11-185"></a>                <span class="s1">&#39;short_code&#39;</span><span class="p">:</span> <span class="n">short_code</span><span class="p">,</span>
</span><span id="__span-11-186"><a id="__codelineno-11-186" name="__codelineno-11-186" href="#__codelineno-11-186"></a>                <span class="s1">&#39;start_time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">start_time</span><span class="p">),</span>
</span><span id="__span-11-187"><a id="__codelineno-11-187" name="__codelineno-11-187" href="#__codelineno-11-187"></a>                <span class="s1">&#39;end_time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">end_time</span><span class="p">)</span>
</span><span id="__span-11-188"><a id="__codelineno-11-188" name="__codelineno-11-188" href="#__codelineno-11-188"></a>            <span class="p">}</span>
</span><span id="__span-11-189"><a id="__codelineno-11-189" name="__codelineno-11-189" href="#__codelineno-11-189"></a>        <span class="p">)</span>
</span><span id="__span-11-190"><a id="__codelineno-11-190" name="__codelineno-11-190" href="#__codelineno-11-190"></a>
</span><span id="__span-11-191"><a id="__codelineno-11-191" name="__codelineno-11-191" href="#__codelineno-11-191"></a>        <span class="c1"># Process results</span>
</span><span id="__span-11-192"><a id="__codelineno-11-192" name="__codelineno-11-192" href="#__codelineno-11-192"></a>        <span class="n">time_series</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;clicks&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]}</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">]</span>
</span><span id="__span-11-193"><a id="__codelineno-11-193" name="__codelineno-11-193" href="#__codelineno-11-193"></a>        <span class="n">total_clicks</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">)</span>
</span><span id="__span-11-194"><a id="__codelineno-11-194" name="__codelineno-11-194" href="#__codelineno-11-194"></a>        <span class="n">unique_visitors</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">result</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="__span-11-195"><a id="__codelineno-11-195" name="__codelineno-11-195" href="#__codelineno-11-195"></a>
</span><span id="__span-11-196"><a id="__codelineno-11-196" name="__codelineno-11-196" href="#__codelineno-11-196"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-11-197"><a id="__codelineno-11-197" name="__codelineno-11-197" href="#__codelineno-11-197"></a>            <span class="s1">&#39;total_clicks&#39;</span><span class="p">:</span> <span class="n">total_clicks</span><span class="p">,</span>
</span><span id="__span-11-198"><a id="__codelineno-11-198" name="__codelineno-11-198" href="#__codelineno-11-198"></a>            <span class="s1">&#39;unique_visitors&#39;</span><span class="p">:</span> <span class="n">unique_visitors</span><span class="p">,</span>
</span><span id="__span-11-199"><a id="__codelineno-11-199" name="__codelineno-11-199" href="#__codelineno-11-199"></a>            <span class="s1">&#39;time_series&#39;</span><span class="p">:</span> <span class="n">time_series</span>
</span><span id="__span-11-200"><a id="__codelineno-11-200" name="__codelineno-11-200" href="#__codelineno-11-200"></a>        <span class="p">}</span>
</span><span id="__span-11-201"><a id="__codelineno-11-201" name="__codelineno-11-201" href="#__codelineno-11-201"></a>
</span><span id="__span-11-202"><a id="__codelineno-11-202" name="__codelineno-11-202" href="#__codelineno-11-202"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">export_dashboard_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="__span-11-203"><a id="__codelineno-11-203" name="__codelineno-11-203" href="#__codelineno-11-203"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Export metrics for monitoring dashboard&quot;&quot;&quot;</span>
</span><span id="__span-11-204"><a id="__codelineno-11-204" name="__codelineno-11-204" href="#__codelineno-11-204"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-11-205"><a id="__codelineno-11-205" name="__codelineno-11-205" href="#__codelineno-11-205"></a>            <span class="s1">&#39;system_metrics&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-11-206"><a id="__codelineno-11-206" name="__codelineno-11-206" href="#__codelineno-11-206"></a>                <span class="s1">&#39;total_urls&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_total_urls</span><span class="p">(),</span>
</span><span id="__span-11-207"><a id="__codelineno-11-207" name="__codelineno-11-207" href="#__codelineno-11-207"></a>                <span class="s1">&#39;clicks_per_second&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_click_rate</span><span class="p">(),</span>
</span><span id="__span-11-208"><a id="__codelineno-11-208" name="__codelineno-11-208" href="#__codelineno-11-208"></a>                <span class="s1">&#39;active_short_codes&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">realtime_stats</span><span class="p">),</span>
</span><span id="__span-11-209"><a id="__codelineno-11-209" name="__codelineno-11-209" href="#__codelineno-11-209"></a>                <span class="s1">&#39;cache_hit_rate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cache_hit_rate</span><span class="p">(),</span>
</span><span id="__span-11-210"><a id="__codelineno-11-210" name="__codelineno-11-210" href="#__codelineno-11-210"></a>                <span class="s1">&#39;error_rate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_error_rate</span><span class="p">()</span>
</span><span id="__span-11-211"><a id="__codelineno-11-211" name="__codelineno-11-211" href="#__codelineno-11-211"></a>            <span class="p">},</span>
</span><span id="__span-11-212"><a id="__codelineno-11-212" name="__codelineno-11-212" href="#__codelineno-11-212"></a>            <span class="s1">&#39;performance_metrics&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-11-213"><a id="__codelineno-11-213" name="__codelineno-11-213" href="#__codelineno-11-213"></a>                <span class="s1">&#39;redirect_latency_p50&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">latency_histogram</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span>
</span><span id="__span-11-214"><a id="__codelineno-11-214" name="__codelineno-11-214" href="#__codelineno-11-214"></a>                <span class="s1">&#39;redirect_latency_p95&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">latency_histogram</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.95</span><span class="p">),</span>
</span><span id="__span-11-215"><a id="__codelineno-11-215" name="__codelineno-11-215" href="#__codelineno-11-215"></a>                <span class="s1">&#39;redirect_latency_p99&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">latency_histogram</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.99</span><span class="p">),</span>
</span><span id="__span-11-216"><a id="__codelineno-11-216" name="__codelineno-11-216" href="#__codelineno-11-216"></a>                <span class="s1">&#39;shorten_rate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_shorten_rate</span><span class="p">()</span>
</span><span id="__span-11-217"><a id="__codelineno-11-217" name="__codelineno-11-217" href="#__codelineno-11-217"></a>            <span class="p">},</span>
</span><span id="__span-11-218"><a id="__codelineno-11-218" name="__codelineno-11-218" href="#__codelineno-11-218"></a>            <span class="s1">&#39;top_urls&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_top_urls</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
</span><span id="__span-11-219"><a id="__codelineno-11-219" name="__codelineno-11-219" href="#__codelineno-11-219"></a>            <span class="s1">&#39;geographic_summary&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_geographic_summary</span><span class="p">(),</span>
</span><span id="__span-11-220"><a id="__codelineno-11-220" name="__codelineno-11-220" href="#__codelineno-11-220"></a>            <span class="s1">&#39;alerts&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_active_alerts</span><span class="p">()</span>
</span><span id="__span-11-221"><a id="__codelineno-11-221" name="__codelineno-11-221" href="#__codelineno-11-221"></a>        <span class="p">}</span>
</span><span id="__span-11-222"><a id="__codelineno-11-222" name="__codelineno-11-222" href="#__codelineno-11-222"></a>
</span><span id="__span-11-223"><a id="__codelineno-11-223" name="__codelineno-11-223" href="#__codelineno-11-223"></a><span class="k">class</span><span class="w"> </span><span class="nc">StreamProcessor</span><span class="p">:</span>
</span><span id="__span-11-224"><a id="__codelineno-11-224" name="__codelineno-11-224" href="#__codelineno-11-224"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Real-time stream processing for analytics&quot;&quot;&quot;</span>
</span><span id="__span-11-225"><a id="__codelineno-11-225" name="__codelineno-11-225" href="#__codelineno-11-225"></a>
</span><span id="__span-11-226"><a id="__codelineno-11-226" name="__codelineno-11-226" href="#__codelineno-11-226"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-11-227"><a id="__codelineno-11-227" name="__codelineno-11-227" href="#__codelineno-11-227"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">kafka_consumer</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-11-228"><a id="__codelineno-11-228" name="__codelineno-11-228" href="#__codelineno-11-228"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">processors</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-11-229"><a id="__codelineno-11-229" name="__codelineno-11-229" href="#__codelineno-11-229"></a>
</span><span id="__span-11-230"><a id="__codelineno-11-230" name="__codelineno-11-230" href="#__codelineno-11-230"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-11-231"><a id="__codelineno-11-231" name="__codelineno-11-231" href="#__codelineno-11-231"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Start stream processing&quot;&quot;&quot;</span>
</span><span id="__span-11-232"><a id="__codelineno-11-232" name="__codelineno-11-232" href="#__codelineno-11-232"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">kafka_consumer</span> <span class="o">=</span> <span class="n">aiokafka</span><span class="o">.</span><span class="n">AIOKafkaConsumer</span><span class="p">(</span>
</span><span id="__span-11-233"><a id="__codelineno-11-233" name="__codelineno-11-233" href="#__codelineno-11-233"></a>            <span class="s1">&#39;url_clicks&#39;</span><span class="p">,</span>
</span><span id="__span-11-234"><a id="__codelineno-11-234" name="__codelineno-11-234" href="#__codelineno-11-234"></a>            <span class="n">bootstrap_servers</span><span class="o">=</span><span class="s1">&#39;localhost:9092&#39;</span><span class="p">,</span>
</span><span id="__span-11-235"><a id="__codelineno-11-235" name="__codelineno-11-235" href="#__codelineno-11-235"></a>            <span class="n">group_id</span><span class="o">=</span><span class="s1">&#39;analytics_processor&#39;</span>
</span><span id="__span-11-236"><a id="__codelineno-11-236" name="__codelineno-11-236" href="#__codelineno-11-236"></a>        <span class="p">)</span>
</span><span id="__span-11-237"><a id="__codelineno-11-237" name="__codelineno-11-237" href="#__codelineno-11-237"></a>
</span><span id="__span-11-238"><a id="__codelineno-11-238" name="__codelineno-11-238" href="#__codelineno-11-238"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">kafka_consumer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="__span-11-239"><a id="__codelineno-11-239" name="__codelineno-11-239" href="#__codelineno-11-239"></a>
</span><span id="__span-11-240"><a id="__codelineno-11-240" name="__codelineno-11-240" href="#__codelineno-11-240"></a>        <span class="c1"># Start processors</span>
</span><span id="__span-11-241"><a id="__codelineno-11-241" name="__codelineno-11-241" href="#__codelineno-11-241"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>  <span class="c1"># 4 parallel processors</span>
</span><span id="__span-11-242"><a id="__codelineno-11-242" name="__codelineno-11-242" href="#__codelineno-11-242"></a>            <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_process_stream</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
</span><span id="__span-11-243"><a id="__codelineno-11-243" name="__codelineno-11-243" href="#__codelineno-11-243"></a>
</span><span id="__span-11-244"><a id="__codelineno-11-244" name="__codelineno-11-244" href="#__codelineno-11-244"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_process_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">processor_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="__span-11-245"><a id="__codelineno-11-245" name="__codelineno-11-245" href="#__codelineno-11-245"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Process click stream&quot;&quot;&quot;</span>
</span><span id="__span-11-246"><a id="__codelineno-11-246" name="__codelineno-11-246" href="#__codelineno-11-246"></a>        <span class="k">async</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kafka_consumer</span><span class="p">:</span>
</span><span id="__span-11-247"><a id="__codelineno-11-247" name="__codelineno-11-247" href="#__codelineno-11-247"></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="__span-11-248"><a id="__codelineno-11-248" name="__codelineno-11-248" href="#__codelineno-11-248"></a>                <span class="n">event</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</span><span id="__span-11-249"><a id="__codelineno-11-249" name="__codelineno-11-249" href="#__codelineno-11-249"></a>
</span><span id="__span-11-250"><a id="__codelineno-11-250" name="__codelineno-11-250" href="#__codelineno-11-250"></a>                <span class="c1"># Apply processors</span>
</span><span id="__span-11-251"><a id="__codelineno-11-251" name="__codelineno-11-251" href="#__codelineno-11-251"></a>                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
</span><span id="__span-11-252"><a id="__codelineno-11-252" name="__codelineno-11-252" href="#__codelineno-11-252"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_counters</span><span class="p">(</span><span class="n">event</span><span class="p">),</span>
</span><span id="__span-11-253"><a id="__codelineno-11-253" name="__codelineno-11-253" href="#__codelineno-11-253"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_detect_anomalies</span><span class="p">(</span><span class="n">event</span><span class="p">),</span>
</span><span id="__span-11-254"><a id="__codelineno-11-254" name="__codelineno-11-254" href="#__codelineno-11-254"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_leaderboard</span><span class="p">(</span><span class="n">event</span><span class="p">),</span>
</span><span id="__span-11-255"><a id="__codelineno-11-255" name="__codelineno-11-255" href="#__codelineno-11-255"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_check_abuse</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</span><span id="__span-11-256"><a id="__codelineno-11-256" name="__codelineno-11-256" href="#__codelineno-11-256"></a>                <span class="p">)</span>
</span><span id="__span-11-257"><a id="__codelineno-11-257" name="__codelineno-11-257" href="#__codelineno-11-257"></a>
</span><span id="__span-11-258"><a id="__codelineno-11-258" name="__codelineno-11-258" href="#__codelineno-11-258"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-11-259"><a id="__codelineno-11-259" name="__codelineno-11-259" href="#__codelineno-11-259"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stream processing error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></div></p>
<h4 id="axiom-7-human-interface-management-tools">👤 Axiom 7 (Human Interface): Management Tools<a class="headerlink" href="#axiom-7-human-interface-management-tools" title="Permanent link">&para;</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>User Interfaces:
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>- Developer API
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>- Admin dashboard
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>- Analytics portal
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>- Mobile apps
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>- Browser extensions
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>Management Features:
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>- Bulk operations
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>- Custom domains
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>- Team collaboration
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>- API keys
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>- Webhooks
</span></code></pre></div>
<p><strong>Implementation:</strong>
<div class="language-python highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Depends</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">HttpUrl</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">URLShortenerAPI</span><span class="p">:</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;URL Shortener API&quot;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s2">&quot;2.0&quot;</span><span class="p">)</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">auth</span> <span class="o">=</span> <span class="n">AuthManager</span><span class="p">()</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_routes</span><span class="p">()</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_routes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Define API endpoints&quot;&quot;&quot;</span>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>        <span class="c1"># Public endpoints</span>
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>        <span class="nd">@self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/shorten&quot;</span><span class="p">)</span>
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">shorten_url</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">ShortenRequest</span><span class="p">):</span>
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a><span class="sd">            Shorten a URL</span>
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a>
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a><span class="sd">            - **long_url**: The URL to shorten</span>
</span><span id="__span-13-21"><a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a><span class="sd">            - **custom_alias**: Optional custom short code</span>
</span><span id="__span-13-22"><a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a><span class="sd">            - **expires_at**: Optional expiration timestamp</span>
</span><span id="__span-13-23"><a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="__span-13-24"><a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="__span-13-25"><a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a>                <span class="c1"># Validate URL</span>
</span><span id="__span-13-26"><a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_valid_url</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">long_url</span><span class="p">):</span>
</span><span id="__span-13-27"><a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a>                    <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;Invalid URL format&quot;</span><span class="p">)</span>
</span><span id="__span-13-28"><a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a>
</span><span id="__span-13-29"><a id="__codelineno-13-29" name="__codelineno-13-29" href="#__codelineno-13-29"></a>                <span class="c1"># Check rate limits</span>
</span><span id="__span-13-30"><a id="__codelineno-13-30" name="__codelineno-13-30" href="#__codelineno-13-30"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_rate_limit</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">api_key</span><span class="p">):</span>
</span><span id="__span-13-31"><a id="__codelineno-13-31" name="__codelineno-13-31" href="#__codelineno-13-31"></a>                    <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="mi">429</span><span class="p">,</span> <span class="s2">&quot;Rate limit exceeded&quot;</span><span class="p">)</span>
</span><span id="__span-13-32"><a id="__codelineno-13-32" name="__codelineno-13-32" href="#__codelineno-13-32"></a>
</span><span id="__span-13-33"><a id="__codelineno-13-33" name="__codelineno-13-33" href="#__codelineno-13-33"></a>                <span class="c1"># Generate short URL</span>
</span><span id="__span-13-34"><a id="__codelineno-13-34" name="__codelineno-13-34" href="#__codelineno-13-34"></a>                <span class="n">short_url</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">shortener</span><span class="o">.</span><span class="n">shorten</span><span class="p">(</span>
</span><span id="__span-13-35"><a id="__codelineno-13-35" name="__codelineno-13-35" href="#__codelineno-13-35"></a>                    <span class="n">request</span><span class="o">.</span><span class="n">long_url</span><span class="p">,</span>
</span><span id="__span-13-36"><a id="__codelineno-13-36" name="__codelineno-13-36" href="#__codelineno-13-36"></a>                    <span class="n">custom_alias</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">custom_alias</span><span class="p">,</span>
</span><span id="__span-13-37"><a id="__codelineno-13-37" name="__codelineno-13-37" href="#__codelineno-13-37"></a>                    <span class="n">expires_at</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">expires_at</span><span class="p">,</span>
</span><span id="__span-13-38"><a id="__codelineno-13-38" name="__codelineno-13-38" href="#__codelineno-13-38"></a>                    <span class="n">user_id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user_id</span>
</span><span id="__span-13-39"><a id="__codelineno-13-39" name="__codelineno-13-39" href="#__codelineno-13-39"></a>                <span class="p">)</span>
</span><span id="__span-13-40"><a id="__codelineno-13-40" name="__codelineno-13-40" href="#__codelineno-13-40"></a>
</span><span id="__span-13-41"><a id="__codelineno-13-41" name="__codelineno-13-41" href="#__codelineno-13-41"></a>                <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-13-42"><a id="__codelineno-13-42" name="__codelineno-13-42" href="#__codelineno-13-42"></a>                    <span class="s2">&quot;short_url&quot;</span><span class="p">:</span> <span class="n">short_url</span><span class="p">,</span>
</span><span id="__span-13-43"><a id="__codelineno-13-43" name="__codelineno-13-43" href="#__codelineno-13-43"></a>                    <span class="s2">&quot;long_url&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">long_url</span><span class="p">,</span>
</span><span id="__span-13-44"><a id="__codelineno-13-44" name="__codelineno-13-44" href="#__codelineno-13-44"></a>                    <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
</span><span id="__span-13-45"><a id="__codelineno-13-45" name="__codelineno-13-45" href="#__codelineno-13-45"></a>                    <span class="s2">&quot;expires_at&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">expires_at</span><span class="p">,</span>
</span><span id="__span-13-46"><a id="__codelineno-13-46" name="__codelineno-13-46" href="#__codelineno-13-46"></a>                    <span class="s2">&quot;qr_code&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_qr_code</span><span class="p">(</span><span class="n">short_url</span><span class="p">)</span>
</span><span id="__span-13-47"><a id="__codelineno-13-47" name="__codelineno-13-47" href="#__codelineno-13-47"></a>                <span class="p">}</span>
</span><span id="__span-13-48"><a id="__codelineno-13-48" name="__codelineno-13-48" href="#__codelineno-13-48"></a>
</span><span id="__span-13-49"><a id="__codelineno-13-49" name="__codelineno-13-49" href="#__codelineno-13-49"></a>            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-13-50"><a id="__codelineno-13-50" name="__codelineno-13-50" href="#__codelineno-13-50"></a>                <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span><span id="__span-13-51"><a id="__codelineno-13-51" name="__codelineno-13-51" href="#__codelineno-13-51"></a>
</span><span id="__span-13-52"><a id="__codelineno-13-52" name="__codelineno-13-52" href="#__codelineno-13-52"></a>        <span class="nd">@self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/api/v1/expand/</span><span class="si">{short_code}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-13-53"><a id="__codelineno-13-53" name="__codelineno-13-53" href="#__codelineno-13-53"></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">expand_url</span><span class="p">(</span><span class="n">short_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-13-54"><a id="__codelineno-13-54" name="__codelineno-13-54" href="#__codelineno-13-54"></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Get original URL without redirecting&quot;&quot;&quot;</span>
</span><span id="__span-13-55"><a id="__codelineno-13-55" name="__codelineno-13-55" href="#__codelineno-13-55"></a>            <span class="n">long_url</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">shortener</span><span class="o">.</span><span class="n">get_url</span><span class="p">(</span><span class="n">short_code</span><span class="p">)</span>
</span><span id="__span-13-56"><a id="__codelineno-13-56" name="__codelineno-13-56" href="#__codelineno-13-56"></a>
</span><span id="__span-13-57"><a id="__codelineno-13-57" name="__codelineno-13-57" href="#__codelineno-13-57"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">long_url</span><span class="p">:</span>
</span><span id="__span-13-58"><a id="__codelineno-13-58" name="__codelineno-13-58" href="#__codelineno-13-58"></a>                <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="s2">&quot;Short URL not found&quot;</span><span class="p">)</span>
</span><span id="__span-13-59"><a id="__codelineno-13-59" name="__codelineno-13-59" href="#__codelineno-13-59"></a>
</span><span id="__span-13-60"><a id="__codelineno-13-60" name="__codelineno-13-60" href="#__codelineno-13-60"></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-13-61"><a id="__codelineno-13-61" name="__codelineno-13-61" href="#__codelineno-13-61"></a>                <span class="s2">&quot;short_code&quot;</span><span class="p">:</span> <span class="n">short_code</span><span class="p">,</span>
</span><span id="__span-13-62"><a id="__codelineno-13-62" name="__codelineno-13-62" href="#__codelineno-13-62"></a>                <span class="s2">&quot;long_url&quot;</span><span class="p">:</span> <span class="n">long_url</span><span class="p">,</span>
</span><span id="__span-13-63"><a id="__codelineno-13-63" name="__codelineno-13-63" href="#__codelineno-13-63"></a>                <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_creation_time</span><span class="p">(</span><span class="n">short_code</span><span class="p">),</span>
</span><span id="__span-13-64"><a id="__codelineno-13-64" name="__codelineno-13-64" href="#__codelineno-13-64"></a>                <span class="s2">&quot;clicks&quot;</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_click_count</span><span class="p">(</span><span class="n">short_code</span><span class="p">)</span>
</span><span id="__span-13-65"><a id="__codelineno-13-65" name="__codelineno-13-65" href="#__codelineno-13-65"></a>            <span class="p">}</span>
</span><span id="__span-13-66"><a id="__codelineno-13-66" name="__codelineno-13-66" href="#__codelineno-13-66"></a>
</span><span id="__span-13-67"><a id="__codelineno-13-67" name="__codelineno-13-67" href="#__codelineno-13-67"></a>        <span class="c1"># Authenticated endpoints</span>
</span><span id="__span-13-68"><a id="__codelineno-13-68" name="__codelineno-13-68" href="#__codelineno-13-68"></a>        <span class="nd">@self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/api/v1/urls&quot;</span><span class="p">)</span>
</span><span id="__span-13-69"><a id="__codelineno-13-69" name="__codelineno-13-69" href="#__codelineno-13-69"></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_urls</span><span class="p">(</span>
</span><span id="__span-13-70"><a id="__codelineno-13-70" name="__codelineno-13-70" href="#__codelineno-13-70"></a>            <span class="n">user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">),</span>
</span><span id="__span-13-71"><a id="__codelineno-13-71" name="__codelineno-13-71" href="#__codelineno-13-71"></a>            <span class="n">page</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-13-72"><a id="__codelineno-13-72" name="__codelineno-13-72" href="#__codelineno-13-72"></a>            <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span>
</span><span id="__span-13-73"><a id="__codelineno-13-73" name="__codelineno-13-73" href="#__codelineno-13-73"></a>        <span class="p">):</span>
</span><span id="__span-13-74"><a id="__codelineno-13-74" name="__codelineno-13-74" href="#__codelineno-13-74"></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;List user&#39;s shortened URLs&quot;&quot;&quot;</span>
</span><span id="__span-13-75"><a id="__codelineno-13-75" name="__codelineno-13-75" href="#__codelineno-13-75"></a>            <span class="n">urls</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">shortener</span><span class="o">.</span><span class="n">get_user_urls</span><span class="p">(</span>
</span><span id="__span-13-76"><a id="__codelineno-13-76" name="__codelineno-13-76" href="#__codelineno-13-76"></a>                <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="__span-13-77"><a id="__codelineno-13-77" name="__codelineno-13-77" href="#__codelineno-13-77"></a>                <span class="n">offset</span><span class="o">=</span><span class="p">(</span><span class="n">page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">limit</span><span class="p">,</span>
</span><span id="__span-13-78"><a id="__codelineno-13-78" name="__codelineno-13-78" href="#__codelineno-13-78"></a>                <span class="n">limit</span><span class="o">=</span><span class="n">limit</span>
</span><span id="__span-13-79"><a id="__codelineno-13-79" name="__codelineno-13-79" href="#__codelineno-13-79"></a>            <span class="p">)</span>
</span><span id="__span-13-80"><a id="__codelineno-13-80" name="__codelineno-13-80" href="#__codelineno-13-80"></a>
</span><span id="__span-13-81"><a id="__codelineno-13-81" name="__codelineno-13-81" href="#__codelineno-13-81"></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-13-82"><a id="__codelineno-13-82" name="__codelineno-13-82" href="#__codelineno-13-82"></a>                <span class="s2">&quot;urls&quot;</span><span class="p">:</span> <span class="n">urls</span><span class="p">,</span>
</span><span id="__span-13-83"><a id="__codelineno-13-83" name="__codelineno-13-83" href="#__codelineno-13-83"></a>                <span class="s2">&quot;page&quot;</span><span class="p">:</span> <span class="n">page</span><span class="p">,</span>
</span><span id="__span-13-84"><a id="__codelineno-13-84" name="__codelineno-13-84" href="#__codelineno-13-84"></a>                <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">shortener</span><span class="o">.</span><span class="n">count_user_urls</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
</span><span id="__span-13-85"><a id="__codelineno-13-85" name="__codelineno-13-85" href="#__codelineno-13-85"></a>                <span class="s2">&quot;has_more&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">urls</span><span class="p">)</span> <span class="o">==</span> <span class="n">limit</span>
</span><span id="__span-13-86"><a id="__codelineno-13-86" name="__codelineno-13-86" href="#__codelineno-13-86"></a>            <span class="p">}</span>
</span><span id="__span-13-87"><a id="__codelineno-13-87" name="__codelineno-13-87" href="#__codelineno-13-87"></a>
</span><span id="__span-13-88"><a id="__codelineno-13-88" name="__codelineno-13-88" href="#__codelineno-13-88"></a>        <span class="nd">@self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/api/v1/analytics/</span><span class="si">{short_code}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-13-89"><a id="__codelineno-13-89" name="__codelineno-13-89" href="#__codelineno-13-89"></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_analytics</span><span class="p">(</span>
</span><span id="__span-13-90"><a id="__codelineno-13-90" name="__codelineno-13-90" href="#__codelineno-13-90"></a>            <span class="n">short_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-13-91"><a id="__codelineno-13-91" name="__codelineno-13-91" href="#__codelineno-13-91"></a>            <span class="n">time_range</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;7d&quot;</span><span class="p">,</span>
</span><span id="__span-13-92"><a id="__codelineno-13-92" name="__codelineno-13-92" href="#__codelineno-13-92"></a>            <span class="n">user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">)</span>
</span><span id="__span-13-93"><a id="__codelineno-13-93" name="__codelineno-13-93" href="#__codelineno-13-93"></a>        <span class="p">):</span>
</span><span id="__span-13-94"><a id="__codelineno-13-94" name="__codelineno-13-94" href="#__codelineno-13-94"></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Get detailed analytics for a short URL&quot;&quot;&quot;</span>
</span><span id="__span-13-95"><a id="__codelineno-13-95" name="__codelineno-13-95" href="#__codelineno-13-95"></a>            <span class="c1"># Verify ownership</span>
</span><span id="__span-13-96"><a id="__codelineno-13-96" name="__codelineno-13-96" href="#__codelineno-13-96"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_ownership</span><span class="p">(</span><span class="n">short_code</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
</span><span id="__span-13-97"><a id="__codelineno-13-97" name="__codelineno-13-97" href="#__codelineno-13-97"></a>                <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="s2">&quot;Access denied&quot;</span><span class="p">)</span>
</span><span id="__span-13-98"><a id="__codelineno-13-98" name="__codelineno-13-98" href="#__codelineno-13-98"></a>
</span><span id="__span-13-99"><a id="__codelineno-13-99" name="__codelineno-13-99" href="#__codelineno-13-99"></a>            <span class="n">analytics</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">analytics</span><span class="o">.</span><span class="n">get_analytics</span><span class="p">(</span>
</span><span id="__span-13-100"><a id="__codelineno-13-100" name="__codelineno-13-100" href="#__codelineno-13-100"></a>                <span class="n">short_code</span><span class="p">,</span>
</span><span id="__span-13-101"><a id="__codelineno-13-101" name="__codelineno-13-101" href="#__codelineno-13-101"></a>                <span class="n">time_range</span>
</span><span id="__span-13-102"><a id="__codelineno-13-102" name="__codelineno-13-102" href="#__codelineno-13-102"></a>            <span class="p">)</span>
</span><span id="__span-13-103"><a id="__codelineno-13-103" name="__codelineno-13-103" href="#__codelineno-13-103"></a>
</span><span id="__span-13-104"><a id="__codelineno-13-104" name="__codelineno-13-104" href="#__codelineno-13-104"></a>            <span class="k">return</span> <span class="n">analytics</span>
</span><span id="__span-13-105"><a id="__codelineno-13-105" name="__codelineno-13-105" href="#__codelineno-13-105"></a>
</span><span id="__span-13-106"><a id="__codelineno-13-106" name="__codelineno-13-106" href="#__codelineno-13-106"></a>        <span class="nd">@self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/bulk&quot;</span><span class="p">)</span>
</span><span id="__span-13-107"><a id="__codelineno-13-107" name="__codelineno-13-107" href="#__codelineno-13-107"></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">bulk_shorten</span><span class="p">(</span>
</span><span id="__span-13-108"><a id="__codelineno-13-108" name="__codelineno-13-108" href="#__codelineno-13-108"></a>            <span class="n">request</span><span class="p">:</span> <span class="n">BulkShortenRequest</span><span class="p">,</span>
</span><span id="__span-13-109"><a id="__codelineno-13-109" name="__codelineno-13-109" href="#__codelineno-13-109"></a>            <span class="n">user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">)</span>
</span><span id="__span-13-110"><a id="__codelineno-13-110" name="__codelineno-13-110" href="#__codelineno-13-110"></a>        <span class="p">):</span>
</span><span id="__span-13-111"><a id="__codelineno-13-111" name="__codelineno-13-111" href="#__codelineno-13-111"></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Shorten multiple URLs in one request&quot;&quot;&quot;</span>
</span><span id="__span-13-112"><a id="__codelineno-13-112" name="__codelineno-13-112" href="#__codelineno-13-112"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">urls</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
</span><span id="__span-13-113"><a id="__codelineno-13-113" name="__codelineno-13-113" href="#__codelineno-13-113"></a>                <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;Maximum 1000 URLs per request&quot;</span><span class="p">)</span>
</span><span id="__span-13-114"><a id="__codelineno-13-114" name="__codelineno-13-114" href="#__codelineno-13-114"></a>
</span><span id="__span-13-115"><a id="__codelineno-13-115" name="__codelineno-13-115" href="#__codelineno-13-115"></a>            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-13-116"><a id="__codelineno-13-116" name="__codelineno-13-116" href="#__codelineno-13-116"></a>            <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-13-117"><a id="__codelineno-13-117" name="__codelineno-13-117" href="#__codelineno-13-117"></a>
</span><span id="__span-13-118"><a id="__codelineno-13-118" name="__codelineno-13-118" href="#__codelineno-13-118"></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">url</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">urls</span><span class="p">):</span>
</span><span id="__span-13-119"><a id="__codelineno-13-119" name="__codelineno-13-119" href="#__codelineno-13-119"></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="__span-13-120"><a id="__codelineno-13-120" name="__codelineno-13-120" href="#__codelineno-13-120"></a>                    <span class="n">short_url</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">shortener</span><span class="o">.</span><span class="n">shorten</span><span class="p">(</span>
</span><span id="__span-13-121"><a id="__codelineno-13-121" name="__codelineno-13-121" href="#__codelineno-13-121"></a>                        <span class="n">url</span><span class="p">,</span>
</span><span id="__span-13-122"><a id="__codelineno-13-122" name="__codelineno-13-122" href="#__codelineno-13-122"></a>                        <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="__span-13-123"><a id="__codelineno-13-123" name="__codelineno-13-123" href="#__codelineno-13-123"></a>                        <span class="n">tags</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">tags</span>
</span><span id="__span-13-124"><a id="__codelineno-13-124" name="__codelineno-13-124" href="#__codelineno-13-124"></a>                    <span class="p">)</span>
</span><span id="__span-13-125"><a id="__codelineno-13-125" name="__codelineno-13-125" href="#__codelineno-13-125"></a>                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="__span-13-126"><a id="__codelineno-13-126" name="__codelineno-13-126" href="#__codelineno-13-126"></a>                        <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
</span><span id="__span-13-127"><a id="__codelineno-13-127" name="__codelineno-13-127" href="#__codelineno-13-127"></a>                        <span class="s2">&quot;long_url&quot;</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span>
</span><span id="__span-13-128"><a id="__codelineno-13-128" name="__codelineno-13-128" href="#__codelineno-13-128"></a>                        <span class="s2">&quot;short_url&quot;</span><span class="p">:</span> <span class="n">short_url</span>
</span><span id="__span-13-129"><a id="__codelineno-13-129" name="__codelineno-13-129" href="#__codelineno-13-129"></a>                    <span class="p">})</span>
</span><span id="__span-13-130"><a id="__codelineno-13-130" name="__codelineno-13-130" href="#__codelineno-13-130"></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-13-131"><a id="__codelineno-13-131" name="__codelineno-13-131" href="#__codelineno-13-131"></a>                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="__span-13-132"><a id="__codelineno-13-132" name="__codelineno-13-132" href="#__codelineno-13-132"></a>                        <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
</span><span id="__span-13-133"><a id="__codelineno-13-133" name="__codelineno-13-133" href="#__codelineno-13-133"></a>                        <span class="s2">&quot;long_url&quot;</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span>
</span><span id="__span-13-134"><a id="__codelineno-13-134" name="__codelineno-13-134" href="#__codelineno-13-134"></a>                        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="__span-13-135"><a id="__codelineno-13-135" name="__codelineno-13-135" href="#__codelineno-13-135"></a>                    <span class="p">})</span>
</span><span id="__span-13-136"><a id="__codelineno-13-136" name="__codelineno-13-136" href="#__codelineno-13-136"></a>
</span><span id="__span-13-137"><a id="__codelineno-13-137" name="__codelineno-13-137" href="#__codelineno-13-137"></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-13-138"><a id="__codelineno-13-138" name="__codelineno-13-138" href="#__codelineno-13-138"></a>                <span class="s2">&quot;successful&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">,</span>
</span><span id="__span-13-139"><a id="__codelineno-13-139" name="__codelineno-13-139" href="#__codelineno-13-139"></a>                <span class="s2">&quot;failed&quot;</span><span class="p">:</span> <span class="n">errors</span><span class="p">,</span>
</span><span id="__span-13-140"><a id="__codelineno-13-140" name="__codelineno-13-140" href="#__codelineno-13-140"></a>                <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">urls</span><span class="p">),</span>
</span><span id="__span-13-141"><a id="__codelineno-13-141" name="__codelineno-13-141" href="#__codelineno-13-141"></a>                <span class="s2">&quot;success_rate&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">urls</span><span class="p">)</span>
</span><span id="__span-13-142"><a id="__codelineno-13-142" name="__codelineno-13-142" href="#__codelineno-13-142"></a>            <span class="p">}</span>
</span><span id="__span-13-143"><a id="__codelineno-13-143" name="__codelineno-13-143" href="#__codelineno-13-143"></a>
</span><span id="__span-13-144"><a id="__codelineno-13-144" name="__codelineno-13-144" href="#__codelineno-13-144"></a>        <span class="c1"># Admin endpoints</span>
</span><span id="__span-13-145"><a id="__codelineno-13-145" name="__codelineno-13-145" href="#__codelineno-13-145"></a>        <span class="nd">@self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">&quot;/api/v1/admin/urls/</span><span class="si">{short_code}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-13-146"><a id="__codelineno-13-146" name="__codelineno-13-146" href="#__codelineno-13-146"></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">delete_url</span><span class="p">(</span>
</span><span id="__span-13-147"><a id="__codelineno-13-147" name="__codelineno-13-147" href="#__codelineno-13-147"></a>            <span class="n">short_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-13-148"><a id="__codelineno-13-148" name="__codelineno-13-148" href="#__codelineno-13-148"></a>            <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-13-149"><a id="__codelineno-13-149" name="__codelineno-13-149" href="#__codelineno-13-149"></a>            <span class="n">admin</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">require_admin</span><span class="p">)</span>
</span><span id="__span-13-150"><a id="__codelineno-13-150" name="__codelineno-13-150" href="#__codelineno-13-150"></a>        <span class="p">):</span>
</span><span id="__span-13-151"><a id="__codelineno-13-151" name="__codelineno-13-151" href="#__codelineno-13-151"></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Delete a URL (admin only)&quot;&quot;&quot;</span>
</span><span id="__span-13-152"><a id="__codelineno-13-152" name="__codelineno-13-152" href="#__codelineno-13-152"></a>            <span class="c1"># Soft delete with audit trail</span>
</span><span id="__span-13-153"><a id="__codelineno-13-153" name="__codelineno-13-153" href="#__codelineno-13-153"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">shortener</span><span class="o">.</span><span class="n">delete_url</span><span class="p">(</span>
</span><span id="__span-13-154"><a id="__codelineno-13-154" name="__codelineno-13-154" href="#__codelineno-13-154"></a>                <span class="n">short_code</span><span class="p">,</span>
</span><span id="__span-13-155"><a id="__codelineno-13-155" name="__codelineno-13-155" href="#__codelineno-13-155"></a>                <span class="n">deleted_by</span><span class="o">=</span><span class="n">admin</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="__span-13-156"><a id="__codelineno-13-156" name="__codelineno-13-156" href="#__codelineno-13-156"></a>                <span class="n">reason</span><span class="o">=</span><span class="n">reason</span>
</span><span id="__span-13-157"><a id="__codelineno-13-157" name="__codelineno-13-157" href="#__codelineno-13-157"></a>            <span class="p">)</span>
</span><span id="__span-13-158"><a id="__codelineno-13-158" name="__codelineno-13-158" href="#__codelineno-13-158"></a>
</span><span id="__span-13-159"><a id="__codelineno-13-159" name="__codelineno-13-159" href="#__codelineno-13-159"></a>            <span class="c1"># Invalidate caches</span>
</span><span id="__span-13-160"><a id="__codelineno-13-160" name="__codelineno-13-160" href="#__codelineno-13-160"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_invalidator</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="n">short_code</span><span class="p">)</span>
</span><span id="__span-13-161"><a id="__codelineno-13-161" name="__codelineno-13-161" href="#__codelineno-13-161"></a>
</span><span id="__span-13-162"><a id="__codelineno-13-162" name="__codelineno-13-162" href="#__codelineno-13-162"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;deleted&quot;</span><span class="p">,</span> <span class="s2">&quot;short_code&quot;</span><span class="p">:</span> <span class="n">short_code</span><span class="p">}</span>
</span><span id="__span-13-163"><a id="__codelineno-13-163" name="__codelineno-13-163" href="#__codelineno-13-163"></a>
</span><span id="__span-13-164"><a id="__codelineno-13-164" name="__codelineno-13-164" href="#__codelineno-13-164"></a>        <span class="nd">@self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/admin/blacklist&quot;</span><span class="p">)</span>
</span><span id="__span-13-165"><a id="__codelineno-13-165" name="__codelineno-13-165" href="#__codelineno-13-165"></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">add_to_blacklist</span><span class="p">(</span>
</span><span id="__span-13-166"><a id="__codelineno-13-166" name="__codelineno-13-166" href="#__codelineno-13-166"></a>            <span class="n">request</span><span class="p">:</span> <span class="n">BlacklistRequest</span><span class="p">,</span>
</span><span id="__span-13-167"><a id="__codelineno-13-167" name="__codelineno-13-167" href="#__codelineno-13-167"></a>            <span class="n">admin</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">require_admin</span><span class="p">)</span>
</span><span id="__span-13-168"><a id="__codelineno-13-168" name="__codelineno-13-168" href="#__codelineno-13-168"></a>        <span class="p">):</span>
</span><span id="__span-13-169"><a id="__codelineno-13-169" name="__codelineno-13-169" href="#__codelineno-13-169"></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Add URL pattern to blacklist&quot;&quot;&quot;</span>
</span><span id="__span-13-170"><a id="__codelineno-13-170" name="__codelineno-13-170" href="#__codelineno-13-170"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">blacklist</span><span class="o">.</span><span class="n">add_pattern</span><span class="p">(</span>
</span><span id="__span-13-171"><a id="__codelineno-13-171" name="__codelineno-13-171" href="#__codelineno-13-171"></a>                <span class="n">request</span><span class="o">.</span><span class="n">pattern</span><span class="p">,</span>
</span><span id="__span-13-172"><a id="__codelineno-13-172" name="__codelineno-13-172" href="#__codelineno-13-172"></a>                <span class="n">request</span><span class="o">.</span><span class="n">reason</span><span class="p">,</span>
</span><span id="__span-13-173"><a id="__codelineno-13-173" name="__codelineno-13-173" href="#__codelineno-13-173"></a>                <span class="n">added_by</span><span class="o">=</span><span class="n">admin</span><span class="o">.</span><span class="n">id</span>
</span><span id="__span-13-174"><a id="__codelineno-13-174" name="__codelineno-13-174" href="#__codelineno-13-174"></a>            <span class="p">)</span>
</span><span id="__span-13-175"><a id="__codelineno-13-175" name="__codelineno-13-175" href="#__codelineno-13-175"></a>
</span><span id="__span-13-176"><a id="__codelineno-13-176" name="__codelineno-13-176" href="#__codelineno-13-176"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;added&quot;</span><span class="p">,</span> <span class="s2">&quot;pattern&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">pattern</span><span class="p">}</span>
</span><span id="__span-13-177"><a id="__codelineno-13-177" name="__codelineno-13-177" href="#__codelineno-13-177"></a>
</span><span id="__span-13-178"><a id="__codelineno-13-178" name="__codelineno-13-178" href="#__codelineno-13-178"></a><span class="k">class</span><span class="w"> </span><span class="nc">AdminDashboard</span><span class="p">:</span>
</span><span id="__span-13-179"><a id="__codelineno-13-179" name="__codelineno-13-179" href="#__codelineno-13-179"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Web-based admin dashboard&quot;&quot;&quot;</span>
</span><span id="__span-13-180"><a id="__codelineno-13-180" name="__codelineno-13-180" href="#__codelineno-13-180"></a>
</span><span id="__span-13-181"><a id="__codelineno-13-181" name="__codelineno-13-181" href="#__codelineno-13-181"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-13-182"><a id="__codelineno-13-182" name="__codelineno-13-182" href="#__codelineno-13-182"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
</span><span id="__span-13-183"><a id="__codelineno-13-183" name="__codelineno-13-183" href="#__codelineno-13-183"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">templates</span> <span class="o">=</span> <span class="n">Jinja2Templates</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="s2">&quot;templates&quot;</span><span class="p">)</span>
</span><span id="__span-13-184"><a id="__codelineno-13-184" name="__codelineno-13-184" href="#__codelineno-13-184"></a>
</span><span id="__span-13-185"><a id="__codelineno-13-185" name="__codelineno-13-185" href="#__codelineno-13-185"></a>    <span class="nd">@self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/admin/&quot;</span><span class="p">)</span>
</span><span id="__span-13-186"><a id="__codelineno-13-186" name="__codelineno-13-186" href="#__codelineno-13-186"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">dashboard</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">):</span>
</span><span id="__span-13-187"><a id="__codelineno-13-187" name="__codelineno-13-187" href="#__codelineno-13-187"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Main dashboard view&quot;&quot;&quot;</span>
</span><span id="__span-13-188"><a id="__codelineno-13-188" name="__codelineno-13-188" href="#__codelineno-13-188"></a>        <span class="n">stats</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_system_stats</span><span class="p">()</span>
</span><span id="__span-13-189"><a id="__codelineno-13-189" name="__codelineno-13-189" href="#__codelineno-13-189"></a>
</span><span id="__span-13-190"><a id="__codelineno-13-190" name="__codelineno-13-190" href="#__codelineno-13-190"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="o">.</span><span class="n">TemplateResponse</span><span class="p">(</span>
</span><span id="__span-13-191"><a id="__codelineno-13-191" name="__codelineno-13-191" href="#__codelineno-13-191"></a>            <span class="s2">&quot;admin/dashboard.html&quot;</span><span class="p">,</span>
</span><span id="__span-13-192"><a id="__codelineno-13-192" name="__codelineno-13-192" href="#__codelineno-13-192"></a>            <span class="p">{</span>
</span><span id="__span-13-193"><a id="__codelineno-13-193" name="__codelineno-13-193" href="#__codelineno-13-193"></a>                <span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="n">request</span><span class="p">,</span>
</span><span id="__span-13-194"><a id="__codelineno-13-194" name="__codelineno-13-194" href="#__codelineno-13-194"></a>                <span class="s2">&quot;stats&quot;</span><span class="p">:</span> <span class="n">stats</span><span class="p">,</span>
</span><span id="__span-13-195"><a id="__codelineno-13-195" name="__codelineno-13-195" href="#__codelineno-13-195"></a>                <span class="s2">&quot;alerts&quot;</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_active_alerts</span><span class="p">(),</span>
</span><span id="__span-13-196"><a id="__codelineno-13-196" name="__codelineno-13-196" href="#__codelineno-13-196"></a>                <span class="s2">&quot;top_urls&quot;</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_top_urls</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
</span><span id="__span-13-197"><a id="__codelineno-13-197" name="__codelineno-13-197" href="#__codelineno-13-197"></a>                <span class="s2">&quot;recent_errors&quot;</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_recent_errors</span><span class="p">()</span>
</span><span id="__span-13-198"><a id="__codelineno-13-198" name="__codelineno-13-198" href="#__codelineno-13-198"></a>            <span class="p">}</span>
</span><span id="__span-13-199"><a id="__codelineno-13-199" name="__codelineno-13-199" href="#__codelineno-13-199"></a>        <span class="p">)</span>
</span><span id="__span-13-200"><a id="__codelineno-13-200" name="__codelineno-13-200" href="#__codelineno-13-200"></a>
</span><span id="__span-13-201"><a id="__codelineno-13-201" name="__codelineno-13-201" href="#__codelineno-13-201"></a>    <span class="nd">@self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/admin/analytics&quot;</span><span class="p">)</span>
</span><span id="__span-13-202"><a id="__codelineno-13-202" name="__codelineno-13-202" href="#__codelineno-13-202"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">analytics_view</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">):</span>
</span><span id="__span-13-203"><a id="__codelineno-13-203" name="__codelineno-13-203" href="#__codelineno-13-203"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Analytics dashboard&quot;&quot;&quot;</span>
</span><span id="__span-13-204"><a id="__codelineno-13-204" name="__codelineno-13-204" href="#__codelineno-13-204"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="o">.</span><span class="n">TemplateResponse</span><span class="p">(</span>
</span><span id="__span-13-205"><a id="__codelineno-13-205" name="__codelineno-13-205" href="#__codelineno-13-205"></a>            <span class="s2">&quot;admin/analytics.html&quot;</span><span class="p">,</span>
</span><span id="__span-13-206"><a id="__codelineno-13-206" name="__codelineno-13-206" href="#__codelineno-13-206"></a>            <span class="p">{</span>
</span><span id="__span-13-207"><a id="__codelineno-13-207" name="__codelineno-13-207" href="#__codelineno-13-207"></a>                <span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="n">request</span><span class="p">,</span>
</span><span id="__span-13-208"><a id="__codelineno-13-208" name="__codelineno-13-208" href="#__codelineno-13-208"></a>                <span class="s2">&quot;charts_data&quot;</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_charts_data</span><span class="p">(),</span>
</span><span id="__span-13-209"><a id="__codelineno-13-209" name="__codelineno-13-209" href="#__codelineno-13-209"></a>                <span class="s2">&quot;geographic_data&quot;</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_geographic_data</span><span class="p">(),</span>
</span><span id="__span-13-210"><a id="__codelineno-13-210" name="__codelineno-13-210" href="#__codelineno-13-210"></a>                <span class="s2">&quot;device_stats&quot;</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_device_stats</span><span class="p">()</span>
</span><span id="__span-13-211"><a id="__codelineno-13-211" name="__codelineno-13-211" href="#__codelineno-13-211"></a>            <span class="p">}</span>
</span><span id="__span-13-212"><a id="__codelineno-13-212" name="__codelineno-13-212" href="#__codelineno-13-212"></a>        <span class="p">)</span>
</span><span id="__span-13-213"><a id="__codelineno-13-213" name="__codelineno-13-213" href="#__codelineno-13-213"></a>
</span><span id="__span-13-214"><a id="__codelineno-13-214" name="__codelineno-13-214" href="#__codelineno-13-214"></a>    <span class="nd">@self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/admin/actions/block-url&quot;</span><span class="p">)</span>
</span><span id="__span-13-215"><a id="__codelineno-13-215" name="__codelineno-13-215" href="#__codelineno-13-215"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">block_url</span><span class="p">(</span><span class="n">short_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-13-216"><a id="__codelineno-13-216" name="__codelineno-13-216" href="#__codelineno-13-216"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Block a URL&quot;&quot;&quot;</span>
</span><span id="__span-13-217"><a id="__codelineno-13-217" name="__codelineno-13-217" href="#__codelineno-13-217"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">shortener</span><span class="o">.</span><span class="n">block_url</span><span class="p">(</span><span class="n">short_code</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>
</span><span id="__span-13-218"><a id="__codelineno-13-218" name="__codelineno-13-218" href="#__codelineno-13-218"></a>
</span><span id="__span-13-219"><a id="__codelineno-13-219" name="__codelineno-13-219" href="#__codelineno-13-219"></a>        <span class="c1"># Send notification</span>
</span><span id="__span-13-220"><a id="__codelineno-13-220" name="__codelineno-13-220" href="#__codelineno-13-220"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">notifier</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
</span><span id="__span-13-221"><a id="__codelineno-13-221" name="__codelineno-13-221" href="#__codelineno-13-221"></a>            <span class="s2">&quot;URL_BLOCKED&quot;</span><span class="p">,</span>
</span><span id="__span-13-222"><a id="__codelineno-13-222" name="__codelineno-13-222" href="#__codelineno-13-222"></a>            <span class="p">{</span>
</span><span id="__span-13-223"><a id="__codelineno-13-223" name="__codelineno-13-223" href="#__codelineno-13-223"></a>                <span class="s2">&quot;short_code&quot;</span><span class="p">:</span> <span class="n">short_code</span><span class="p">,</span>
</span><span id="__span-13-224"><a id="__codelineno-13-224" name="__codelineno-13-224" href="#__codelineno-13-224"></a>                <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="n">reason</span><span class="p">,</span>
</span><span id="__span-13-225"><a id="__codelineno-13-225" name="__codelineno-13-225" href="#__codelineno-13-225"></a>                <span class="s2">&quot;blocked_by&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span>
</span><span id="__span-13-226"><a id="__codelineno-13-226" name="__codelineno-13-226" href="#__codelineno-13-226"></a>            <span class="p">}</span>
</span><span id="__span-13-227"><a id="__codelineno-13-227" name="__codelineno-13-227" href="#__codelineno-13-227"></a>        <span class="p">)</span>
</span><span id="__span-13-228"><a id="__codelineno-13-228" name="__codelineno-13-228" href="#__codelineno-13-228"></a>
</span><span id="__span-13-229"><a id="__codelineno-13-229" name="__codelineno-13-229" href="#__codelineno-13-229"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;blocked&quot;</span><span class="p">}</span>
</span><span id="__span-13-230"><a id="__codelineno-13-230" name="__codelineno-13-230" href="#__codelineno-13-230"></a>
</span><span id="__span-13-231"><a id="__codelineno-13-231" name="__codelineno-13-231" href="#__codelineno-13-231"></a><span class="k">class</span><span class="w"> </span><span class="nc">CLITool</span><span class="p">:</span>
</span><span id="__span-13-232"><a id="__codelineno-13-232" name="__codelineno-13-232" href="#__codelineno-13-232"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Command-line interface for URL shortener&quot;&quot;&quot;</span>
</span><span id="__span-13-233"><a id="__codelineno-13-233" name="__codelineno-13-233" href="#__codelineno-13-233"></a>
</span><span id="__span-13-234"><a id="__codelineno-13-234" name="__codelineno-13-234" href="#__codelineno-13-234"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-13-235"><a id="__codelineno-13-235" name="__codelineno-13-235" href="#__codelineno-13-235"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
</span><span id="__span-13-236"><a id="__codelineno-13-236" name="__codelineno-13-236" href="#__codelineno-13-236"></a>            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;URL Shortener CLI&quot;</span>
</span><span id="__span-13-237"><a id="__codelineno-13-237" name="__codelineno-13-237" href="#__codelineno-13-237"></a>        <span class="p">)</span>
</span><span id="__span-13-238"><a id="__codelineno-13-238" name="__codelineno-13-238" href="#__codelineno-13-238"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_commands</span><span class="p">()</span>
</span><span id="__span-13-239"><a id="__codelineno-13-239" name="__codelineno-13-239" href="#__codelineno-13-239"></a>
</span><span id="__span-13-240"><a id="__codelineno-13-240" name="__codelineno-13-240" href="#__codelineno-13-240"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_commands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-13-241"><a id="__codelineno-13-241" name="__codelineno-13-241" href="#__codelineno-13-241"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Define CLI commands&quot;&quot;&quot;</span>
</span><span id="__span-13-242"><a id="__codelineno-13-242" name="__codelineno-13-242" href="#__codelineno-13-242"></a>        <span class="n">subparsers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_subparsers</span><span class="p">(</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;command&#39;</span><span class="p">)</span>
</span><span id="__span-13-243"><a id="__codelineno-13-243" name="__codelineno-13-243" href="#__codelineno-13-243"></a>
</span><span id="__span-13-244"><a id="__codelineno-13-244" name="__codelineno-13-244" href="#__codelineno-13-244"></a>        <span class="c1"># Shorten command</span>
</span><span id="__span-13-245"><a id="__codelineno-13-245" name="__codelineno-13-245" href="#__codelineno-13-245"></a>        <span class="n">shorten</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s1">&#39;shorten&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Shorten a URL&#39;</span><span class="p">)</span>
</span><span id="__span-13-246"><a id="__codelineno-13-246" name="__codelineno-13-246" href="#__codelineno-13-246"></a>        <span class="n">shorten</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;URL to shorten&#39;</span><span class="p">)</span>
</span><span id="__span-13-247"><a id="__codelineno-13-247" name="__codelineno-13-247" href="#__codelineno-13-247"></a>        <span class="n">shorten</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--custom&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Custom alias&#39;</span><span class="p">)</span>
</span><span id="__span-13-248"><a id="__codelineno-13-248" name="__codelineno-13-248" href="#__codelineno-13-248"></a>        <span class="n">shorten</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--expires&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Expiration time&#39;</span><span class="p">)</span>
</span><span id="__span-13-249"><a id="__codelineno-13-249" name="__codelineno-13-249" href="#__codelineno-13-249"></a>
</span><span id="__span-13-250"><a id="__codelineno-13-250" name="__codelineno-13-250" href="#__codelineno-13-250"></a>        <span class="c1"># Analytics command</span>
</span><span id="__span-13-251"><a id="__codelineno-13-251" name="__codelineno-13-251" href="#__codelineno-13-251"></a>        <span class="n">analytics</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s1">&#39;analytics&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Get analytics&#39;</span><span class="p">)</span>
</span><span id="__span-13-252"><a id="__codelineno-13-252" name="__codelineno-13-252" href="#__codelineno-13-252"></a>        <span class="n">analytics</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;short_code&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Short code&#39;</span><span class="p">)</span>
</span><span id="__span-13-253"><a id="__codelineno-13-253" name="__codelineno-13-253" href="#__codelineno-13-253"></a>        <span class="n">analytics</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--range&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;7d&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Time range&#39;</span><span class="p">)</span>
</span><span id="__span-13-254"><a id="__codelineno-13-254" name="__codelineno-13-254" href="#__codelineno-13-254"></a>
</span><span id="__span-13-255"><a id="__codelineno-13-255" name="__codelineno-13-255" href="#__codelineno-13-255"></a>        <span class="c1"># Bulk command</span>
</span><span id="__span-13-256"><a id="__codelineno-13-256" name="__codelineno-13-256" href="#__codelineno-13-256"></a>        <span class="n">bulk</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s1">&#39;bulk&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Bulk operations&#39;</span><span class="p">)</span>
</span><span id="__span-13-257"><a id="__codelineno-13-257" name="__codelineno-13-257" href="#__codelineno-13-257"></a>        <span class="n">bulk</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;CSV file with URLs&#39;</span><span class="p">)</span>
</span><span id="__span-13-258"><a id="__codelineno-13-258" name="__codelineno-13-258" href="#__codelineno-13-258"></a>        <span class="n">bulk</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--output&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Output file&#39;</span><span class="p">)</span>
</span><span id="__span-13-259"><a id="__codelineno-13-259" name="__codelineno-13-259" href="#__codelineno-13-259"></a>
</span><span id="__span-13-260"><a id="__codelineno-13-260" name="__codelineno-13-260" href="#__codelineno-13-260"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
</span><span id="__span-13-261"><a id="__codelineno-13-261" name="__codelineno-13-261" href="#__codelineno-13-261"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute CLI command&quot;&quot;&quot;</span>
</span><span id="__span-13-262"><a id="__codelineno-13-262" name="__codelineno-13-262" href="#__codelineno-13-262"></a>        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">command</span> <span class="o">==</span> <span class="s1">&#39;shorten&#39;</span><span class="p">:</span>
</span><span id="__span-13-263"><a id="__codelineno-13-263" name="__codelineno-13-263" href="#__codelineno-13-263"></a>            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">shorten</span><span class="p">(</span>
</span><span id="__span-13-264"><a id="__codelineno-13-264" name="__codelineno-13-264" href="#__codelineno-13-264"></a>                <span class="n">args</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
</span><span id="__span-13-265"><a id="__codelineno-13-265" name="__codelineno-13-265" href="#__codelineno-13-265"></a>                <span class="n">custom_alias</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">custom</span><span class="p">,</span>
</span><span id="__span-13-266"><a id="__codelineno-13-266" name="__codelineno-13-266" href="#__codelineno-13-266"></a>                <span class="n">expires_at</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">expires</span>
</span><span id="__span-13-267"><a id="__codelineno-13-267" name="__codelineno-13-267" href="#__codelineno-13-267"></a>            <span class="p">)</span>
</span><span id="__span-13-268"><a id="__codelineno-13-268" name="__codelineno-13-268" href="#__codelineno-13-268"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Short URL: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;short_url&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-13-269"><a id="__codelineno-13-269" name="__codelineno-13-269" href="#__codelineno-13-269"></a>
</span><span id="__span-13-270"><a id="__codelineno-13-270" name="__codelineno-13-270" href="#__codelineno-13-270"></a>        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">command</span> <span class="o">==</span> <span class="s1">&#39;analytics&#39;</span><span class="p">:</span>
</span><span id="__span-13-271"><a id="__codelineno-13-271" name="__codelineno-13-271" href="#__codelineno-13-271"></a>            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get_analytics</span><span class="p">(</span>
</span><span id="__span-13-272"><a id="__codelineno-13-272" name="__codelineno-13-272" href="#__codelineno-13-272"></a>                <span class="n">args</span><span class="o">.</span><span class="n">short_code</span><span class="p">,</span>
</span><span id="__span-13-273"><a id="__codelineno-13-273" name="__codelineno-13-273" href="#__codelineno-13-273"></a>                <span class="n">time_range</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">range</span>
</span><span id="__span-13-274"><a id="__codelineno-13-274" name="__codelineno-13-274" href="#__codelineno-13-274"></a>            <span class="p">)</span>
</span><span id="__span-13-275"><a id="__codelineno-13-275" name="__codelineno-13-275" href="#__codelineno-13-275"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_print_analytics</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="__span-13-276"><a id="__codelineno-13-276" name="__codelineno-13-276" href="#__codelineno-13-276"></a>
</span><span id="__span-13-277"><a id="__codelineno-13-277" name="__codelineno-13-277" href="#__codelineno-13-277"></a>        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">command</span> <span class="o">==</span> <span class="s1">&#39;bulk&#39;</span><span class="p">:</span>
</span><span id="__span-13-278"><a id="__codelineno-13-278" name="__codelineno-13-278" href="#__codelineno-13-278"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_bulk</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
</span></code></pre></div></p>
<h4 id="axiom-8-economics-cost-optimization">💰 Axiom 8 (Economics): Cost Optimization<a class="headerlink" href="#axiom-8-economics-cost-optimization" title="Permanent link">&para;</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>Cost Components:
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>- Storage: $0.10/GB/month
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>- Bandwidth: $0.05/GB
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>- Compute: $0.10/hour
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>- Analytics: $0.01/million events
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>- CDN: $0.02/GB
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>Optimization Strategies:
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>- Aggressive caching
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>- URL deduplication
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>- Analytics sampling
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>- Tiered storage
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>- CDN optimization
</span></code></pre></div>
<p><strong>Implementation:</strong>
<div class="language-python highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">CostOptimizedURLShortener</span><span class="p">:</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cost_tracker</span> <span class="o">=</span> <span class="n">CostTracker</span><span class="p">()</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">CostOptimizer</span><span class="p">()</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>        <span class="c1"># Cost thresholds</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">monthly_budget</span> <span class="o">=</span> <span class="mi">10000</span>  <span class="c1"># $10,000</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cost_per_url_target</span> <span class="o">=</span> <span class="mf">0.00001</span>  <span class="c1"># $0.00001 per URL</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_costs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate current operational costs&quot;&quot;&quot;</span>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>        <span class="n">costs</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>            <span class="s1">&#39;storage&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_storage_cost</span><span class="p">(</span><span class="n">metrics</span><span class="p">),</span>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>            <span class="s1">&#39;bandwidth&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_bandwidth_cost</span><span class="p">(</span><span class="n">metrics</span><span class="p">),</span>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>            <span class="s1">&#39;compute&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_compute_cost</span><span class="p">(</span><span class="n">metrics</span><span class="p">),</span>
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a>            <span class="s1">&#39;analytics&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_analytics_cost</span><span class="p">(</span><span class="n">metrics</span><span class="p">),</span>
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a>            <span class="s1">&#39;cdn&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_cdn_cost</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a>        <span class="p">}</span>
</span><span id="__span-15-19"><a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a>
</span><span id="__span-15-20"><a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a>        <span class="n">costs</span><span class="p">[</span><span class="s1">&#39;total_monthly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">costs</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="__span-15-21"><a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a>        <span class="n">costs</span><span class="p">[</span><span class="s1">&#39;cost_per_url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">costs</span><span class="p">[</span><span class="s1">&#39;total_monthly&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;total_urls&#39;</span><span class="p">]</span>
</span><span id="__span-15-22"><a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a>        <span class="n">costs</span><span class="p">[</span><span class="s1">&#39;cost_per_redirect&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">costs</span><span class="p">[</span><span class="s1">&#39;total_monthly&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;monthly_redirects&#39;</span><span class="p">]</span>
</span><span id="__span-15-23"><a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a>
</span><span id="__span-15-24"><a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a>        <span class="k">return</span> <span class="n">costs</span>
</span><span id="__span-15-25"><a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a>
</span><span id="__span-15-26"><a id="__codelineno-15-26" name="__codelineno-15-26" href="#__codelineno-15-26"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">optimize_infrastructure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_costs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
</span><span id="__span-15-27"><a id="__codelineno-15-27" name="__codelineno-15-27" href="#__codelineno-15-27"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate cost optimization recommendations&quot;&quot;&quot;</span>
</span><span id="__span-15-28"><a id="__codelineno-15-28" name="__codelineno-15-28" href="#__codelineno-15-28"></a>        <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-15-29"><a id="__codelineno-15-29" name="__codelineno-15-29" href="#__codelineno-15-29"></a>
</span><span id="__span-15-30"><a id="__codelineno-15-30" name="__codelineno-15-30" href="#__codelineno-15-30"></a>        <span class="c1"># Storage optimization</span>
</span><span id="__span-15-31"><a id="__codelineno-15-31" name="__codelineno-15-31" href="#__codelineno-15-31"></a>        <span class="k">if</span> <span class="n">current_costs</span><span class="p">[</span><span class="s1">&#39;storage&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">monthly_budget</span> <span class="o">*</span> <span class="mf">0.3</span><span class="p">:</span>
</span><span id="__span-15-32"><a id="__codelineno-15-32" name="__codelineno-15-32" href="#__codelineno-15-32"></a>            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="__span-15-33"><a id="__codelineno-15-33" name="__codelineno-15-33" href="#__codelineno-15-33"></a>                <span class="s1">&#39;area&#39;</span><span class="p">:</span> <span class="s1">&#39;storage&#39;</span><span class="p">,</span>
</span><span id="__span-15-34"><a id="__codelineno-15-34" name="__codelineno-15-34" href="#__codelineno-15-34"></a>                <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;Enable compression and deduplication&#39;</span><span class="p">,</span>
</span><span id="__span-15-35"><a id="__codelineno-15-35" name="__codelineno-15-35" href="#__codelineno-15-35"></a>                <span class="s1">&#39;savings&#39;</span><span class="p">:</span> <span class="n">current_costs</span><span class="p">[</span><span class="s1">&#39;storage&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.4</span><span class="p">,</span>
</span><span id="__span-15-36"><a id="__codelineno-15-36" name="__codelineno-15-36" href="#__codelineno-15-36"></a>                <span class="s1">&#39;implementation&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_implement_storage_optimization</span>
</span><span id="__span-15-37"><a id="__codelineno-15-37" name="__codelineno-15-37" href="#__codelineno-15-37"></a>            <span class="p">})</span>
</span><span id="__span-15-38"><a id="__codelineno-15-38" name="__codelineno-15-38" href="#__codelineno-15-38"></a>
</span><span id="__span-15-39"><a id="__codelineno-15-39" name="__codelineno-15-39" href="#__codelineno-15-39"></a>        <span class="c1"># CDN optimization</span>
</span><span id="__span-15-40"><a id="__codelineno-15-40" name="__codelineno-15-40" href="#__codelineno-15-40"></a>        <span class="k">if</span> <span class="n">current_costs</span><span class="p">[</span><span class="s1">&#39;cdn&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">monthly_budget</span> <span class="o">*</span> <span class="mf">0.2</span><span class="p">:</span>
</span><span id="__span-15-41"><a id="__codelineno-15-41" name="__codelineno-15-41" href="#__codelineno-15-41"></a>            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="__span-15-42"><a id="__codelineno-15-42" name="__codelineno-15-42" href="#__codelineno-15-42"></a>                <span class="s1">&#39;area&#39;</span><span class="p">:</span> <span class="s1">&#39;cdn&#39;</span><span class="p">,</span>
</span><span id="__span-15-43"><a id="__codelineno-15-43" name="__codelineno-15-43" href="#__codelineno-15-43"></a>                <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;Increase cache TTL for popular URLs&#39;</span><span class="p">,</span>
</span><span id="__span-15-44"><a id="__codelineno-15-44" name="__codelineno-15-44" href="#__codelineno-15-44"></a>                <span class="s1">&#39;savings&#39;</span><span class="p">:</span> <span class="n">current_costs</span><span class="p">[</span><span class="s1">&#39;cdn&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.3</span><span class="p">,</span>
</span><span id="__span-15-45"><a id="__codelineno-15-45" name="__codelineno-15-45" href="#__codelineno-15-45"></a>                <span class="s1">&#39;implementation&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_implement_cdn_optimization</span>
</span><span id="__span-15-46"><a id="__codelineno-15-46" name="__codelineno-15-46" href="#__codelineno-15-46"></a>            <span class="p">})</span>
</span><span id="__span-15-47"><a id="__codelineno-15-47" name="__codelineno-15-47" href="#__codelineno-15-47"></a>
</span><span id="__span-15-48"><a id="__codelineno-15-48" name="__codelineno-15-48" href="#__codelineno-15-48"></a>        <span class="c1"># Analytics sampling</span>
</span><span id="__span-15-49"><a id="__codelineno-15-49" name="__codelineno-15-49" href="#__codelineno-15-49"></a>        <span class="k">if</span> <span class="n">current_costs</span><span class="p">[</span><span class="s1">&#39;analytics&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">monthly_budget</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">:</span>
</span><span id="__span-15-50"><a id="__codelineno-15-50" name="__codelineno-15-50" href="#__codelineno-15-50"></a>            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="__span-15-51"><a id="__codelineno-15-51" name="__codelineno-15-51" href="#__codelineno-15-51"></a>                <span class="s1">&#39;area&#39;</span><span class="p">:</span> <span class="s1">&#39;analytics&#39;</span><span class="p">,</span>
</span><span id="__span-15-52"><a id="__codelineno-15-52" name="__codelineno-15-52" href="#__codelineno-15-52"></a>                <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;Implement sampling for high-volume URLs&#39;</span><span class="p">,</span>
</span><span id="__span-15-53"><a id="__codelineno-15-53" name="__codelineno-15-53" href="#__codelineno-15-53"></a>                <span class="s1">&#39;savings&#39;</span><span class="p">:</span> <span class="n">current_costs</span><span class="p">[</span><span class="s1">&#39;analytics&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span id="__span-15-54"><a id="__codelineno-15-54" name="__codelineno-15-54" href="#__codelineno-15-54"></a>                <span class="s1">&#39;implementation&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_implement_analytics_sampling</span>
</span><span id="__span-15-55"><a id="__codelineno-15-55" name="__codelineno-15-55" href="#__codelineno-15-55"></a>            <span class="p">})</span>
</span><span id="__span-15-56"><a id="__codelineno-15-56" name="__codelineno-15-56" href="#__codelineno-15-56"></a>
</span><span id="__span-15-57"><a id="__codelineno-15-57" name="__codelineno-15-57" href="#__codelineno-15-57"></a>        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">recommendations</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;savings&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-15-58"><a id="__codelineno-15-58" name="__codelineno-15-58" href="#__codelineno-15-58"></a>
</span><span id="__span-15-59"><a id="__codelineno-15-59" name="__codelineno-15-59" href="#__codelineno-15-59"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_implement_storage_optimization</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-15-60"><a id="__codelineno-15-60" name="__codelineno-15-60" href="#__codelineno-15-60"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Implement storage cost optimizations&quot;&quot;&quot;</span>
</span><span id="__span-15-61"><a id="__codelineno-15-61" name="__codelineno-15-61" href="#__codelineno-15-61"></a>        <span class="c1"># Enable compression</span>
</span><span id="__span-15-62"><a id="__codelineno-15-62" name="__codelineno-15-62" href="#__codelineno-15-62"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">storage_config</span><span class="o">.</span><span class="n">compression</span> <span class="o">=</span> <span class="s1">&#39;zstd&#39;</span>
</span><span id="__span-15-63"><a id="__codelineno-15-63" name="__codelineno-15-63" href="#__codelineno-15-63"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">storage_config</span><span class="o">.</span><span class="n">compression_level</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="__span-15-64"><a id="__codelineno-15-64" name="__codelineno-15-64" href="#__codelineno-15-64"></a>
</span><span id="__span-15-65"><a id="__codelineno-15-65" name="__codelineno-15-65" href="#__codelineno-15-65"></a>        <span class="c1"># Enable deduplication</span>
</span><span id="__span-15-66"><a id="__codelineno-15-66" name="__codelineno-15-66" href="#__codelineno-15-66"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">storage_config</span><span class="o">.</span><span class="n">deduplication</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-15-67"><a id="__codelineno-15-67" name="__codelineno-15-67" href="#__codelineno-15-67"></a>
</span><span id="__span-15-68"><a id="__codelineno-15-68" name="__codelineno-15-68" href="#__codelineno-15-68"></a>        <span class="c1"># Archive old URLs</span>
</span><span id="__span-15-69"><a id="__codelineno-15-69" name="__codelineno-15-69" href="#__codelineno-15-69"></a>        <span class="n">archived</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_old_urls</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">180</span><span class="p">)</span>
</span><span id="__span-15-70"><a id="__codelineno-15-70" name="__codelineno-15-70" href="#__codelineno-15-70"></a>
</span><span id="__span-15-71"><a id="__codelineno-15-71" name="__codelineno-15-71" href="#__codelineno-15-71"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-15-72"><a id="__codelineno-15-72" name="__codelineno-15-72" href="#__codelineno-15-72"></a>            <span class="s1">&#39;compression_ratio&#39;</span><span class="p">:</span> <span class="mf">0.6</span><span class="p">,</span>
</span><span id="__span-15-73"><a id="__codelineno-15-73" name="__codelineno-15-73" href="#__codelineno-15-73"></a>            <span class="s1">&#39;deduplication_ratio&#39;</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">,</span>
</span><span id="__span-15-74"><a id="__codelineno-15-74" name="__codelineno-15-74" href="#__codelineno-15-74"></a>            <span class="s1">&#39;archived_urls&#39;</span><span class="p">:</span> <span class="n">archived</span><span class="p">,</span>
</span><span id="__span-15-75"><a id="__codelineno-15-75" name="__codelineno-15-75" href="#__codelineno-15-75"></a>            <span class="s1">&#39;space_saved_gb&#39;</span><span class="p">:</span> <span class="n">archived</span> <span class="o">*</span> <span class="mf">0.0001</span>
</span><span id="__span-15-76"><a id="__codelineno-15-76" name="__codelineno-15-76" href="#__codelineno-15-76"></a>        <span class="p">}</span>
</span><span id="__span-15-77"><a id="__codelineno-15-77" name="__codelineno-15-77" href="#__codelineno-15-77"></a>
</span><span id="__span-15-78"><a id="__codelineno-15-78" name="__codelineno-15-78" href="#__codelineno-15-78"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">implement_smart_caching</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-15-79"><a id="__codelineno-15-79" name="__codelineno-15-79" href="#__codelineno-15-79"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Implement intelligent caching strategy&quot;&quot;&quot;</span>
</span><span id="__span-15-80"><a id="__codelineno-15-80" name="__codelineno-15-80" href="#__codelineno-15-80"></a>        <span class="c1"># Analyze access patterns</span>
</span><span id="__span-15-81"><a id="__codelineno-15-81" name="__codelineno-15-81" href="#__codelineno-15-81"></a>        <span class="n">access_patterns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_access_patterns</span><span class="p">()</span>
</span><span id="__span-15-82"><a id="__codelineno-15-82" name="__codelineno-15-82" href="#__codelineno-15-82"></a>
</span><span id="__span-15-83"><a id="__codelineno-15-83" name="__codelineno-15-83" href="#__codelineno-15-83"></a>        <span class="c1"># Configure multi-tier caching</span>
</span><span id="__span-15-84"><a id="__codelineno-15-84" name="__codelineno-15-84" href="#__codelineno-15-84"></a>        <span class="n">cache_config</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-15-85"><a id="__codelineno-15-85" name="__codelineno-15-85" href="#__codelineno-15-85"></a>            <span class="s1">&#39;edge&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-15-86"><a id="__codelineno-15-86" name="__codelineno-15-86" href="#__codelineno-15-86"></a>                <span class="s1">&#39;hot_urls&#39;</span><span class="p">:</span> <span class="p">{</span>  <span class="c1"># Top 1% of URLs</span>
</span><span id="__span-15-87"><a id="__codelineno-15-87" name="__codelineno-15-87" href="#__codelineno-15-87"></a>                    <span class="s1">&#39;ttl&#39;</span><span class="p">:</span> <span class="mi">86400</span><span class="p">,</span>  <span class="c1"># 24 hours</span>
</span><span id="__span-15-88"><a id="__codelineno-15-88" name="__codelineno-15-88" href="#__codelineno-15-88"></a>                    <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="s1">&#39;10GB&#39;</span>
</span><span id="__span-15-89"><a id="__codelineno-15-89" name="__codelineno-15-89" href="#__codelineno-15-89"></a>                <span class="p">},</span>
</span><span id="__span-15-90"><a id="__codelineno-15-90" name="__codelineno-15-90" href="#__codelineno-15-90"></a>                <span class="s1">&#39;warm_urls&#39;</span><span class="p">:</span> <span class="p">{</span>  <span class="c1"># Next 9%</span>
</span><span id="__span-15-91"><a id="__codelineno-15-91" name="__codelineno-15-91" href="#__codelineno-15-91"></a>                    <span class="s1">&#39;ttl&#39;</span><span class="p">:</span> <span class="mi">3600</span><span class="p">,</span>   <span class="c1"># 1 hour</span>
</span><span id="__span-15-92"><a id="__codelineno-15-92" name="__codelineno-15-92" href="#__codelineno-15-92"></a>                    <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="s1">&#39;40GB&#39;</span>
</span><span id="__span-15-93"><a id="__codelineno-15-93" name="__codelineno-15-93" href="#__codelineno-15-93"></a>                <span class="p">},</span>
</span><span id="__span-15-94"><a id="__codelineno-15-94" name="__codelineno-15-94" href="#__codelineno-15-94"></a>                <span class="s1">&#39;cold_urls&#39;</span><span class="p">:</span> <span class="p">{</span>  <span class="c1"># Remaining 90%</span>
</span><span id="__span-15-95"><a id="__codelineno-15-95" name="__codelineno-15-95" href="#__codelineno-15-95"></a>                    <span class="s1">&#39;ttl&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>    <span class="c1"># 5 minutes</span>
</span><span id="__span-15-96"><a id="__codelineno-15-96" name="__codelineno-15-96" href="#__codelineno-15-96"></a>                    <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="s1">&#39;50GB&#39;</span>
</span><span id="__span-15-97"><a id="__codelineno-15-97" name="__codelineno-15-97" href="#__codelineno-15-97"></a>                <span class="p">}</span>
</span><span id="__span-15-98"><a id="__codelineno-15-98" name="__codelineno-15-98" href="#__codelineno-15-98"></a>            <span class="p">},</span>
</span><span id="__span-15-99"><a id="__codelineno-15-99" name="__codelineno-15-99" href="#__codelineno-15-99"></a>            <span class="s1">&#39;regional&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-15-100"><a id="__codelineno-15-100" name="__codelineno-15-100" href="#__codelineno-15-100"></a>                <span class="s1">&#39;ttl&#39;</span><span class="p">:</span> <span class="mi">3600</span><span class="p">,</span>
</span><span id="__span-15-101"><a id="__codelineno-15-101" name="__codelineno-15-101" href="#__codelineno-15-101"></a>                <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="s1">&#39;100GB&#39;</span>
</span><span id="__span-15-102"><a id="__codelineno-15-102" name="__codelineno-15-102" href="#__codelineno-15-102"></a>            <span class="p">}</span>
</span><span id="__span-15-103"><a id="__codelineno-15-103" name="__codelineno-15-103" href="#__codelineno-15-103"></a>        <span class="p">}</span>
</span><span id="__span-15-104"><a id="__codelineno-15-104" name="__codelineno-15-104" href="#__codelineno-15-104"></a>
</span><span id="__span-15-105"><a id="__codelineno-15-105" name="__codelineno-15-105" href="#__codelineno-15-105"></a>        <span class="c1"># Apply configuration</span>
</span><span id="__span-15-106"><a id="__codelineno-15-106" name="__codelineno-15-106" href="#__codelineno-15-106"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cdn</span><span class="o">.</span><span class="n">update_cache_rules</span><span class="p">(</span><span class="n">cache_config</span><span class="p">)</span>
</span><span id="__span-15-107"><a id="__codelineno-15-107" name="__codelineno-15-107" href="#__codelineno-15-107"></a>
</span><span id="__span-15-108"><a id="__codelineno-15-108" name="__codelineno-15-108" href="#__codelineno-15-108"></a>        <span class="c1"># Predictive cache warming</span>
</span><span id="__span-15-109"><a id="__codelineno-15-109" name="__codelineno-15-109" href="#__codelineno-15-109"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">start_predictive_caching</span><span class="p">(</span><span class="n">access_patterns</span><span class="p">)</span>
</span><span id="__span-15-110"><a id="__codelineno-15-110" name="__codelineno-15-110" href="#__codelineno-15-110"></a>
</span><span id="__span-15-111"><a id="__codelineno-15-111" name="__codelineno-15-111" href="#__codelineno-15-111"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">optimize_analytics_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-15-112"><a id="__codelineno-15-112" name="__codelineno-15-112" href="#__codelineno-15-112"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Optimize analytics for cost&quot;&quot;&quot;</span>
</span><span id="__span-15-113"><a id="__codelineno-15-113" name="__codelineno-15-113" href="#__codelineno-15-113"></a>        <span class="c1"># Implement sampling</span>
</span><span id="__span-15-114"><a id="__codelineno-15-114" name="__codelineno-15-114" href="#__codelineno-15-114"></a>        <span class="n">sampling_rules</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-15-115"><a id="__codelineno-15-115" name="__codelineno-15-115" href="#__codelineno-15-115"></a>            <span class="s1">&#39;high_traffic&#39;</span><span class="p">:</span> <span class="p">{</span>  <span class="c1"># &gt;10K clicks/day</span>
</span><span id="__span-15-116"><a id="__codelineno-15-116" name="__codelineno-15-116" href="#__codelineno-15-116"></a>                <span class="s1">&#39;sample_rate&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>  <span class="c1"># 10% sampling</span>
</span><span id="__span-15-117"><a id="__codelineno-15-117" name="__codelineno-15-117" href="#__codelineno-15-117"></a>                <span class="s1">&#39;preserve&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;unique_visitors&#39;</span><span class="p">,</span> <span class="s1">&#39;referrers&#39;</span><span class="p">]</span>
</span><span id="__span-15-118"><a id="__codelineno-15-118" name="__codelineno-15-118" href="#__codelineno-15-118"></a>            <span class="p">},</span>
</span><span id="__span-15-119"><a id="__codelineno-15-119" name="__codelineno-15-119" href="#__codelineno-15-119"></a>            <span class="s1">&#39;medium_traffic&#39;</span><span class="p">:</span> <span class="p">{</span>  <span class="c1"># 1K-10K clicks/day</span>
</span><span id="__span-15-120"><a id="__codelineno-15-120" name="__codelineno-15-120" href="#__codelineno-15-120"></a>                <span class="s1">&#39;sample_rate&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>  <span class="c1"># 50% sampling</span>
</span><span id="__span-15-121"><a id="__codelineno-15-121" name="__codelineno-15-121" href="#__codelineno-15-121"></a>                <span class="s1">&#39;preserve&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">]</span>
</span><span id="__span-15-122"><a id="__codelineno-15-122" name="__codelineno-15-122" href="#__codelineno-15-122"></a>            <span class="p">},</span>
</span><span id="__span-15-123"><a id="__codelineno-15-123" name="__codelineno-15-123" href="#__codelineno-15-123"></a>            <span class="s1">&#39;low_traffic&#39;</span><span class="p">:</span> <span class="p">{</span>  <span class="c1"># &lt;1K clicks/day</span>
</span><span id="__span-15-124"><a id="__codelineno-15-124" name="__codelineno-15-124" href="#__codelineno-15-124"></a>                <span class="s1">&#39;sample_rate&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>  <span class="c1"># No sampling</span>
</span><span id="__span-15-125"><a id="__codelineno-15-125" name="__codelineno-15-125" href="#__codelineno-15-125"></a>                <span class="s1">&#39;preserve&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">]</span>
</span><span id="__span-15-126"><a id="__codelineno-15-126" name="__codelineno-15-126" href="#__codelineno-15-126"></a>            <span class="p">}</span>
</span><span id="__span-15-127"><a id="__codelineno-15-127" name="__codelineno-15-127" href="#__codelineno-15-127"></a>        <span class="p">}</span>
</span><span id="__span-15-128"><a id="__codelineno-15-128" name="__codelineno-15-128" href="#__codelineno-15-128"></a>
</span><span id="__span-15-129"><a id="__codelineno-15-129" name="__codelineno-15-129" href="#__codelineno-15-129"></a>        <span class="c1"># Aggregate before storage</span>
</span><span id="__span-15-130"><a id="__codelineno-15-130" name="__codelineno-15-130" href="#__codelineno-15-130"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">analytics_config</span><span class="o">.</span><span class="n">pre_aggregation</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-15-131"><a id="__codelineno-15-131" name="__codelineno-15-131" href="#__codelineno-15-131"></a>            <span class="s1">&#39;time_buckets&#39;</span><span class="p">:</span> <span class="s1">&#39;5m&#39;</span><span class="p">,</span>  <span class="c1"># 5-minute buckets</span>
</span><span id="__span-15-132"><a id="__codelineno-15-132" name="__codelineno-15-132" href="#__codelineno-15-132"></a>            <span class="s1">&#39;geographic&#39;</span><span class="p">:</span> <span class="s1">&#39;country&#39;</span><span class="p">,</span>  <span class="c1"># Country-level only</span>
</span><span id="__span-15-133"><a id="__codelineno-15-133" name="__codelineno-15-133" href="#__codelineno-15-133"></a>            <span class="s1">&#39;device&#39;</span><span class="p">:</span> <span class="s1">&#39;type&#39;</span>  <span class="c1"># Device type only</span>
</span><span id="__span-15-134"><a id="__codelineno-15-134" name="__codelineno-15-134" href="#__codelineno-15-134"></a>        <span class="p">}</span>
</span><span id="__span-15-135"><a id="__codelineno-15-135" name="__codelineno-15-135" href="#__codelineno-15-135"></a>
</span><span id="__span-15-136"><a id="__codelineno-15-136" name="__codelineno-15-136" href="#__codelineno-15-136"></a>        <span class="c1"># Archive old analytics</span>
</span><span id="__span-15-137"><a id="__codelineno-15-137" name="__codelineno-15-137" href="#__codelineno-15-137"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">analytics_config</span><span class="o">.</span><span class="n">retention</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-15-138"><a id="__codelineno-15-138" name="__codelineno-15-138" href="#__codelineno-15-138"></a>            <span class="s1">&#39;raw_events&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>  <span class="c1"># 7 days</span>
</span><span id="__span-15-139"><a id="__codelineno-15-139" name="__codelineno-15-139" href="#__codelineno-15-139"></a>            <span class="s1">&#39;aggregated&#39;</span><span class="p">:</span> <span class="mi">90</span><span class="p">,</span>  <span class="c1"># 90 days</span>
</span><span id="__span-15-140"><a id="__codelineno-15-140" name="__codelineno-15-140" href="#__codelineno-15-140"></a>            <span class="s1">&#39;summary&#39;</span><span class="p">:</span> <span class="mi">365</span>  <span class="c1"># 1 year</span>
</span><span id="__span-15-141"><a id="__codelineno-15-141" name="__codelineno-15-141" href="#__codelineno-15-141"></a>        <span class="p">}</span>
</span></code></pre></div></p>
<h3 id="comprehensive-axiom-mapping">🔍 Comprehensive Axiom Mapping<a class="headerlink" href="#comprehensive-axiom-mapping" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Design Decision</th>
<th>Axiom 1<br>(Latency)</th>
<th>Axiom 2<br>(Capacity)</th>
<th>Axiom 3<br>(Failure)</th>
<th>Axiom 4<br>(Concurrency)</th>
<th>Axiom 5<br>(Coordination)</th>
<th>Axiom 6<br>(Observability)</th>
<th>Axiom 7<br>(Human Interface)</th>
<th>Axiom 8<br>(Economics)</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>CDN Edge Caching</strong></td>
<td>✅ 5ms redirects<br>Global presence</td>
<td>⚖️ Limited cache size<br>LRU eviction</td>
<td>✅ Origin failover<br>Multi-region</td>
<td>✅ Parallel serving<br>No contention</td>
<td>➖ Cache coherence<br>via TTL only</td>
<td>📊 Hit rate metrics<br>Geographic data</td>
<td>✅ Transparent<br>to users</td>
<td>✅ 90% cost reduction<br>vs origin hits</td>
</tr>
<tr>
<td><strong>Counter + Hash Hybrid</strong></td>
<td>✅ O(1) generation<br>No collisions</td>
<td>✅ 2^62 URL space<br>7-8 char codes</td>
<td>✅ Counter gaps OK<br>Hash fallback</td>
<td>✅ Atomic counter<br>increment</td>
<td>🔄 Distributed counter<br>coordination</td>
<td>📊 Generation rate<br>Collision tracking</td>
<td>✅ Predictable codes<br>Custom aliases</td>
<td>✅ Simple algorithm<br>Low CPU cost</td>
</tr>
<tr>
<td><strong>SQL with Sharding</strong></td>
<td>⚖️ ~10ms lookups<br>Index critical</td>
<td>✅ Horizontal scale<br>1000+ shards</td>
<td>✅ Shard isolation<br>Replica failover</td>
<td>⚠️ Lock contention<br>on hot shards</td>
<td>🔄 Shard mapping<br>consensus needed</td>
<td>📊 Query latency<br>Shard distribution</td>
<td>✅ Familiar SQL<br>Rich querying</td>
<td>⚖️ Higher cost than<br>NoSQL options</td>
</tr>
<tr>
<td><strong>Analytics Sampling</strong></td>
<td>✅ Minimal impact<br>on redirects</td>
<td>✅ 10x data reduction<br>for high traffic</td>
<td>✅ Graceful degrade<br>on overload</td>
<td>✅ Async pipeline<br>No blocking</td>
<td>➖ Best effort only<br>No coordination</td>
<td>⚠️ Sampled accuracy<br>Statistical errors</td>
<td>📊 Confidence levels<br>shown in UI</td>
<td>✅ 90% cost savings<br>on analytics</td>
</tr>
<tr>
<td><strong>Bloom Filter Checks</strong></td>
<td>✅ &lt;1ms existence<br>check</td>
<td>✅ 10 bits per URL<br>Space efficient</td>
<td>✅ Reconstructible<br>from DB</td>
<td>✅ Lock-free reads<br>Thread-safe</td>
<td>➖ Local only<br>No sharing</td>
<td>📊 False positive<br>rate tracking</td>
<td>✅ Reduces 404s<br>Better UX</td>
<td>✅ Prevents DB hits<br>for missing URLs</td>
</tr>
<tr>
<td><strong>Multi-tier Storage</strong></td>
<td>⚖️ Hot in memory<br>Cold slower</td>
<td>✅ Infinite scale<br>with S3 tier</td>
<td>✅ Durable cold tier<br>Memory volatile</td>
<td>✅ Tier migration<br>background jobs</td>
<td>🔄 Migration rules<br>configuration</td>
<td>📊 Tier distribution<br>Access patterns</td>
<td>🛠️ Tier policies<br>configurable</td>
<td>✅ 80% cost reduction<br>with cold storage</td>
</tr>
<tr>
<td><strong>Rate Limiting</strong></td>
<td>⚖️ Adds ~1ms<br>overhead</td>
<td>✅ Protects capacity<br>Prevents abuse</td>
<td>✅ Degrades gracefully<br>Returns 429</td>
<td>✅ Distributed<br>rate counters</td>
<td>🔄 Global rate limit<br>coordination</td>
<td>📊 Rate limit metrics<br>By endpoint/user</td>
<td>⚠️ Clear error msgs<br>Retry headers</td>
<td>✅ Prevents abuse<br>costs</td>
</tr>
<tr>
<td><strong>Real-time + Batch Analytics</strong></td>
<td>✅ &lt;1s for key metrics<br>Batch for rest</td>
<td>✅ Efficient batching<br>Compression</td>
<td>✅ Queue spillover<br>to disk</td>
<td>✅ Parallel streams<br>processing</td>
<td>🔄 Stream partitioning<br>coordination</td>
<td>✅ Real-time dashboard<br>Historical reports</td>
<td>✅ Both use cases<br>covered</td>
<td>⚖️ Dual pipeline<br>complexity</td>
</tr>
<tr>
<td><strong>URL Deduplication</strong></td>
<td>⚖️ Hash computation<br>overhead</td>
<td>✅ 30-40% storage<br>savings</td>
<td>✅ Dedup index<br>can rebuild</td>
<td>⚠️ Race conditions<br>on same URL</td>
<td>🔄 Distributed lock<br>for dedup check</td>
<td>📊 Dedup ratio<br>Collision stats</td>
<td>✅ Same short URL<br>for duplicates</td>
<td>✅ Major storage<br>cost savings</td>
</tr>
<tr>
<td><strong>Spam Detection</strong></td>
<td>⚖️ ML inference<br>adds latency</td>
<td>✅ Blacklist scales<br>Pattern matching</td>
<td>✅ Fail open<br>Don't block good</td>
<td>✅ Async checking<br>Non-blocking</td>
<td>🔄 Blacklist sync<br>across regions</td>
<td>📊 Spam detection<br>False positive rate</td>
<td>⚠️ May block<br>legitimate URLs</td>
<td>✅ Prevents abuse<br>Maintains quality</td>
</tr>
</tbody>
</table>
<h3 id="pillar-mapping">🏛️ Pillar Mapping<a class="headerlink" href="#pillar-mapping" title="Permanent link">&para;</a></h3>
<h4 id="work-distribution">Work Distribution<a class="headerlink" href="#work-distribution" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>URL Shortening</strong>: Distributed across nodes</li>
<li><strong>Redirect Handling</strong>: Edge locations worldwide</li>
<li><strong>Analytics Processing</strong>: Stream processing pipeline</li>
<li><strong>Batch Operations</strong>: Parallel processing</li>
</ul>
<h4 id="state-management">State Management<a class="headerlink" href="#state-management" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>URL Mappings</strong>: Sharded database</li>
<li><strong>Analytics Data</strong>: Time-series storage</li>
<li><strong>Cache State</strong>: Multi-level caching</li>
<li><strong>User Data</strong>: Centralized with replication</li>
</ul>
<h4 id="truth-consistency">Truth &amp; Consistency<a class="headerlink" href="#truth-consistency" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>URL Uniqueness</strong>: Guaranteed via generation strategy</li>
<li><strong>Click Counts</strong>: Eventually consistent</li>
<li><strong>Analytics</strong>: Best-effort with sampling</li>
<li><strong>Cache Coherence</strong>: TTL-based invalidation</li>
</ul>
<h4 id="control-mechanisms">Control Mechanisms<a class="headerlink" href="#control-mechanisms" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>Rate Limiting</strong>: Per-user and global</li>
<li><strong>Access Control</strong>: API keys and permissions</li>
<li><strong>Spam Prevention</strong>: Blacklists and ML detection</li>
<li><strong>Quality Control</strong>: URL validation and scanning</li>
</ul>
<h4 id="intelligence-layer">Intelligence Layer<a class="headerlink" href="#intelligence-layer" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>Predictive Caching</strong>: ML-based prefetching</li>
<li><strong>Spam Detection</strong>: Pattern recognition</li>
<li><strong>Analytics Insights</strong>: Trend detection</li>
<li><strong>Performance Optimization</strong>: Auto-tuning</li>
</ul>
<h3 id="pattern-application">🔧 Pattern Application<a class="headerlink" href="#pattern-application" title="Permanent link">&para;</a></h3>
<p><strong>Primary Patterns:</strong>
- <strong>Sharding</strong>: URL data distribution
- <strong>Caching</strong>: Multi-level cache hierarchy
- <strong>CDN</strong>: Global edge delivery
- <strong>Rate Limiting</strong>: API protection</p>
<p><strong>Supporting Patterns:</strong>
- <strong>Circuit Breaker</strong>: Service resilience
- <strong>Bloom Filter</strong>: Existence checks
- <strong>Event Sourcing</strong>: Analytics pipeline
- <strong>CQRS</strong>: Read/write separation</p>
<h3 id="architecture-alternatives">🏗️ Architecture Alternatives<a class="headerlink" href="#architecture-alternatives" title="Permanent link">&para;</a></h3>
<h4 id="alternative-1-nosql-based-architecture">Alternative 1: NoSQL-Based Architecture<a class="headerlink" href="#alternative-1-nosql-based-architecture" title="Permanent link">&para;</a></h4>
<pre class="mermaid"><code>graph TB
    subgraph "Clients"
        C1[Web]
        C2[Mobile]
        C3[API]
    end

    subgraph "API Layer"
        AG[API Gateway&lt;br/&gt;Route53]
        LB[ALB]
    end

    subgraph "Compute"
        L1[Lambda&lt;br/&gt;Shorten]
        L2[Lambda&lt;br/&gt;Redirect]
        L3[Lambda&lt;br/&gt;Analytics]
    end

    subgraph "Storage"
        DDB[(DynamoDB&lt;br/&gt;URLs)]
        S3[(S3&lt;br/&gt;Analytics)]
    end

    subgraph "Cache"
        CF[CloudFront]
        EC[(ElastiCache)]
    end

    C1 &amp; C2 &amp; C3 --&gt; CF
    CF --&gt; AG
    AG --&gt; LB
    LB --&gt; L1 &amp; L2 &amp; L3
    L1 &amp; L2 --&gt; DDB
    L1 &amp; L2 --&gt; EC
    L3 --&gt; S3

    style DDB fill:#ff9999
    style CF fill:#e3f2fd</code></pre>
<p><strong>Characteristics:</strong>
- Serverless, infinite scale
- Pay-per-use pricing
- Eventually consistent
- Vendor lock-in (AWS)</p>
<h4 id="alternative-2-kubernetes-microservices">Alternative 2: Kubernetes Microservices<a class="headerlink" href="#alternative-2-kubernetes-microservices" title="Permanent link">&para;</a></h4>
<pre class="mermaid"><code>graph TB
    subgraph "Ingress"
        IG[Ingress&lt;br/&gt;Controller]
    end

    subgraph "Services"
        SH[Shortener&lt;br/&gt;Service]
        RD[Redirect&lt;br/&gt;Service]
        AN[Analytics&lt;br/&gt;Service]
        AU[Auth&lt;br/&gt;Service]
    end

    subgraph "Data Stores"
        PG[(PostgreSQL&lt;br/&gt;Sharded)]
        RD[(Redis&lt;br/&gt;Cluster)]
        KF[Kafka]
        ES[(Elasticsearch)]
    end

    IG --&gt; SH &amp; RD &amp; AN &amp; AU
    SH --&gt; PG &amp; RD
    RD --&gt; RD
    AN --&gt; KF --&gt; ES
    AU --&gt; PG

    style SH fill:#90EE90
    style RD fill:#90EE90
    style AN fill:#90EE90</code></pre>
<p><strong>Characteristics:</strong>
- Container orchestration
- Service mesh capable
- Technology flexibility
- Higher operational overhead</p>
<h4 id="alternative-3-edge-first-architecture">Alternative 3: Edge-First Architecture<a class="headerlink" href="#alternative-3-edge-first-architecture" title="Permanent link">&para;</a></h4>
<pre class="mermaid"><code>graph LR
    subgraph "Edge Locations"
        E1[Edge Worker&lt;br/&gt;US-East]
        E2[Edge Worker&lt;br/&gt;EU-West]
        E3[Edge Worker&lt;br/&gt;AP-South]
    end

    subgraph "Edge Storage"
        KV1[(KV Store)]
        KV2[(KV Store)]
        KV3[(KV Store)]
    end

    subgraph "Origin"
        OR[Origin&lt;br/&gt;Service]
        DB[(Master DB)]
    end

    E1 --&gt; KV1
    E2 --&gt; KV2
    E3 --&gt; KV3

    KV1 &amp; KV2 &amp; KV3 -.-&gt;|Sync| OR
    OR --&gt; DB

    style E1 fill:#e3f2fd
    style E2 fill:#e3f2fd
    style E3 fill:#e3f2fd</code></pre>
<p><strong>Characteristics:</strong>
- Ultra-low latency globally
- Edge compute (Workers)
- Complex consistency model
- Premium pricing</p>
<h4 id="alternative-4-blockchain-based">Alternative 4: Blockchain-Based<a class="headerlink" href="#alternative-4-blockchain-based" title="Permanent link">&para;</a></h4>
<pre class="mermaid"><code>graph TB
    subgraph "Clients"
        C[Clients]
    end

    subgraph "Gateway"
        GW[Web3&lt;br/&gt;Gateway]
    end

    subgraph "Blockchain"
        SC[Smart&lt;br/&gt;Contract]
        BC[(Blockchain&lt;br/&gt;State)]
    end

    subgraph "Off-chain"
        IPFS[(IPFS&lt;br/&gt;Long URLs)]
        ORC[Oracle&lt;br/&gt;Analytics]
    end

    C --&gt; GW
    GW --&gt; SC
    SC --&gt; BC
    SC -.-&gt; IPFS
    SC -.-&gt; ORC</code></pre>
<p><strong>Characteristics:</strong>
- Decentralized, no single owner
- Immutable URL mappings
- High transaction costs
- Limited throughput</p>
<h4 id="alternative-5-hybrid-multi-cloud">Alternative 5: Hybrid Multi-Cloud<a class="headerlink" href="#alternative-5-hybrid-multi-cloud" title="Permanent link">&para;</a></h4>
<pre class="mermaid"><code>graph TB
    subgraph "Traffic Management"
        GTM[Global Traffic&lt;br/&gt;Manager]
    end

    subgraph "AWS Region"
        AWS_LB[ALB]
        AWS_APP[ECS Service]
        AWS_DB[(RDS)]
    end

    subgraph "GCP Region"
        GCP_LB[Cloud LB]
        GCP_APP[Cloud Run]
        GCP_DB[(Spanner)]
    end

    subgraph "Azure Region"
        AZ_LB[App Gateway]
        AZ_APP[Container&lt;br/&gt;Instance]
        AZ_DB[(Cosmos DB)]
    end

    GTM --&gt; AWS_LB &amp; GCP_LB &amp; AZ_LB
    AWS_LB --&gt; AWS_APP --&gt; AWS_DB
    GCP_LB --&gt; GCP_APP --&gt; GCP_DB
    AZ_LB --&gt; AZ_APP --&gt; AZ_DB

    AWS_DB -.-&gt;|Sync| GCP_DB
    GCP_DB -.-&gt;|Sync| AZ_DB
    AZ_DB -.-&gt;|Sync| AWS_DB</code></pre>
<p><strong>Characteristics:</strong>
- No vendor lock-in
- Regional failover
- Complex operations
- Higher costs</p>
<h3 id="trade-off-analysis-matrix">⚖️ Trade-off Analysis Matrix<a class="headerlink" href="#trade-off-analysis-matrix" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Architecture</th>
<th>Scalability</th>
<th>Latency</th>
<th>Consistency</th>
<th>Cost</th>
<th>Complexity</th>
<th>Vendor Lock-in</th>
<th>Reliability</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>NoSQL Serverless</strong></td>
<td>✅ Infinite</td>
<td>🔶 Medium</td>
<td>🔶 Eventual</td>
<td>✅ Low</td>
<td>✅ Low</td>
<td>❌ High</td>
<td>✅ High</td>
</tr>
<tr>
<td><strong>K8s Microservices</strong></td>
<td>✅ High</td>
<td>✅ Low</td>
<td>✅ Strong</td>
<td>🔶 Medium</td>
<td>❌ High</td>
<td>✅ Low</td>
<td>🔶 Medium</td>
</tr>
<tr>
<td><strong>Edge-First</strong></td>
<td>✅ High</td>
<td>✅ Ultra-low</td>
<td>❌ Weak</td>
<td>❌ High</td>
<td>🔶 Medium</td>
<td>🔶 Medium</td>
<td>✅ High</td>
</tr>
<tr>
<td><strong>Blockchain</strong></td>
<td>❌ Low</td>
<td>❌ High</td>
<td>✅ Strong</td>
<td>❌ Very High</td>
<td>❌ High</td>
<td>✅ None</td>
<td>✅ High</td>
</tr>
<tr>
<td><strong>Hybrid Multi-Cloud</strong></td>
<td>✅ High</td>
<td>🔶 Medium</td>
<td>🔶 Eventual</td>
<td>❌ High</td>
<td>❌ Very High</td>
<td>✅ None</td>
<td>✅ Very High</td>
</tr>
</tbody>
</table>
<h3 id="performance-comparison">📊 Performance Comparison<a class="headerlink" href="#performance-comparison" title="Permanent link">&para;</a></h3>
<pre class="mermaid"><code>graph LR
    subgraph "Redirect Latency (p99)"
        A[Edge-First: 5ms]
        B[CDN+Origin: 50ms]
        C[Direct DB: 100ms]
        D[Blockchain: 3000ms]
    end

    A --&gt;|10x| B
    B --&gt;|2x| C
    C --&gt;|30x| D</code></pre>
<pre class="mermaid"><code>graph TB
    subgraph "Cost per Million URLs"
        T1[Serverless&lt;br/&gt;$10]
        T2[Containers&lt;br/&gt;$50]
        T3[Edge&lt;br/&gt;$100]
        T4[Multi-Cloud&lt;br/&gt;$150]
        T5[Blockchain&lt;br/&gt;$10,000]
    end

    T1 --&gt;|5x| T2
    T2 --&gt;|2x| T3
    T3 --&gt;|1.5x| T4
    T4 --&gt;|66x| T5</code></pre>
<h2 id="part-2-architecture-trade-offs">Part 2: Architecture &amp; Trade-offs<a class="headerlink" href="#part-2-architecture-trade-offs" title="Permanent link">&para;</a></h2>
<h3 id="core-architecture">🏗️ Core Architecture<a class="headerlink" href="#core-architecture" title="Permanent link">&para;</a></h3>
<pre class="mermaid"><code>graph TB
    subgraph "Client Layer"
        WEB[Web Browser]
        MOB[Mobile App]
        API[API Client]
    end

    subgraph "Edge Layer"
        CDN[CDN&lt;br/&gt;90% Cache Hit]
        WAF[WAF&lt;br/&gt;DDoS Protection]
    end

    subgraph "Application Layer"
        LB[Load Balancer]
        AS1[App Server 1]
        AS2[App Server 2]
        ASN[App Server N]
    end

    subgraph "Caching Layer"
        RC[Redis Cluster&lt;br/&gt;Hot URLs]
        MC[Memcached&lt;br/&gt;Session]
    end

    subgraph "Data Layer"
        subgraph "Primary Storage"
            DB1[(Shard 1)]
            DB2[(Shard 2)]
            DBN[(Shard N)]
        end

        subgraph "Analytics"
            KF[Kafka]
            CH[(ClickHouse)]
        end
    end

    subgraph "Services"
        ID[ID Generator]
        AN[Analytics Service]
        SP[Spam Detector]
    end

    WEB &amp; MOB &amp; API --&gt; CDN
    CDN --&gt; WAF
    WAF --&gt; LB
    LB --&gt; AS1 &amp; AS2 &amp; ASN

    AS1 &amp; AS2 &amp; ASN --&gt; RC
    AS1 &amp; AS2 &amp; ASN --&gt; DB1 &amp; DB2 &amp; DBN
    AS1 &amp; AS2 &amp; ASN --&gt; ID
    AS1 &amp; AS2 &amp; ASN --&gt; SP

    AS1 &amp; AS2 &amp; ASN --&gt; KF
    KF --&gt; AN
    AN --&gt; CH

    style CDN fill:#e3f2fd
    style RC fill:#fff9c4
    style DB1 fill:#c8e6c9
    style DB2 fill:#c8e6c9
    style DBN fill:#c8e6c9</code></pre>
<h3 id="key-design-trade-offs">⚖️ Key Design Trade-offs<a class="headerlink" href="#key-design-trade-offs" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Decision</th>
<th>Option A</th>
<th>Option B</th>
<th>Choice &amp; Rationale</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Short Code Generation</strong></td>
<td>Sequential counter</td>
<td>Hash-based</td>
<td><strong>Hybrid</strong> - Counter for guaranteed uniqueness, hash for custom URLs</td>
</tr>
<tr>
<td><strong>Storage</strong></td>
<td>NoSQL (DynamoDB)</td>
<td>SQL (PostgreSQL)</td>
<td><strong>SQL with sharding</strong> - ACID for URL mappings, familiar tooling</td>
</tr>
<tr>
<td><strong>Analytics</strong></td>
<td>Real-time all events</td>
<td>Sampled/batched</td>
<td><strong>Sampled for high-volume</strong> - Balance accuracy vs cost</td>
</tr>
<tr>
<td><strong>Caching</strong></td>
<td>Cache everything</td>
<td>Cache hot URLs only</td>
<td><strong>Smart caching</strong> - LRU with predictive warming for popular URLs</td>
</tr>
<tr>
<td><strong>Custom URLs</strong></td>
<td>Always allow</td>
<td>Premium feature</td>
<td><strong>Freemium model</strong> - Basic custom URLs free, advanced features paid</td>
</tr>
</tbody>
</table>
<h3 id="alternative-architectures">🔄 Alternative Architectures<a class="headerlink" href="#alternative-architectures" title="Permanent link">&para;</a></h3>
<h4 id="option-1-simple-monolithic">Option 1: Simple Monolithic<a class="headerlink" href="#option-1-simple-monolithic" title="Permanent link">&para;</a></h4>
<pre class="mermaid"><code>graph LR
    C[Client] --&gt; S[Server]
    S --&gt; D[(Database)]
    S --&gt; R[(Redis)]</code></pre>
<p><strong>Pros</strong>: Simple, easy to deploy, low operational overhead
<strong>Cons</strong>: Limited scale, single point of failure
<strong>When to use</strong>: Startups, &lt;1M URLs</p>
<h4 id="option-2-microservices">Option 2: Microservices<a class="headerlink" href="#option-2-microservices" title="Permanent link">&para;</a></h4>
<pre class="mermaid"><code>graph TB
    G[API Gateway]
    G --&gt; US[URL Service]
    G --&gt; AS[Analytics Service]
    G --&gt; US2[User Service]

    US --&gt; D1[(URL DB)]
    AS --&gt; D2[(Analytics DB)]
    US2 --&gt; D3[(User DB)]</code></pre>
<p><strong>Pros</strong>: Independent scaling, technology diversity
<strong>Cons</strong>: Operational complexity, network overhead
<strong>When to use</strong>: Large teams, diverse requirements</p>
<h4 id="option-3-serverless">Option 3: Serverless<a class="headerlink" href="#option-3-serverless" title="Permanent link">&para;</a></h4>
<pre class="mermaid"><code>graph LR
    C[Client] --&gt; CF[CloudFront]
    CF --&gt; L[Lambda]
    L --&gt; DD[(DynamoDB)]
    L --&gt; S3[(S3)]</code></pre>
<p><strong>Pros</strong>: No servers, auto-scaling, pay-per-use
<strong>Cons</strong>: Vendor lock-in, cold starts
<strong>When to use</strong>: Variable traffic, cost-sensitive</p>
<h4 id="option-4-edge-computing">Option 4: Edge Computing<a class="headerlink" href="#option-4-edge-computing" title="Permanent link">&para;</a></h4>
<pre class="mermaid"><code>graph TB
    C[Client] --&gt; E1[Edge Location 1]
    C --&gt; E2[Edge Location 2]
    E1 &amp; E2 --&gt; O[Origin]</code></pre>
<p><strong>Pros</strong>: Ultra-low latency, distributed
<strong>Cons</strong>: Complex deployment, consistency challenges
<strong>When to use</strong>: Global audience, latency-critical</p>
<h3 id="performance-characteristics">📊 Performance Characteristics<a class="headerlink" href="#performance-characteristics" title="Permanent link">&para;</a></h3>
<p><strong>System Metrics:</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>Metric              Target    Achieved   Notes
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>Shorten Latency     &lt;100ms    45ms      With caching
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>Redirect Latency    &lt;50ms     12ms      90% from CDN
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>Throughput          100K/s    150K/s    Per region
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>Storage Efficiency  90%       94%       With dedup
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>Analytics Delay     &lt;1min     30s       End-to-end
</span></code></pre></div></p>
<p><strong>Scaling Limits:</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>Component     Limit           Bottleneck
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>Database      1M writes/s     Sharding limit
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>Cache         10M reads/s     Memory bandwidth
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>CDN           1M reqs/s/edge  Network capacity
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>Analytics     10M events/s    Kafka throughput
</span></code></pre></div></p>
<h3 id="key-lessons">🎓 Key Lessons<a class="headerlink" href="#key-lessons" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p><strong>Cache Aggressively</strong>: 90% of traffic goes to 1% of URLs. Multi-level caching is essential.</p>
</li>
<li>
<p><strong>Deduplication Saves Money</strong>: Many users shorten the same URLs. Dedup can save 30-40% storage.</p>
</li>
<li>
<p><strong>Analytics Can Overwhelm</strong>: Full analytics for billions of clicks is expensive. Smart sampling is crucial.</p>
</li>
<li>
<p><strong>Abuse Prevention is Critical</strong>: Without spam protection, service becomes unusable quickly.</p>
</li>
<li>
<p><strong>Simple Algorithms Win</strong>: Counter + base62 encoding beats complex hashing for most use cases.</p>
</li>
</ol>
<h3 id="related-concepts-deep-dives">🔗 Related Concepts &amp; Deep Dives<a class="headerlink" href="#related-concepts-deep-dives" title="Permanent link">&para;</a></h3>
<p><strong>Prerequisite Understanding:</strong>
- <a href="../../part1-axioms/axiom1-latency/">Axiom 1: Latency</a> - CDN and caching strategies
- <a href="../../part1-axioms/axiom8-economics/">Axiom 8: Economics</a> - Cost optimization techniques
- <a href="../../patterns/caching-strategies/">Caching Strategies</a> - Multi-level cache design
- <a href="../../patterns/rate-limiting/">Rate Limiting</a> - Protecting against abuse</p>
<p><strong>Advanced Topics:</strong>
- <a href="../../patterns/edge-computing/">Edge Computing Patterns</a> - Building at the edge
- <a href="../patterns/analytics-scale.md">Analytics at Scale</a> - Handling billions of events
- <a href="../patterns/geo-distribution.md">Geo-Distribution</a> - Global service deployment
- <a href="../patterns/security-shortener.md">Security Patterns</a> - Preventing abuse and attacks</p>
<p><strong>Related Case Studies:</strong>
- <a href="./cdn-design.md">CDN Design</a> - Content delivery networks
- <a href="./analytics-pipeline.md">Analytics Pipeline</a> - Real-time analytics systems
- <a href="./api-gateway.md">API Gateway</a> - Rate limiting and routing</p>
<p><strong>Implementation Patterns:</strong>
- <a href="../../patterns/sharding/">Database Sharding</a> - Horizontal scaling
- <a href="../patterns/bloom-filter.md">Bloom Filters</a> - Space-efficient lookups
- <a href="../../patterns/circuit-breaker/">Circuit Breakers</a> - Handling failures
- <a href="../../patterns/cqrs/">CQRS</a> - Read/write separation</p>
<h3 id="references">📚 References<a class="headerlink" href="#references" title="Permanent link">&para;</a></h3>
<p><strong>Industry Examples:</strong>
- <a href="https://word.bitly.com/post/287921488/bitleaf-billions-served">Bitly's Architecture</a>
- <a href="https://discord.com/blog/how-discord-stores-billions-of-messages">Discord's Shortener</a>
- <a href="https://blog.codinghorror.com/url-shortening-hashes-in-practice/">URL Shortening Strategies</a></p>
<p><strong>Open Source:</strong>
- <a href="https://yourls.org/">YOURLS</a>
- <a href="https://github.com/thedevs-network/kutt">Kutt.it</a>
- <a href="https://github.com/cydrobolt/polr">Polr</a></p>
<p><strong>Related Patterns:</strong>
- <a href="../../patterns/caching-strategies/">Caching Strategies</a>
- <a href="../../patterns/sharding/">Sharding</a>
- <a href="../../patterns/rate-limiting/">Rate Limiting</a>
- <a href="../../patterns/edge-computing/">CDN</a></p>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/deepaucksharma" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/deepaucksharma" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.tracking", "navigation.tabs", "navigation.sections", "navigation.expand", "navigation.path", "navigation.indexes", "toc.follow", "toc.integrate", "search.suggest", "search.highlight", "search.share", "content.code.copy", "content.code.annotate"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.56ea9cef.min.js"></script>
      
        <script src="https://unpkg.com/mermaid@10.6.0/dist/mermaid.min.js"></script>
      
        <script src="../../javascripts/mermaid-init.js"></script>
      
    
  </body>
</html>