name: Comprehensive Documentation Validation

on:
  workflow_dispatch:
  workflow_call:  # Allow this workflow to be called by other workflows
  schedule:
    - cron: '0 0 * * 0'  # Weekly validation

jobs:
  # Deep structural analysis for documentation health
  structural-health-check:
    name: Structural Health Check
    runs-on: ubuntu-latest
    outputs:
      total_issues: ${{ steps.analyze.outputs.total_issues }}
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run Deep Structure Analysis
      id: analyze
      run: |
        echo "🔍 Analyzing documentation structure..."
        python scripts/deep-structure-analyzer.py || true
        
        # Count total issues
        if [ -f "DEEP_STRUCTURE_ISSUES.json" ]; then
          TOTAL=$(python -c "
import json
with open('DEEP_STRUCTURE_ISSUES.json') as f:
    data = json.load(f)
    total = sum(len(v) if isinstance(v, list) else 0 for v in data.values())
    print(total)
          " || echo "0")
          echo "total_issues=$TOTAL" >> $GITHUB_OUTPUT
          echo "📊 Total structural issues: $TOTAL"
        fi
        
    - name: Upload Analysis Report
      uses: actions/upload-artifact@v4
      with:
        name: structure-analysis-report
        path: DEEP_STRUCTURE_ISSUES.json
        retention-days: 30

  # Check for missing content references
  missing-content-check:
    name: Missing Content Analysis
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyyaml
    
    - name: Analyze Unrecognized Links
      run: |
        if [ -f "scripts/analyze-unrecognized-links.py" ]; then
          echo "🔍 Analyzing missing content references..."
          python scripts/analyze-unrecognized-links.py || true
        fi
        
    - name: Upload Missing Links Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: missing-links-report
        path: UNRECOGNIZED_LINKS_REPORT.json
        retention-days: 30

  # Build metrics
  build-metrics:
    name: Build Metrics
    runs-on: ubuntu-latest
    outputs:
      warning_count: ${{ steps.build.outputs.warning_count }}
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Build and Count Warnings
      id: build
      run: |
        echo "🏗️ Building site to count warnings..."
        mkdocs build 2>&1 | tee build.log || true
        
        WARNING_COUNT=$(grep -c "WARNING" build.log || echo "0")
        echo "warning_count=$WARNING_COUNT" >> $GITHUB_OUTPUT
        echo "📊 Build warnings: $WARNING_COUNT"

  # Summary report
  health-summary:
    name: Health Summary
    needs: [structural-health-check, missing-content-check, build-metrics]
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Generate Summary
      run: |
        echo "# 📊 Documentation Health Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Date**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Metrics" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Structural Issues**: ${{ needs.structural-health-check.outputs.total_issues }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Warnings**: ${{ needs.build-metrics.outputs.warning_count }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Determine health status
        if [ "${{ needs.structural-health-check.outputs.total_issues }}" -lt "200" ]; then
          echo "✅ **Documentation structure is healthy**" >> $GITHUB_STEP_SUMMARY
        else
          echo "⚠️ **Documentation needs attention**" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*This is an automated health check. The site remains functional even with warnings.*" >> $GITHUB_STEP_SUMMARY